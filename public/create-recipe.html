<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="dark-theme.css">
</head>
<body>
    <header id="dateHeader">
        <a href="index.html">Home</a>
        <a href="nutrition.html" style="margin-left: 20px;">Nutrition Tracker</a>
    </header>

    <div class="container">
        <div class="top container">
            <h2>Create New Recipe</h2>
            
            <div class="recipe-name-group">
                <input type="text" id="recipeName" placeholder="Recipe name..." class="recipe-name-input">
                <button class="btn" id="saveRecipeBtn" onclick="saveRecipe()">Save</button>
            </div>
            
            <div class="input-group">
                <input type="text" class="food" placeholder="Ingredient name...">
                <input class="grams" type="number" inputmode="numeric" placeholder="Grams">
                <button class="btn" id="addIngredient">Add</button>
            </div>

            <div id="autocompleteList"></div>

            <div id="ingredientsList" class="scrollable-list"></div>

            <div class="results-container">
                <div id="recipeResults"></div>
            </div>
        </div>

        <!-- New Section for Saved Recipes -->
        <div class="saved-recipes-container">
            <h2>My Saved Recipes</h2>
            <div id="savedRecipesList" class="scrollable-list"></div>
        </div>
    </div>

    <style>
        .scrollable-list {
            max-height: 40vh;
            overflow-y: auto;
            margin: 15px 0;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            padding: 10px;
        }

        .ingredient-item {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            position: relative;
        }

        .ingredient-item .delete-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
        }

        .ingredient-content {
            cursor: pointer;
            padding: 5px;
            border-radius: 3px;
            transition: background-color 0.2s;
        }

        .ingredient-content:hover {
            background-color: var(--hover-color, #333);
        }

        #recipeResults {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            background-color: var(--background-color);
        }

        .recipe-totals {
            margin: 10px 0;
            padding: 10px;
            background-color: var(--input-background);
            border-radius: 5px;
        }

        .nutrition-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
            margin-top: 10px;
        }

        .nutrition-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
        }

        .nutrition-label {
            font-weight: 500;
            color: var(--text-color);
        }

        .nutrition-values {
            font-family: monospace;
            color: var(--text-secondary-color, #ccc);
            font-size: 0.95em;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .input-group input {
            flex: 1;
        }

        .recipe-name-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }

        .recipe-name-input {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            background-color: var(--input-background);
            color: var(--text-color);
            font-size: 1.1em;
        }

        #saveRecipeBtn {
            white-space: nowrap;
            padding: 7px 10px;
        }
        
        #autocompleteList div {
            padding: 8px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
        }
        
        #autocompleteList div:hover {
            background-color: var(--hover-color, #333);
        }

        /* New styles for saved recipes */
        .saved-recipes-container {
            margin-top: 30px;
            border-top: 1px solid var(--border-color);
            padding-top: 20px;
        }

        .recipe-item {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .recipe-item:hover {
            background-color: var(--hover-color, #333);
        }

        .recipe-info {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }

        .recipe-name {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 5px;
        }

        .recipe-macros {
            font-size: 0.9em;
            color: var(--text-secondary-color, #ccc);
        }

        .recipe-actions {
            display: flex;
            gap: 8px;
        }

        .edit-recipe-btn, .delete-recipe-btn {
            padding: 5px 10px;
            background-color: var(--button-color, #444);
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
        }

        .edit-recipe-btn:hover, .delete-recipe-btn:hover {
            background-color: var(--button-hover-color, #555);
        }

        .edit-recipe-btn {
            background-color: #2d5a2d;
        }

        .edit-recipe-btn:hover {
            background-color: #3d6a3d;
        }

        .delete-recipe-btn {
            background-color: #993333;
        }

        .delete-recipe-btn:hover {
            background-color: #cc4444;
        }

        .recipe-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            display: none;
        }

        .recipe-modal-content {
            background-color: var(--background-color);
            border-radius: 8px;
            width: 80%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 20px;
        }

        .close-modal {
            float: right;
            font-size: 1.5em;
            cursor: pointer;
        }

    </style>

    <script src="database-utils.js"></script>
    <script>
        const ingredients = [];
        let totalWeight = 0;
        let recipeTotals = {
            calories: 0,
            protein: 0,
            carbs: 0,
            fat: 0
        };
        

        
        let foodList = [];

        document.getElementById('addIngredient').addEventListener('click', addIngredient);
        
        // Add event listener for the Enter key on the grams input
        document.querySelector('.grams').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                addIngredient();
            }
        });

        function addIngredient() {
            const foodName = document.querySelector('.food').value;
            const grams = parseFloat(document.querySelector('.grams').value);
            
            if (!foodName || !grams) {
                alert('Please enter both ingredient name and grams');
                return;
            }

            getNutritionalInfo(foodName, grams).then(nutrition => {
                ingredients.push({
                    name: foodName,
                    grams: grams,
                    calories: nutrition.calories,
                    protein: nutrition.protein,
                    carbs: nutrition.carbs,
                    fat: nutrition.fat
                });

                updateIngredientsList();
                calculateAndDisplayTotals();
                clearInputs();
            });
        }

        function updateIngredientsList() {
            const list = document.getElementById('ingredientsList');
            list.innerHTML = ingredients.map((ingredient, index) => `
                <div class="ingredient-item">
                    <div class="ingredient-content" onclick="editIngredientAmount(${index})">
                        ${ingredient.name} (${ingredient.grams}g)
                        <span class="small-text">
                            Cals: ${ingredient.calories.toFixed(1)}, 
                            P: ${ingredient.protein.toFixed(1)}g, 
                            C: ${ingredient.carbs.toFixed(1)}g, 
                            F: ${ingredient.fat.toFixed(1)}g
                        </span>
                    </div>
                    <button class="delete-btn" onclick="removeIngredient(${index})">‚ùå</button>
                </div>
            `).join('');
        }

        function removeIngredient(index) {
            ingredients.splice(index, 1);
            updateIngredientsList();
            calculateAndDisplayTotals();
        }

        function editIngredientAmount(index) {
            const ingredient = ingredients[index];
            const newAmount = prompt(`Edit amount for ${ingredient.name} (current: ${ingredient.grams}g):`, ingredient.grams);
            
            if (newAmount !== null && !isNaN(newAmount) && parseFloat(newAmount) > 0) {
                const newGrams = parseFloat(newAmount);
                
                // Update the ingredient with new nutritional values
                getNutritionalInfo(ingredient.name, newGrams).then(nutrition => {
                    ingredients[index] = {
                        name: ingredient.name,
                        grams: newGrams,
                        calories: nutrition.calories,
                        protein: nutrition.protein,
                        carbs: nutrition.carbs,
                        fat: nutrition.fat
                    };
                    
                    updateIngredientsList();
                    calculateAndDisplayTotals();
                }).catch(error => {
                    console.error('Error updating ingredient:', error);
                    alert('Error updating ingredient. Please try again.');
                });
            }
        }

        function calculateAndDisplayTotals() {
            if (ingredients.length === 0) {
                document.getElementById('recipeResults').innerHTML = '';
                return;
            }

            recipeTotals = ingredients.reduce((totals, ingredient) => ({
                calories: totals.calories + ingredient.calories,
                protein: totals.protein + ingredient.protein,
                carbs: totals.carbs + ingredient.carbs,
                fat: totals.fat + ingredient.fat
            }), { calories: 0, protein: 0, carbs: 0, fat: 0 });

            totalWeight = ingredients.reduce((sum, ingredient) => sum + ingredient.grams, 0);

            displayRecipeResults();
        }

        function displayRecipeResults() {
            const per100g = {
                calories: (recipeTotals.calories / totalWeight * 100).toFixed(1),
                protein: (recipeTotals.protein / totalWeight * 100).toFixed(1),
                carbs: (recipeTotals.carbs / totalWeight * 100).toFixed(1),
                fat: (recipeTotals.fat / totalWeight * 100).toFixed(1)
            };

            const resultsDiv = document.getElementById('recipeResults');
            resultsDiv.innerHTML = `
                <div class="recipe-totals">
                    <h3>Recipe Totals (${totalWeight}g) | Per 100g:</h3>
                    <div class="nutrition-grid">
                        <div class="nutrition-item">
                            <span class="nutrition-label">Calories:</span>
                            <span class="nutrition-values">${recipeTotals.calories.toFixed(1)} | ${per100g.calories}</span>
                        </div>
                        <div class="nutrition-item">
                            <span class="nutrition-label">Protein:</span>
                            <span class="nutrition-values">${recipeTotals.protein.toFixed(1)}g | ${per100g.protein}g</span>
                        </div>
                        <div class="nutrition-item">
                            <span class="nutrition-label">Carbs:</span>
                            <span class="nutrition-values">${recipeTotals.carbs.toFixed(1)}g | ${per100g.carbs}g</span>
                        </div>
                        <div class="nutrition-item">
                            <span class="nutrition-label">Fat:</span>
                            <span class="nutrition-values">${recipeTotals.fat.toFixed(1)}g | ${per100g.fat}g</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function saveRecipe() {
            const recipeNameInput = document.getElementById('recipeName');
            const recipeName = recipeNameInput.value.trim();
            
            if (!recipeName) {
                recipeNameInput.focus();
                alert('Please enter a recipe name.');
                return;
            }

            // Check if we're editing an existing recipe
            if (window.currentEditingRecipeId !== null && window.currentEditingRecipeId !== undefined) {
                updateRecipe(window.currentEditingRecipeId);
                return;
            }

            // Prompt for serving information
            const servingGrams = prompt('Enter default serving size in grams:', '100');
            if (servingGrams === null) return; // User cancelled
            
            const servingDescription = prompt('Enter serving description (e.g., "1 slice", "1 cup", "100g"):', '100g');
            if (servingDescription === null) return; // User cancelled
            
            if (!servingGrams || isNaN(servingGrams) || parseFloat(servingGrams) <= 0) {
                alert('Please enter a valid serving size in grams.');
                return;
            }

            const per100g = {
                calories: parseFloat((recipeTotals.calories / totalWeight * 100).toFixed(1)),
                protein: parseFloat((recipeTotals.protein / totalWeight * 100).toFixed(1)),
                carbs: parseFloat((recipeTotals.carbs / totalWeight * 100).toFixed(1)),
                fat: parseFloat((recipeTotals.fat / totalWeight * 100).toFixed(1))
            };

            // Calculate sugars, fiber, and net carbs (set to 0 since we don't have this data)
            const sugars = 0;
            const fiber = 0;
            const netCarbs = per100g.carbs;

            // Add to IndexedDB
            const dbName = 'csvDB';
            const storeName = 'csvStore';
            const ingredientsStoreName = 'recipeIngredients';
            
            const dbRequest = indexedDB.open(dbName, 3);
            
            dbRequest.onupgradeneeded = function(event) {
                const db = event.target.result;
                if (!db.objectStoreNames.contains(ingredientsStoreName)) {
                    db.createObjectStore(ingredientsStoreName, { keyPath: 'recipeId' });
                }
            };
            
            dbRequest.onsuccess = function(event) {
                const db = event.target.result;
                
                // Check if ingredients store exists
                if (!db.objectStoreNames.contains(ingredientsStoreName)) {
                    alert('Ingredients store not found. Please refresh the page and try again.');
                    return;
                }
                
                const transaction = db.transaction([storeName, ingredientsStoreName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const ingredientsStore = transaction.objectStore(ingredientsStoreName);
                
                // Check if a recipe with the same name already exists
                const index = store.index('nameIndex');
                const getExistingRequest = index.get(recipeName);
                
                getExistingRequest.onsuccess = function() {
                    const existingRecipe = getExistingRequest.result;
                    let recipeId;
                    
                    if (existingRecipe) {
                        // Recipe with same name exists, use its ID to overwrite
                        recipeId = existingRecipe.id;
                        console.log('Overwriting existing recipe:', recipeName);
                    } else {
                        // New recipe, get the highest ID to append
                        const countRequest = store.count();
                        countRequest.onsuccess = function() {
                            recipeId = countRequest.result;
                            saveRecipeToDatabase(recipeId, false);
                        };
                        return;
                    }
                    
                    saveRecipeToDatabase(recipeId, true);
                };
                
                function saveRecipeToDatabase(recipeId, isOverwrite) {
                    // Create the recipe data
                    const recipeData = {
                        id: recipeId,
                        name: recipeName,           // name
                        foodGroup: 'Custom Recipe', // foodGroup
                        calories: per100g.calories, // calories
                        fat: per100g.fat,          // fat
                        protein: per100g.protein,  // protein
                        carbohydrate: per100g.carbs, // carbohydrate
                        sugars: sugars,            // sugars
                        fiber: fiber,              // fiber
                        netCarbs: netCarbs,        // netCarbs
                        servingWeight1: parseFloat(servingGrams),       // servingWeight1
                        servingDescription1: servingDescription, // servingDescription1
                    };

                    // Save recipe ingredients separately
                    const recipeIngredients = {
                        recipeId: recipeId,
                        ingredients: ingredients.map(ing => ({
                            name: ing.name,
                            grams: ing.grams
                        }))
                    };

                    const saveRequest = store.put(recipeData);
                    const saveIngredientsRequest = ingredientsStore.put(recipeIngredients);
                    
                    saveRequest.onsuccess = function() {
                        saveIngredientsRequest.onsuccess = function() {
                            // Add the recipe to the current foodList for immediate use (if not already there)
                            if (!foodList.includes(recipeName)) {
                                foodList.push(recipeName);
                            }
                            
                            // Show success message
                            const message = isOverwrite ? 
                                `Recipe "${recipeName}" updated successfully!` : 
                                `Recipe "${recipeName}" saved to database!`;
                            alert(message);
                            
                            // Clear the form
                            clearRecipeForm();
                            
                            // Update the saved recipes list
                            loadSavedRecipes();
                        };
                        
                        saveIngredientsRequest.onerror = function(e) {
                            console.error('Error saving recipe ingredients:', e.target.error);
                            alert('Error saving recipe ingredients. Please try again.');
                        };
                    };
                    
                    saveRequest.onerror = function(e) {
                        console.error('Error saving recipe:', e.target.error);
                        alert('Error saving recipe. Please try again.');
                    };
                };
            };
        }

        function updateRecipe(recipeId) {
            const recipeNameInput = document.getElementById('recipeName');
            const recipeName = recipeNameInput.value.trim();
            
            if (!recipeName) {
                recipeNameInput.focus();
                alert('Please enter a recipe name.');
                return;
            }
            
            if (ingredients.length === 0) {
                alert('Please add at least one ingredient.');
                return;
            }

            // Prompt for serving information
            const servingGrams = prompt('Enter default serving size in grams:', '100');
            if (servingGrams === null) return; // User cancelled
            
            const servingDescription = prompt('Enter serving description (e.g., "1 slice", "1 cup", "100g"):', '100g');
            if (servingDescription === null) return; // User cancelled
            
            if (!servingGrams || isNaN(servingGrams) || parseFloat(servingGrams) <= 0) {
                alert('Please enter a valid serving size in grams.');
                return;
            }

            // Recalculate nutritional values
            recipeTotals = ingredients.reduce((totals, ingredient) => ({
                calories: totals.calories + ingredient.calories,
                protein: totals.protein + ingredient.protein,
                carbs: totals.carbs + ingredient.carbs,
                fat: totals.fat + ingredient.fat
            }), { calories: 0, protein: 0, carbs: 0, fat: 0 });

            totalWeight = ingredients.reduce((sum, ingredient) => sum + ingredient.grams, 0);

            const per100g = {
                calories: parseFloat((recipeTotals.calories / totalWeight * 100).toFixed(1)),
                protein: parseFloat((recipeTotals.protein / totalWeight * 100).toFixed(1)),
                carbs: parseFloat((recipeTotals.carbs / totalWeight * 100).toFixed(1)),
                fat: parseFloat((recipeTotals.fat / totalWeight * 100).toFixed(1))
            };

            // Calculate sugars, fiber, and net carbs (set to 0 since we don't have this data)
            const sugars = 0;
            const fiber = 0;
            const netCarbs = per100g.carbs;

            // Update in IndexedDB
            const dbName = 'csvDB';
            const storeName = 'csvStore';
            const ingredientsStoreName = 'recipeIngredients';
            
            const dbRequest = indexedDB.open(dbName, 3);
            
            dbRequest.onsuccess = function(event) {
                const db = event.target.result;
                
                // Check if ingredients store exists
                if (!db.objectStoreNames.contains(ingredientsStoreName)) {
                    alert('Ingredients store not found. Please refresh the page and try again.');
                    return;
                }
                
                const transaction = db.transaction([storeName, ingredientsStoreName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const ingredientsStore = transaction.objectStore(ingredientsStoreName);
                
                // Update recipe nutritional data
                const getRequest = store.get(recipeId);
                getRequest.onsuccess = function() {
                    const recipe = getRequest.result;
                    if (recipe) {
                        recipe.name = recipeName;
                        recipe.calories = per100g.calories;
                        recipe.protein = per100g.protein;
                        recipe.carbohydrate = per100g.carbs;
                        recipe.fat = per100g.fat;
                        recipe.servingWeight1 = parseFloat(servingGrams);
                        recipe.servingDescription1 = servingDescription;
                        
                        const updateRequest = store.put(recipe);
                        updateRequest.onsuccess = function() {
                            // Update ingredients
                            const recipeIngredients = {
                                recipeId: recipeId,
                                ingredients: ingredients.map(ing => ({
                                    name: ing.name,
                                    grams: ing.grams
                                }))
                            };
                            
                            const updateIngredientsRequest = ingredientsStore.put(recipeIngredients);
                            updateIngredientsRequest.onsuccess = function() {
                                alert('Recipe updated successfully!');
                                
                                // Clear the form
                                clearRecipeForm();
                                
                                // Update the saved recipes list
                                loadSavedRecipes();
                            };
                            
                            updateIngredientsRequest.onerror = function(e) {
                                console.error('Error updating recipe ingredients:', e.target.error);
                                alert('Error updating recipe ingredients. Please try again.');
                            };
                        };
                        
                        updateRequest.onerror = function(e) {
                            console.error('Error updating recipe:', e.target.error);
                            alert('Error updating recipe. Please try again.');
                        };
                    }
                };
            };
        }

        function clearInputs() {
            document.querySelector('.food').value = '';
            document.querySelector('.grams').value = '';
            document.querySelector('.food').focus();
        }

        function clearRecipeForm() {
            document.getElementById('recipeName').value = '';
            ingredients.length = 0;
            updateIngredientsList();
            document.getElementById('recipeResults').innerHTML = '';
            clearInputs();
            
            
            // Clear editing state
            window.currentEditingRecipeId = null;
            
            // Reset totals
            recipeTotals = { calories: 0, protein: 0, carbs: 0, fat: 0 };
            totalWeight = 0;
        }
        
        // Function to fetch nutritional info for a given food and grams
        function getNutritionalInfo(foodName, grams) {
            // Placeholder for the nutritionalInfo object that will be populated
            var nutritionalInfo = {
                calories: 0,
                fat: 0,
                protein: 0,
                carbs: 0
            };

            // Create an array of Promises for each fetch operation
            var fetchPromises = ['calories', 'fat', 'protein', 'carbohydrate'].map(function(headerKey) {
                return new Promise(function(resolve, reject) {
                    fetchValueForKey(foodName, headerKey, function(value) {
                        // Calculate the nutritional value based on grams
                        var calculatedValue = parseFloat(((grams / 100) * value).toFixed(1));
                        // Update the nutritionalInfo object
                        switch (headerKey) {
                            case 'calories':
                                nutritionalInfo.calories = calculatedValue;
                                break;
                            case 'fat':
                                nutritionalInfo.fat = calculatedValue;
                                break;
                            case 'protein':
                                nutritionalInfo.protein = calculatedValue;
                                break;
                            case 'carbohydrate':
                                nutritionalInfo.carbs = calculatedValue;
                                break;
                            default:
                                console.error('Invalid header key:', headerKey);
                        }
                        resolve();
                    });
                });
            });

            // Return a Promise that resolves with the nutritionalInfo object once all fetch operations have completed
            return Promise.all(fetchPromises).then(function() {
                return nutritionalInfo;
            });
        }
        

        
        // Initialize food list from IndexedDB
        function initializeFoodList() {
            const dbName = 'csvDB';
            const storeName = 'csvStore';
            const ingredientsStoreName = 'recipeIngredients';
            
            const dbRequest = indexedDB.open(dbName, 3);

            dbRequest.onupgradeneeded = function(event) {
                const db = event.target.result;
                const oldVersion = event.oldVersion;
                
                // Create the main store if it doesn't exist
                if (!db.objectStoreNames.contains(storeName)) {
                    const objectStore = db.createObjectStore(storeName, { keyPath: 'id' });
                    objectStore.createIndex('nameIndex', 'name', { unique: true });
                } else if (oldVersion < 2) {
                    // Upgrade existing store to add index if needed
                    const transaction = event.target.transaction;
                    const objectStore = transaction.objectStore(storeName);
                    if (!objectStore.indexNames.contains('nameIndex')) {
                        objectStore.createIndex('nameIndex', 'name', { unique: true });
                    }
                }
                
                // Create ingredients store if it doesn't exist (version 3+)
                if (!db.objectStoreNames.contains(ingredientsStoreName)) {
                    db.createObjectStore(ingredientsStoreName, { keyPath: 'recipeId' });
                }
            };

            dbRequest.onsuccess = function(event) {
                const db = event.target.result;
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.openCursor();

                request.onsuccess = function(event) {
                    const cursor = event.target.result;
                    if (cursor) {
                        // Check if this record needs migration (has old data array format)
                        if (cursor.value.data && !cursor.value.name) {
                            // Migrate old format to new format
                            migrateRecord(db, store, cursor.value);
                        }
                        
                        // Use the new name property (or fallback to data array if still migrating)
                        const name = cursor.value.name || (cursor.value.data ? cursor.value.data[0] : 'Unknown');
                        foodList.push(name);
                        cursor.continue();
                    } else {
                        // All records have been processed
                        // Now you can use foodList for autocomplete
                        setupAutocomplete(foodList);
                    }
                };
            };
        }
        

        

        
        // New function to load saved recipes
        function loadSavedRecipes() {
            const dbName = 'csvDB';
            const storeName = 'csvStore';
            
            const dbRequest = indexedDB.open(dbName, 3);
            
            dbRequest.onsuccess = function(event) {
                const db = event.target.result;
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.openCursor();
                
                const savedRecipes = [];
                
                request.onsuccess = function(event) {
                    const cursor = event.target.result;
                    if (cursor) {
                        // Check if this record needs migration (has old data array format)
                        if (cursor.value.data && !cursor.value.name) {
                            // Migrate old format to new format
                            migrateRecord(db, store, cursor.value);
                        }
                        
                        // Check if this is a custom recipe (using new or migrated structure)
                        const foodGroup = cursor.value.foodGroup || (cursor.value.data ? cursor.value.data[1] : '');
                        if (foodGroup === 'Custom Recipe') {
                            savedRecipes.push({
                                id: cursor.value.id,
                                name: cursor.value.name || (cursor.value.data ? cursor.value.data[0] : 'Unknown'),
                                calories: cursor.value.calories || (cursor.value.data ? parseFloat(cursor.value.data[2]) : 0),
                                protein: cursor.value.protein || (cursor.value.data ? parseFloat(cursor.value.data[4]) : 0),
                                carbs: cursor.value.carbohydrate || (cursor.value.data ? parseFloat(cursor.value.data[5]) : 0),
                                fat: cursor.value.fat || (cursor.value.data ? parseFloat(cursor.value.data[3]) : 0)
                            });
                        }
                        cursor.continue();
                    } else {
                        // Display saved recipes
                        displaySavedRecipes(savedRecipes);
                    }
                };
            };
        }
        
        // Function to display saved recipes
        function displaySavedRecipes(recipes) {
            const recipesList = document.getElementById('savedRecipesList');
            
            if (recipes.length === 0) {
                recipesList.innerHTML = '<p>No saved recipes yet. Create your first recipe!</p>';
                return;
            }
            
            recipesList.innerHTML = '';
            
            recipes.forEach(recipe => {
                const recipeItem = document.createElement('div');
                recipeItem.className = 'recipe-item';
                
                recipeItem.innerHTML = `
                    <div class="recipe-info">
                        <span class="recipe-name">${recipe.name}</span>
                        <span class="recipe-macros">
                            Cal: ${recipe.calories} | P: ${recipe.protein}g | C: ${recipe.carbs}g | F: ${recipe.fat}g
                        </span>
                    </div>
                    <div class="recipe-actions">
                        <button class="edit-recipe-btn" data-recipe-id="${recipe.id}">‚úèÔ∏è Edit</button>
                        <button class="delete-recipe-btn" data-recipe-id="${recipe.id}">‚ùå Delete</button>
                    </div>
                `;
                
                recipesList.appendChild(recipeItem);
            });
            
            // Add event listeners to "Edit Recipe" buttons
            document.querySelectorAll('.edit-recipe-btn').forEach(button => {
                button.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const recipeId = parseInt(this.getAttribute('data-recipe-id'));
                    editRecipe(recipeId);
                });
            });
            
            // Add event listeners to "Delete Recipe" buttons
            document.querySelectorAll('.delete-recipe-btn').forEach(button => {
                button.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const recipeId = parseInt(this.getAttribute('data-recipe-id'));
                    deleteRecipe(recipeId);
                });
            });
            
            // Add click event to recipe items to view recipe details
            document.querySelectorAll('.recipe-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    if (!e.target.classList.contains('delete-recipe-btn') && !e.target.classList.contains('edit-recipe-btn')) {
                        const recipeId = parseInt(this.querySelector('.delete-recipe-btn').getAttribute('data-recipe-id'));
                        viewRecipeDetails(recipeId);
                    }
                });
            });
        }
        
        // Function to use a recipe (adds it as an ingredient with a default weight)
        function useRecipe(recipeId) {
            const dbName = 'csvDB';
            const storeName = 'csvStore';
            
            const dbRequest = indexedDB.open(dbName, 3);
            
            dbRequest.onsuccess = function(event) {
                const db = event.target.result;
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.get(recipeId);
                
                request.onsuccess = function(event) {
                    const recipe = request.result;
                    if (recipe) {
                        // Set as the current ingredient with default 100g
                        document.querySelector('.food').value = recipe.name;
                        document.querySelector('.grams').value = 100;
                        document.querySelector('.grams').focus();
                        document.querySelector('.grams').select();
                    }
                };
            };
        }
        
        // Function to delete a recipe
        function deleteRecipe(recipeId) {
            // Ask for confirmation
            const confirmDelete = confirm('Are you sure you want to delete this recipe?');
            if (!confirmDelete) return;
            
            const dbName = 'csvDB';
            const storeName = 'csvStore';
            const ingredientsStoreName = 'recipeIngredients';
            
            const dbRequest = indexedDB.open(dbName, 3);
            
            dbRequest.onsuccess = function(event) {
                const db = event.target.result;
                
                // Check if ingredients store exists
                if (!db.objectStoreNames.contains(ingredientsStoreName)) {
                    // If ingredients store doesn't exist, just delete the recipe
                    const transaction = db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    
                    const getRequest = store.get(recipeId);
                    getRequest.onsuccess = function() {
                        const recipe = getRequest.result;
                        if (recipe) {
                            const recipeName = recipe.name;
                            const deleteRequest = store.delete(recipeId);
                            
                            deleteRequest.onsuccess = function() {
                                const index = foodList.indexOf(recipeName);
                                if (index > -1) {
                                    foodList.splice(index, 1);
                                }
                                alert(`Recipe "${recipeName}" has been deleted.`);
                                loadSavedRecipes();
                            };
                        }
                    };
                    return;
                }
                
                const transaction = db.transaction([storeName, ingredientsStoreName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const ingredientsStore = transaction.objectStore(ingredientsStoreName);
                
                // Get the recipe to find its name
                const getRequest = store.get(recipeId);
                
                getRequest.onsuccess = function() {
                    const recipe = getRequest.result;
                    if (recipe) {
                        const recipeName = recipe.name;
                        
                        // Delete the recipe and its ingredients
                        const deleteRequest = store.delete(recipeId);
                        const deleteIngredientsRequest = ingredientsStore.delete(recipeId);
                        
                        deleteRequest.onsuccess = function() {
                            deleteIngredientsRequest.onsuccess = function() {
                                // Remove recipe name from foodList array
                                const index = foodList.indexOf(recipeName);
                                if (index > -1) {
                                    foodList.splice(index, 1);
                                }
                                
                                // Show success message
                                alert(`Recipe "${recipeName}" has been deleted.`);
                                
                                // Refresh the recipes list
                                loadSavedRecipes();
                            };
                            
                            deleteIngredientsRequest.onerror = function(e) {
                                console.error('Error deleting recipe ingredients:', e.target.error);
                                alert('Error deleting recipe ingredients. Please try again.');
                            };
                        };
                        
                        deleteRequest.onerror = function(e) {
                            console.error('Error deleting recipe:', e.target.error);
                            alert('Error deleting recipe. Please try again.');
                        };
                    }
                };
            };
        }
        
        // Function to edit a recipe
        function editRecipe(recipeId) {
            const dbName = 'csvDB';
            const storeName = 'csvStore';
            const ingredientsStoreName = 'recipeIngredients';
            
            const dbRequest = indexedDB.open(dbName, 3);
            
            dbRequest.onsuccess = function(event) {
                const db = event.target.result;
                
                // Check if ingredients store exists
                if (!db.objectStoreNames.contains(ingredientsStoreName)) {
                    alert('Ingredients store not found. Please try again.');
                    return;
                }
                
                const transaction = db.transaction([storeName, ingredientsStoreName], 'readonly');
                const store = transaction.objectStore(storeName);
                const ingredientsStore = transaction.objectStore(ingredientsStoreName);
                
                // Get the recipe and its ingredients
                const getRecipeRequest = store.get(recipeId);
                const getIngredientsRequest = ingredientsStore.get(recipeId);
                
                getRecipeRequest.onsuccess = function() {
                    const recipe = getRecipeRequest.result;
                    if (recipe) {
                        getIngredientsRequest.onsuccess = function() {
                            const recipeIngredients = getIngredientsRequest.result;
                            
                            // Clear current ingredients
                            ingredients.length = 0;
                            
                            // Load ingredients into the main ingredient list
                            if (recipeIngredients && recipeIngredients.ingredients) {
                                recipeIngredients.ingredients.forEach((ingredient) => {
                                    getNutritionalInfo(ingredient.name, ingredient.grams).then(nutrition => {
                                        ingredients.push({
                                            name: ingredient.name,
                                            grams: ingredient.grams,
                                            calories: nutrition.calories,
                                            protein: nutrition.protein,
                                            carbs: nutrition.carbs,
                                            fat: nutrition.fat
                                        });
                                        
                                        updateIngredientsList();
                                        calculateAndDisplayTotals();
                                    }).catch(error => {
                                        console.error('Error loading ingredient:', ingredient.name, error);
                                        // Add ingredient even if nutritional info fails
                                        ingredients.push({
                                            name: ingredient.name,
                                            grams: ingredient.grams,
                                            calories: 0,
                                            protein: 0,
                                            carbs: 0,
                                            fat: 0
                                        });
                                        updateIngredientsList();
                                        calculateAndDisplayTotals();
                                    });
                                });
                            }
                            
                            // Store the recipe ID for saving later
                            window.currentEditingRecipeId = recipeId;
                            
                            // Populate the recipe name input
                            const recipeNameInput = document.getElementById('recipeName');
                            recipeNameInput.value = recipe.name;
                            
                            // Store the recipe ID for saving later
                            window.currentEditingRecipeId = recipeId;
                            
                            alert(`Recipe "${recipe.name}" loaded for editing. Make your changes and click "Save Recipe" to update.`);
                        };
                    }
                };
            };
        }
        
        
        // Function to view recipe details
        function viewRecipeDetails(recipeId) {
            const dbName = 'csvDB';
            const storeName = 'csvStore';
            
            const dbRequest = indexedDB.open(dbName, 3);
            
            dbRequest.onsuccess = function(event) {
                const db = event.target.result;
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.get(recipeId);
                
                request.onsuccess = function(event) {
                    const recipe = request.result;
                    if (recipe) {
                        // Create a modal to display recipe details
                        const modal = document.createElement('div');
                        modal.className = 'recipe-modal';
                        
                        modal.innerHTML = `
                            <div class="recipe-modal-content">
                                <span class="close-modal">&times;</span>
                                <h2>${recipe.name}</h2>
                                <div class="recipe-details">
                                    <h3>Nutritional Information (per 100g)</h3>
                                    <p>Calories: ${recipe.calories}</p>
                                    <p>Protein: ${recipe.protein}g</p>
                                    <p>Carbs: ${recipe.carbohydrate}g</p>
                                    <p>Fat: ${recipe.fat}g</p>
                                </div>
                            </div>
                        `;
                        
                        document.body.appendChild(modal);
                        modal.style.display = 'flex';
                        
                        // Close modal functionality
                        modal.querySelector('.close-modal').addEventListener('click', function() {
                            modal.style.display = 'none';
                            setTimeout(() => {
                                modal.remove();
                            }, 300);
                        });
                        
                        // Close when clicking outside the modal content
                        modal.addEventListener('click', function(e) {
                            if (e.target === modal) {
                                modal.style.display = 'none';
                                setTimeout(() => {
                                    modal.remove();
                                }, 300);
                            }
                        });
                    }
                };
            };
        }

        // Initialize autocomplete and load saved recipes when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeFoodList();
            loadSavedRecipes();
        });
        
    </script>
</body>
</html> 