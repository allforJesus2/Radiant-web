<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Meal Plan - Radiant</title>
    <link rel="stylesheet" href="dark-theme.css">
</head>

<body>
    <header id="dateHeader">
        <!-- Header will be populated by JavaScript -->
    </header>

    <!-- Blur overlay for menu popup -->
    <div class="blur-overlay" id="blurOverlay"></div>

    <div class="container">
        <div class="meal-plan-container">
            <h2>üçΩÔ∏è Meal Planning</h2>
            
            <!-- Week selector -->
            <div class="week-selector">
                <button class="btn" id="prevWeek">‚Üê Previous Week</button>
                <span id="weekDisplay">Week of [Date]</span>
                <button class="btn" id="nextWeek">Next Week ‚Üí</button>
            </div>

            <!-- Create Meal Plan Button -->
            <div class="create-meal-plan-section">
                <button class="btn" onclick="window.location.href='create-meal-plan.html'">+ Create New Meal Plan</button>
            </div>

            <!-- Days of the week -->
            <div class="week-grid">
                <div class="day-column" data-day="0">
                    <h3>Sunday</h3>
                    <div class="meal-plan-selector">
                        <select class="meal-plan-dropdown">
                            <option value="">No meal plan</option>
                        </select>
                    </div>
                    <div class="day-meals" id="sunday-meals"></div>
                </div>
                
                <div class="day-column" data-day="1">
                    <h3>Monday</h3>
                    <div class="meal-plan-selector">
                        <select class="meal-plan-dropdown">
                            <option value="">No meal plan</option>
                        </select>
                    </div>
                    <div class="day-meals" id="monday-meals"></div>
                </div>
                
                <div class="day-column" data-day="2">
                    <h3>Tuesday</h3>
                    <div class="meal-plan-selector">
                        <select class="meal-plan-dropdown">
                            <option value="">No meal plan</option>
                        </select>
                    </div>
                    <div class="day-meals" id="tuesday-meals"></div>
                </div>
                
                <div class="day-column" data-day="3">
                    <h3>Wednesday</h3>
                    <div class="meal-plan-selector">
                        <select class="meal-plan-dropdown">
                            <option value="">No meal plan</option>
                        </select>
                    </div>
                    <div class="day-meals" id="wednesday-meals"></div>
                </div>
                
                <div class="day-column" data-day="4">
                    <h3>Thursday</h3>
                    <div class="meal-plan-selector">
                        <select class="meal-plan-dropdown">
                            <option value="">No meal plan</option>
                        </select>
                    </div>
                    <div class="day-meals" id="thursday-meals"></div>
                </div>
                
                <div class="day-column" data-day="5">
                    <h3>Friday</h3>
                    <div class="meal-plan-selector">
                        <select class="meal-plan-dropdown">
                            <option value="">No meal plan</option>
                        </select>
                    </div>
                    <div class="day-meals" id="friday-meals"></div>
                </div>
                
                <div class="day-column" data-day="6">
                    <h3>Saturday</h3>
                    <div class="meal-plan-selector">
                        <select class="meal-plan-dropdown">
                            <option value="">No meal plan</option>
                        </select>
                    </div>
                    <div class="day-meals" id="saturday-meals"></div>
                </div>
            </div>
        </div>
    </div>


    <style>
        .meal-plan-container {
            padding: 20px;
        }

        .week-selector {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 20px 0;
            padding: 10px;
            background: var(--background-color);
            border: 1px solid var(--border-color, #444);
            border-radius: 5px;
        }

        .week-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            margin-top: 20px;
        }

        .day-column {
            background: var(--background-color);
            border: 1px solid var(--border-color, #444);
            border-radius: 5px;
            padding: 10px;
            min-height: 400px;
        }

        .day-column h3 {
            text-align: center;
            margin: 0 0 10px 0;
            color: var(--text-color);
        }

        .meal-plan-selector {
            margin-bottom: 15px;
        }

        .meal-plan-selector select {
            width: 100%;
            margin-bottom: 5px;
            background: var(--input);
            color: var(--text);
            border: 1px solid var(--border-color, #444);
            border-radius: 3px;
            padding: 5px;
        }

        .create-meal-plan-section {
            text-align: center;
            margin: 20px 0;
        }

        .meal-categories {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .meal-category h4 {
            margin: 0 0 10px 0;
            color: var(--text-color);
            font-size: 1.1em;
        }

        .meal-category .meal-plan-items {
            min-height: 100px;
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid var(--border-color, #444);
            border-radius: 3px;
            padding: 5px;
        }

        .day-meals {
            min-height: 300px;
        }

        .meal-item {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--border-color, #444);
            border-radius: 3px;
            padding: 8px;
            margin-bottom: 5px;
            opacity: 0.7;
            position: relative;
        }

        .meal-item.completed {
            opacity: 1;
            background: var(--background-color);
        }

        .meal-item .check-btn {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            background: #28a745;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 2px 6px;
            cursor: pointer;
            font-size: 0.8em;
        }

        .meal-item .check-btn:hover {
            background: #218838;
        }


        .blur-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(5px);
            z-index: 999;
            display: none;
        }

        .blur-overlay.active {
            display: block;
        }
    </style>

    <script src="database-utils.js"></script>
    <script src="menu.js"></script>
    <script>
        // Global variables
        let currentWeekStart = new Date();
        let mealPlans = JSON.parse(localStorage.getItem('mealPlans')) || {};

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            setupHeader();
            initializeWeek();
            loadMealPlans();
            setupEventListeners();
        });


        function initializeWeek() {
            // Set current week start to the beginning of the current week (Sunday)
            const today = new Date();
            currentWeekStart = new Date(today);
            currentWeekStart.setDate(today.getDate() - today.getDay());
            currentWeekStart.setHours(0, 0, 0, 0);
            
            updateWeekDisplay();
            loadWeekMealPlans();
        }

        function updateWeekDisplay() {
            const weekEnd = new Date(currentWeekStart);
            weekEnd.setDate(currentWeekStart.getDate() + 6);
            
            const weekDisplay = document.getElementById('weekDisplay');
            weekDisplay.textContent = `Week of ${currentWeekStart.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${weekEnd.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`;
        }

        function loadWeekMealPlans() {
            for (let i = 0; i < 7; i++) {
                const dayDate = new Date(currentWeekStart);
                dayDate.setDate(currentWeekStart.getDate() + i);
                const dateKey = dayDate.toLocaleDateString('en-CA');
                
                const dayColumn = document.querySelector(`[data-day="${i}"]`);
                const dropdown = dayColumn.querySelector('.meal-plan-dropdown');
                const dayMeals = dayColumn.querySelector('.day-meals');
                
                // Clear existing options except "No meal plan"
                dropdown.innerHTML = '<option value="">No meal plan</option>';
                
                // Add existing meal plans to dropdown
                Object.keys(mealPlans).forEach(planName => {
                    const option = document.createElement('option');
                    option.value = planName;
                    option.textContent = planName;
                    dropdown.appendChild(option);
                });
                
                // Set selected meal plan for this day
                const dayMealPlan = localStorage.getItem(`mealPlan_${dateKey}`);
                if (dayMealPlan) {
                    dropdown.value = dayMealPlan;
                    displayDayMeals(dayMeals, dayMealPlan, dateKey);
                } else {
                    dayMeals.innerHTML = '';
                }
            }
        }

        function displayDayMeals(dayMealsContainer, mealPlanName, dateKey) {
            if (!mealPlanName || !mealPlans[mealPlanName]) {
                dayMealsContainer.innerHTML = '';
                return;
            }
            
            const mealPlan = mealPlans[mealPlanName];
            const completedItems = JSON.parse(localStorage.getItem(`completedMeals_${dateKey}`)) || [];
            
            dayMealsContainer.innerHTML = '';
            
            // Display meals by category
            const categories = ['breakfast', 'lunch', 'dinner'];
            const categoryEmojis = { breakfast: 'üåÖ', lunch: '‚òÄÔ∏è', dinner: 'üåô' };
            
            categories.forEach(category => {
                if (mealPlan[category] && mealPlan[category].length > 0) {
                    const categoryHeader = document.createElement('div');
                    categoryHeader.className = 'meal-category-header';
                    categoryHeader.innerHTML = `<strong>${categoryEmojis[category]} ${category.charAt(0).toUpperCase() + category.slice(1)}</strong>`;
                    categoryHeader.style.marginTop = '10px';
                    categoryHeader.style.marginBottom = '5px';
                    categoryHeader.style.color = 'var(--text-color)';
                    dayMealsContainer.appendChild(categoryHeader);
                    
                    mealPlan[category].forEach(item => {
                        const mealItem = document.createElement('div');
                        mealItem.className = 'meal-item';
                        if (completedItems.includes(item.name)) {
                            mealItem.classList.add('completed');
                        }
                        
                        mealItem.innerHTML = `
                            <div>
                                <strong>${item.name}</strong><br>
                                <span class="small-text">${item.grams}g - ${item.calories} cal, ${item.protein}g protein, ${item.carbs}g carbs, ${item.fat}g fat</span>
                            </div>
                            <button class="check-btn" onclick="toggleMealItem('${item.name}', '${dateKey}', this)">${completedItems.includes(item.name) ? '‚úì' : '‚óã'}</button>
                        `;
                        
                        dayMealsContainer.appendChild(mealItem);
                    });
                }
            });
        }

        function toggleMealItem(foodName, dateKey, button) {
            const completedItems = JSON.parse(localStorage.getItem(`completedMeals_${dateKey}`)) || [];
            const mealItem = button.parentElement;
            
            if (completedItems.includes(foodName)) {
                // Remove from completed
                const index = completedItems.indexOf(foodName);
                completedItems.splice(index, 1);
                mealItem.classList.remove('completed');
                button.textContent = '‚óã';
            } else {
                // Add to completed
                completedItems.push(foodName);
                mealItem.classList.add('completed');
                button.textContent = '‚úì';
                
                // Add to today's nutrition if it's today
                const today = new Date().toLocaleDateString('en-CA');
                if (dateKey === today) {
                    addMealItemToNutrition(foodName, dateKey);
                }
            }
            
            localStorage.setItem(`completedMeals_${dateKey}`, JSON.stringify(completedItems));
        }

        function addMealItemToNutrition(foodName, dateKey) {
            // Find the meal plan item
            const dayMealPlan = localStorage.getItem(`mealPlan_${dateKey}`);
            if (!dayMealPlan || !mealPlans[dayMealPlan]) return;
            
            const mealPlan = mealPlans[dayMealPlan];
            const mealItem = mealPlan.find(item => item.name === foodName);
            if (!mealItem) return;
            
            // Add to food log
            const foodLog = JSON.parse(localStorage.getItem('foodLog')) || {};
            if (!foodLog[dateKey]) {
                foodLog[dateKey] = [];
            }
            
            const foodItem = {
                name: mealItem.name,
                grams: mealItem.grams,
                calories: mealItem.calories,
                fat: mealItem.fat,
                protein: mealItem.protein,
                carbs: mealItem.carbs,
                timeAdded: new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })
            };
            
            foodLog[dateKey].push(foodItem);
            localStorage.setItem('foodLog', JSON.stringify(foodLog));
        }

        function setupEventListeners() {
            // Week navigation
            document.getElementById('prevWeek').addEventListener('click', function() {
                currentWeekStart.setDate(currentWeekStart.getDate() - 7);
                updateWeekDisplay();
                loadWeekMealPlans();
            });
            
            document.getElementById('nextWeek').addEventListener('click', function() {
                currentWeekStart.setDate(currentWeekStart.getDate() + 7);
                updateWeekDisplay();
                loadWeekMealPlans();
            });
            
            // Meal plan dropdown changes
            document.querySelectorAll('.meal-plan-dropdown').forEach(dropdown => {
                dropdown.addEventListener('change', function() {
                    const dayColumn = this.closest('.day-column');
                    const dayIndex = parseInt(dayColumn.dataset.day);
                    const dayDate = new Date(currentWeekStart);
                    dayDate.setDate(currentWeekStart.getDate() + dayIndex);
                    const dateKey = dayDate.toLocaleDateString('en-CA');
                    
                    const selectedPlan = this.value;
                    const dayMeals = dayColumn.querySelector('.day-meals');
                    
                    if (selectedPlan) {
                        localStorage.setItem(`mealPlan_${dateKey}`, selectedPlan);
                        displayDayMeals(dayMeals, selectedPlan, dateKey);
                    } else {
                        localStorage.removeItem(`mealPlan_${dateKey}`);
                        dayMeals.innerHTML = '';
                    }
                });
            });
            
        }


        function loadMealPlans() {
            mealPlans = JSON.parse(localStorage.getItem('mealPlans')) || {};
        }
    </script>
</body>
</html>
