<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Meal Plan - Radiant</title>
    <link rel="stylesheet" href="dark-theme.css">
</head>

<body>
    <header id="dateHeader">
        <!-- Header will be populated by JavaScript -->
    </header>

    <!-- Blur overlay for menu popup -->
    <div class="blur-overlay" id="blurOverlay"></div>

    <div class="container">
        <div class="meal-plan-container">
            <div class="header-section">
                <h2>üçΩÔ∏è Meal Planning</h2>
                <div class="header-buttons">
                    <button class="btn" onclick="window.location.href='create-meal-plan.html'">Create/Edit Daily Meal Plan</button>
                    <button class="btn" onclick="resetMealPlanProgress()" style="background-color: #dc3545; color: white;">Reset Progress</button>
                </div>
            </div>

            <!-- Days of the week -->
            <div class="week-scroll-container">
                <div class="week-grid">
                <div class="day-column" data-day="0">
                    <h3>Sunday</h3>
                    <div class="meal-plan-selector">
                        <select class="meal-plan-dropdown">
                            <option value="">No meal plan</option>
                        </select>
                    </div>
                    <div class="day-meals" id="sunday-meals"></div>
                </div>
                
                <div class="day-column" data-day="1">
                    <h3>Monday</h3>
                    <div class="meal-plan-selector">
                        <select class="meal-plan-dropdown">
                            <option value="">No meal plan</option>
                        </select>
                    </div>
                    <div class="day-meals" id="monday-meals"></div>
                </div>
                
                <div class="day-column" data-day="2">
                    <h3>Tuesday</h3>
                    <div class="meal-plan-selector">
                        <select class="meal-plan-dropdown">
                            <option value="">No meal plan</option>
                        </select>
                    </div>
                    <div class="day-meals" id="tuesday-meals"></div>
                </div>
                
                <div class="day-column" data-day="3">
                    <h3>Wednesday</h3>
                    <div class="meal-plan-selector">
                        <select class="meal-plan-dropdown">
                            <option value="">No meal plan</option>
                        </select>
                    </div>
                    <div class="day-meals" id="wednesday-meals"></div>
                </div>
                
                <div class="day-column" data-day="4">
                    <h3>Thursday</h3>
                    <div class="meal-plan-selector">
                        <select class="meal-plan-dropdown">
                            <option value="">No meal plan</option>
                        </select>
                    </div>
                    <div class="day-meals" id="thursday-meals"></div>
                </div>
                
                <div class="day-column" data-day="5">
                    <h3>Friday</h3>
                    <div class="meal-plan-selector">
                        <select class="meal-plan-dropdown">
                            <option value="">No meal plan</option>
                        </select>
                    </div>
                    <div class="day-meals" id="friday-meals"></div>
                </div>
                
                <div class="day-column" data-day="6">
                    <h3>Saturday</h3>
                    <div class="meal-plan-selector">
                        <select class="meal-plan-dropdown">
                            <option value="">No meal plan</option>
                        </select>
                    </div>
                    <div class="day-meals" id="saturday-meals"></div>
                </div>
            </div>
            </div>
        </div>
    </div>


    <style>
        .meal-plan-container {
            padding: 2s0px;
        }

        .header-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .header-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }


        .week-scroll-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        .week-grid {
            display: grid;
            grid-template-columns: repeat(7, 250px);
            gap: 10px;
            min-width: fit-content;
        }

        .day-column {
            background: var(--background-color);
            border: 1px solid var(--border-color, #444);
            border-radius: 5px;
            padding: 10px;
            min-height: 400px;
        }

        .day-column h3 {
            text-align: center;
            margin: 0 0 10px 0;
            color: var(--text-color);
        }

        .meal-plan-selector {
            margin-bottom: 15px;
        }

        .meal-plan-selector select {
            width: 100%;
            margin-bottom: 5px;
            background: var(--input);
            color: var(--text);
            border: 1px solid var(--border-color, #444);
            border-radius: 3px;
            padding: 5px;
        }


        .meal-categories {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .meal-category h4 {
            margin: 0 0 10px 0;
            color: var(--text-color);
            font-size: 1.1em;
        }

        .meal-category .meal-plan-items {
            min-height: 100px;
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid var(--border-color, #444);
            border-radius: 3px;
            padding: 5px;
        }

        .day-meals {
            min-height: 300px;
        }

        .meal-item {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--border-color, #444);
            border-radius: 3px;
            padding: 8px 50px 8px 8px;
            margin-bottom: 5px;
            opacity: 0.7;
            position: relative;
        }

        .meal-item.completed {
            opacity: 1;
            background: var(--background-color);
        }

        .meal-item .check-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: #ffc107;
            color: #000;
            border: none;
            border-radius: 3px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 0.8em;
            min-width: 24px;
            text-align: center;
        }

        .meal-item .check-btn:hover {
            background: #e0a800;
        }

        .meal-item .check-btn.completed {
            background: #28a745;
            color: white;
        }

        .meal-item .check-btn.completed:hover {
            background: #218838;
        }

        .meal-item .check-btn:disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }

        .meal-item.removed {
            opacity: 0.4;
            background: rgba(220, 53, 69, 0.1);
            border-left: 3px solid #dc3545;
        }

        .meal-item.removed .check-btn {
            background: #dc3545;
            color: white;
        }


        .blur-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(5px);
            z-index: 999;
            display: none;
        }

        .blur-overlay.active {
            display: block;
        }
    </style>

    <script src="database-utils.js"></script>
    <script src="menu.js"></script>
    <script>
        // Global variables
        let mealPlanning = JSON.parse(localStorage.getItem('meal_planning')) || {
            mealPlans: {},
            completedMeals: {},
            removedMeals: {},
            mealPlanDays: {},
            lastReset: null
        };
        
        // Ensure all required properties exist
        if (!mealPlanning.mealPlans) mealPlanning.mealPlans = {};
        if (!mealPlanning.completedMeals) mealPlanning.completedMeals = {};
        if (!mealPlanning.removedMeals) mealPlanning.removedMeals = {};
        if (!mealPlanning.mealPlanDays) mealPlanning.mealPlanDays = {};
        if (!mealPlanning.lastReset) mealPlanning.lastReset = null;

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            setupHeader();
            checkAndResetDailyProgress();
            initializeWeek();
            loadMealPlans();
            setupEventListeners();
        });


        function initializeWeek() {
            loadWeekMealPlans();
        }

        function checkAndResetDailyProgress() {
            const userTime = localStorage.getItem('userTime') || '01:00'; // Default to 1:00 AM
            const currentDate = new Date();
            const currentDateString = currentDate.toDateString();
            
            // Check if we need to reset based on userTime
            if (shouldResetBasedOnUserTime(userTime, mealPlanning.lastReset, currentDate)) {
                resetAllDailyProgress();
                mealPlanning.lastReset = currentDateString;
                saveMealPlanningData();
            }
        }

        function shouldResetBasedOnUserTime(userTime, lastResetDate, currentDate) {
            // If no previous reset, reset now
            if (!lastResetDate) {
                return true;
            }
            
            // Parse userTime (format: "HH:MM")
            const [userHour, userMinute] = userTime.split(':').map(Number);
            const userTimeInMinutes = userHour * 60 + userMinute;
            
            // Get current time
            const currentHour = currentDate.getHours();
            const currentMinute = currentDate.getMinutes();
            const currentTimeInMinutes = currentHour * 60 + currentMinute;
            
            // Get today's date string
            const todayString = currentDate.toDateString();
            
            // If it's a new day and we're past the userTime, reset
            if (lastResetDate !== todayString && currentTimeInMinutes >= userTimeInMinutes) {
                return true;
            }
            
            return false;
        }

        function resetAllDailyProgress() {
            // Clear completed and removed meals for all days of the week
            mealPlanning.completedMeals = {};
            mealPlanning.removedMeals = {};
            saveMealPlanningData();
            console.log('Daily meal plan progress has been reset for the new day.');
        }

        function saveMealPlanningData() {
            localStorage.setItem('meal_planning', JSON.stringify(mealPlanning));
        }


        function resetMealPlanProgress() {
            if (confirm('Are you sure you want to reset all meal plan progress? This will clear all completed and removed meals for the entire week.')) {
                resetAllDailyProgress();
                // Reload the week display to show reset state
                loadWeekMealPlans();
                alert('Meal plan progress has been reset successfully!');
            }
        }

        function loadWeekMealPlans() {
            for (let i = 0; i < 7; i++) {
                const dayColumn = document.querySelector(`[data-day="${i}"]`);
                const dropdown = dayColumn.querySelector('.meal-plan-dropdown');
                const dayMeals = dayColumn.querySelector('.day-meals');
                
                // Clear existing options except "No meal plan"
                dropdown.innerHTML = '<option value="">No meal plan</option>';
                
                // Add existing meal plans to dropdown
                Object.keys(mealPlanning.mealPlans).forEach(planName => {
                    const option = document.createElement('option');
                    option.value = planName;
                    option.textContent = planName;
                    dropdown.appendChild(option);
                });
                
                // Set selected meal plan for this day of week
                const dayMealPlan = mealPlanning.mealPlanDays ? mealPlanning.mealPlanDays[i] : undefined;
                if (dayMealPlan) {
                    dropdown.value = dayMealPlan;
                    displayDayMeals(dayMeals, dayMealPlan, i);
                } else {
                    dayMeals.innerHTML = '';
                }
            }
        }

        function displayDayMeals(dayMealsContainer, mealPlanName, dayOfWeek) {
            if (!mealPlanName || !mealPlanning.mealPlans[mealPlanName]) {
                dayMealsContainer.innerHTML = '';
                return;
            }
            
            const mealPlan = mealPlanning.mealPlans[mealPlanName];
            const completedItems = mealPlanning.completedMeals[dayOfWeek] || [];
            const removedItems = mealPlanning.removedMeals[dayOfWeek] || [];
            
            dayMealsContainer.innerHTML = '';
            
            // Calculate daily totals
            let dailyTotalCalories = 0;
            let dailyTotalProtein = 0;
            let dailyTotalCarbs = 0;
            let dailyTotalFat = 0;
            
            // Display meals by category
            const categories = ['breakfast', 'lunch', 'dinner', 'snack'];
            const categoryEmojis = { breakfast: 'üåÖ', lunch: '‚òÄÔ∏è', dinner: 'üåô', snack: 'üçé' };
            
            categories.forEach(category => {
                if (mealPlan[category] && mealPlan[category].length > 0) {
                    // Calculate category totals first
                    let categoryTotalCalories = 0;
                    let categoryTotalProtein = 0;
                    let categoryTotalCarbs = 0;
                    let categoryTotalFat = 0;
                    
                    mealPlan[category].forEach(item => {
                        // Only add to category totals if not removed
                        if (!removedItems.includes(item.name)) {
                            categoryTotalCalories += item.calories;
                            categoryTotalProtein += item.protein;
                            categoryTotalCarbs += item.carbs;
                            categoryTotalFat += item.fat;
                        }
                    });
                    
                    // Add category header with totals on the same line
                    const categoryHeader = document.createElement('div');
                    categoryHeader.className = 'meal-category-header';
                    categoryHeader.innerHTML = `<strong>${categoryEmojis[category]} ${category.charAt(0).toUpperCase() + category.slice(1)} -- <span style="font-size: 0.8em; color: #888;">Total: ${Math.round(categoryTotalCalories)} cal, ${Math.round(categoryTotalProtein)}g protein, ${Math.round(categoryTotalCarbs)}g carbs, ${Math.round(categoryTotalFat)}g fat</span></strong>`;
                    categoryHeader.style.marginTop = '10px';
                    categoryHeader.style.marginBottom = '5px';
                    categoryHeader.style.color = 'var(--text-color)';
                    dayMealsContainer.appendChild(categoryHeader);
                    
                    mealPlan[category].forEach(item => {
                        const mealItem = document.createElement('div');
                        mealItem.className = 'meal-item';
                        
                        // Check if item is completed or removed
                        const isCompleted = completedItems.includes(item.name);
                        const isRemoved = removedItems.includes(item.name);
                        
                        if (isCompleted) {
                            mealItem.classList.add('completed');
                        } else if (isRemoved) {
                            mealItem.classList.add('removed');
                        }
                        
                        mealItem.innerHTML = `
                            <div>
                                <strong>${item.name}</strong><br>
                                <span class="small-text">${item.grams}g - ${item.calories} cal, ${item.protein}g protein, ${item.carbs}g carbs, ${item.fat}g fat</span>
                            </div>
                            <button class="check-btn ${isCompleted ? 'completed' : ''}" ${isCompleted ? `onclick="uncheckMealItem('${item.name}', ${dayOfWeek}, this)"` : 'disabled'}>${isCompleted ? '‚úì' : (isRemoved ? '‚ùå' : '‚óã')}</button>
                        `;
                        
                        dayMealsContainer.appendChild(mealItem);
                    });
                    
                    // Add to daily totals
                    dailyTotalCalories += categoryTotalCalories;
                    dailyTotalProtein += categoryTotalProtein;
                    dailyTotalCarbs += categoryTotalCarbs;
                    dailyTotalFat += categoryTotalFat;
                }
            });
            
            // Add daily totals at the bottom
            if (dailyTotalCalories > 0) {
                const dailyTotals = document.createElement('div');
                dailyTotals.className = 'daily-totals';
                dailyTotals.innerHTML = `<strong>Daily Total: ${Math.round(dailyTotalCalories)} cal, ${Math.round(dailyTotalProtein)}g protein, ${Math.round(dailyTotalCarbs)}g carbs, ${Math.round(dailyTotalFat)}g fat</strong>`;
                dailyTotals.style.background = 'var(--button)';
                dailyTotals.style.border = '1px solid var(--border-color, #444)';
                dailyTotals.style.borderRadius = '5px';
                dailyTotals.style.padding = '10px';
                dailyTotals.style.marginTop = '15px';
                dailyTotals.style.textAlign = 'center';
                dailyTotals.style.color = 'var(--text-color)';
                dailyTotals.style.fontSize = '0.9em';
                dayMealsContainer.appendChild(dailyTotals);
            }
        }

        function uncheckMealItem(foodName, dayOfWeek, button) {
            const completedItems = mealPlanning.completedMeals[dayOfWeek] || [];
            const mealItem = button.parentElement;
            
            // Remove from completed items
            const index = completedItems.indexOf(foodName);
            if (index > -1) {
                completedItems.splice(index, 1);
                mealPlanning.completedMeals[dayOfWeek] = completedItems;
                saveMealPlanningData();
                
                // Update UI
                mealItem.classList.remove('completed');
                button.classList.remove('completed');
                button.textContent = '‚óã';
                button.disabled = true;
                button.removeAttribute('onclick');
            }
        }

        function setupEventListeners() {
            // Meal plan dropdown changes
            document.querySelectorAll('.meal-plan-dropdown').forEach(dropdown => {
                dropdown.addEventListener('change', function() {
                    const dayColumn = this.closest('.day-column');
                    const dayIndex = parseInt(dayColumn.dataset.day);
                    
                    const selectedPlan = this.value;
                    const dayMeals = dayColumn.querySelector('.day-meals');
                    
                    if (selectedPlan) {
                        mealPlanning.mealPlanDays[dayIndex] = selectedPlan;
                        saveMealPlanningData();
                        displayDayMeals(dayMeals, selectedPlan, dayIndex);
                    } else {
                        delete mealPlanning.mealPlanDays[dayIndex];
                        saveMealPlanningData();
                        dayMeals.innerHTML = '';
                    }
                });
            });
            
        }


        function loadMealPlans() {
            mealPlanning = JSON.parse(localStorage.getItem('meal_planning')) || {
                mealPlans: {},
                completedMeals: {},
                removedMeals: {},
                mealPlanDays: {},
                lastReset: null
            };
            
            // Ensure all required properties exist
            if (!mealPlanning.mealPlans) mealPlanning.mealPlans = {};
            if (!mealPlanning.completedMeals) mealPlanning.completedMeals = {};
            if (!mealPlanning.removedMeals) mealPlanning.removedMeals = {};
            if (!mealPlanning.mealPlanDays) mealPlanning.mealPlanDays = {};
            if (!mealPlanning.lastReset) mealPlanning.lastReset = null;
        }
    </script>
</body>
</html>
