<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Set Macros</title>
    <link rel="stylesheet" href="dark-theme.css">
    <link rel="stylesheet" href="navigation.css">
    <script src="navigation.js"></script>
    <style>
        .macros-container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
        }

        .macro-group {
            margin-bottom: 20px;
        }

        .macro-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-weight: bold;
        }

        input[type="range"] {
            width: 100%;
            margin: 10px 0;
        }

        .calories-display {
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background-color: var(--background, #222);
            border-radius: 4px;
            border: 1px solid var(--input, #555);
        }

        .button-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
            margin-top: 30px;
        }

        .btn {
            padding: 10px;
            border: none;
            border-radius: 4px;
            background-color: var(--button, #444);
            color: var(--text, #fff);
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .btn:hover {
            background-color: var(--button-hover, #555);
        }

        #macroPreset {
            width: 100%;
            margin-bottom: 20px;
        }

        .btn-primary {
            background-color: #007BFF;
        }


    </style>
</head>
<body>
    <div class="macros-container">
        <div class="progress-indicator">
            <!-- Progress indicator will be rendered by navigation.js -->
        </div>
        <h1>Set Your Daily Macros</h1>
        
        <div class="macro-group">
            <label for="macroPreset">Choose a preset:</label>
            <select id="macroPreset" class="btn">
                <option value="custom" selected>Custom</option>
                <option value="balanced">Balanced (40/30/30)</option>
                <option value="low-carb">Low Carb (25/40/35)</option>
                <option value="high-protein">High Protein (30/40/30)</option>
                <option value="keto">Keto (5/25/70)</option>
            </select>
        </div>

        <div class="calories-display">
            <p>Target Daily Calories: <span id="dailyCalories">2000</span> calories</p>
            <p>Current Total: <span id="totalCalories">0</span> calories</p>
        </div>

        <div class="macro-group">
            <div class="macro-label">
                <span>Protein</span>
                <span id="proteinValue">0g</span>
            </div>
            <input type="range" min="0" max="100" value="0" id="proteinSlider">
        </div>

        <div class="macro-group">
            <div class="macro-label">
                <span>Carbs</span>
                <span id="carbsValue">0g</span>
            </div>
            <input type="range" min="0" max="100" value="0" id="carbsSlider">
        </div>

        <div class="macro-group">
            <div class="macro-label">
                <span>Fat</span>
                <span id="fatValue">0g</span>
            </div>
            <input type="range" min="0" max="100" value="0" id="fatSlider">
        </div>

        <div class="button-group">
            <button class="btn" id="saveMacrosBtn">Save Macros</button>
        </div>
        
        <div class="button-group">
            <button class="btn" onclick="window.location.href='set_activity_level.html'">‚Üê Back</button>
            <button class="btn btn-primary" id="nextButton" onclick="validateAndNavigate()">NEXT: Set Reset Time</button>
        </div>
    </div>

    <script>
        // Retrieve profileStatistics from local storage
        const profileStatistics = JSON.parse(localStorage.getItem('profileStatistics'));
        let dailyCalories = 2000; // Default value in case profileStatistics is not found
        let proteinMax, carbsMax, fatMax;

        // Load saved macros from local storage
        const savedMacros = JSON.parse(localStorage.getItem('macros'));

        if (profileStatistics) {
            // Extract daily caloric expenditure
            dailyCalories = profileStatistics["dailyCaloricExpenditure"]+ profileStatistics["BMR"];

            // Update the daily calories display
            document.getElementById('dailyCalories').textContent = dailyCalories;

            // Update the sliders' maximum values based on daily calories
            proteinMax = dailyCalories;
            carbsMax = dailyCalories;
            fatMax = dailyCalories;

            document.getElementById('proteinSlider').max = proteinMax;
            document.getElementById('carbsSlider').max = carbsMax;
            document.getElementById('fatSlider').max = fatMax;
        } else {
            console.error('profileStatistics not found in local storage');
        }

        // Set slider values based on saved macros
        if (savedMacros) {
            document.getElementById('proteinSlider').value = savedMacros.protein * 4;
            document.getElementById('carbsSlider').value = savedMacros.carbs * 4;
            document.getElementById('fatSlider').value = savedMacros.fat * 9;
			
		        // Update the span text to reflect the saved macros
            document.getElementById('proteinValue').textContent = Math.round(savedMacros.protein) + "g";
            document.getElementById('carbsValue').textContent = Math.round(savedMacros.carbs) + "g";
            document.getElementById('fatValue').textContent = Math.round(savedMacros.fat) + "g";
			
		
        }

        document.getElementById('proteinSlider').addEventListener('input', () => updateMacros('protein'));
        document.getElementById('carbsSlider').addEventListener('input', () => updateMacros('carbs'));
        document.getElementById('fatSlider').addEventListener('input', () => updateMacros('fat'));
        document.getElementById('macroPreset').addEventListener('change', applyPreset);


        function applyPreset() {
            const preset = document.getElementById('macroPreset').value;
            if (preset === 'custom') return;

            let proteinRatio, carbsRatio, fatRatio;

            switch (preset) {
                case 'balanced':
                    proteinRatio = 0.30;
                    carbsRatio = 0.40;
                    fatRatio = 0.30;
                    break;
                case 'low-carb':
                    proteinRatio = 0.40;
                    carbsRatio = 0.25;
                    fatRatio = 0.35;
                    break;
                case 'high-protein':
                    proteinRatio = 0.40;
                    carbsRatio = 0.30;
                    fatRatio = 0.30;
                    break;
                case 'keto':
                    proteinRatio = 0.25;
                    carbsRatio = 0.05;
                    fatRatio = 0.70;
                    break;
            }

            const proteinCals = dailyCalories * proteinRatio;
            const carbsCals = dailyCalories * carbsRatio;
            const fatCals = dailyCalories * fatRatio;

            document.getElementById('proteinSlider').value = proteinCals;
            document.getElementById('carbsSlider').value = carbsCals;
            document.getElementById('fatSlider').value = fatCals;

            // Update display
            updateMacros();
        }

        function updateMacros(changedMacro) {
            const proteinSlider = document.getElementById('proteinSlider');
            const carbsSlider = document.getElementById('carbsSlider');
            const fatSlider = document.getElementById('fatSlider');
            const totalCaloriesSpan = document.getElementById('totalCalories');

            let proteinCals = parseFloat(proteinSlider.value);
            let carbsCals = parseFloat(carbsSlider.value);
            let fatCals = parseFloat(fatSlider.value);

            let totalCalories = proteinCals + carbsCals + fatCals;

            if (totalCalories > dailyCalories) {
                const excess = totalCalories - dailyCalories;

                if (changedMacro) {
                    document.getElementById('macroPreset').value = 'custom';
                }
                
                if (changedMacro === 'protein') {
                    const otherCals = carbsCals + fatCals;
                    if (otherCals > 0) {
                        const carbsReduction = excess * (carbsCals / otherCals);
                        const fatReduction = excess * (fatCals / otherCals);
                        carbsSlider.value = Math.max(0, carbsCals - carbsReduction);
                        fatSlider.value = Math.max(0, fatCals - fatReduction);
                    }
                } else if (changedMacro === 'carbs') {
                    const otherCals = proteinCals + fatCals;
                    if (otherCals > 0) {
                        const proteinReduction = excess * (proteinCals / otherCals);
                        const fatReduction = excess * (fatCals / otherCals);
                        proteinSlider.value = Math.max(0, proteinCals - proteinReduction);
                        fatSlider.value = Math.max(0, fatCals - fatReduction);
                    }
                } else if (changedMacro === 'fat') {
                    const otherCals = proteinCals + carbsCals;
                    if (otherCals > 0) {
                        const proteinReduction = excess * (proteinCals / otherCals);
                        const carbsReduction = excess * (carbsCals / otherCals);
                        proteinSlider.value = Math.max(0, proteinCals - proteinReduction);
                        carbsSlider.value = Math.max(0, carbsCals - carbsReduction);
                    }
                }
            }

            // Recalculate values after adjustment
            const finalProteinCals = parseFloat(proteinSlider.value);
            const finalCarbsCals = parseFloat(carbsSlider.value);
            const finalFatCals = parseFloat(fatSlider.value);

            const proteinGrams = finalProteinCals / 4;
            const carbsGrams = finalCarbsCals / 4;
            const fatGrams = finalFatCals / 9;

            document.getElementById('proteinValue').textContent = Math.round(proteinGrams) + "g";
            document.getElementById('carbsValue').textContent = Math.round(carbsGrams) + "g";
            document.getElementById('fatValue').textContent = Math.round(fatGrams) + "g";

            const finalTotalCalories = finalProteinCals + finalCarbsCals + finalFatCals;
            totalCaloriesSpan.textContent = Math.round(finalTotalCalories) + " calories";
        }





        function saveMacros() {
            const proteinSlider = document.getElementById('proteinSlider');
            const carbsSlider = document.getElementById('carbsSlider');
            const fatSlider = document.getElementById('fatSlider');

			// Round the values to the nearest whole number
			const macros = {
				protein: Math.round(proteinSlider.value / 4),
				carbs: Math.round(carbsSlider.value / 4),
				fat: Math.round(fatSlider.value / 9)
			};

            localStorage.setItem('macros', JSON.stringify(macros));
        }

        document.getElementById('saveMacrosBtn').addEventListener('click', saveMacros);
    </script>

    <script>


        function validateAndNavigate() {
            const proteinSlider = document.getElementById('proteinSlider');
            const carbsSlider = document.getElementById('carbsSlider');
            const fatSlider = document.getElementById('fatSlider');
            
            const proteinValue = proteinSlider.value / 4;
            const carbsValue = carbsSlider.value / 4;
            const fatValue = fatSlider.value / 9;
            
            const totalCalories = parseInt(proteinValue * 4) + parseInt(carbsValue * 4) + parseInt(fatValue * 9);
            
            if (totalCalories < dailyCalories * 0.8) {
                alert('Your total calories are too low. Please adjust your macros to meet at least 80% of your daily calorie target.');
                return;
            }
            
            // Save macros before navigating
            saveMacros();
            window.location.href = 'set_time.html';
        }
    </script>
</body>
</html>
