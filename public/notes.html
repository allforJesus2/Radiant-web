<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
	<style>
		:root {
			--background: #111;
			--text: #fff;
			--button: #333;
			--input: #555;
		}
		
		body, button, input {
			font-size: 24px;
			margin: 3%;
			padding: 3%;
			color: var(--text);
			background-color: var(--background);
		}
			
		.container {
			border: 1px solid #543;
			text-align: center;
			padding: 20px;
		}
		
		.btn {
			background-color: var(--button);
			color: white;
			margin: 10px;
			min-width: 200px;
		}

		.center-text {
            text-align: center;
            margin-bottom: 20px;
        }

        /* Daily Notes Styles */

        .notes-textarea {
            width: 100%;
            height: 300px;
            background-color: var(--input);
            color: var(--text);
            border: 1px solid #543;
            padding: 15px;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            box-sizing: border-box;
        }

        .notes-textarea.read-only {
            background-color: #333;
            color: #999;
            cursor: not-allowed;
        }

        .notes-btn.disabled {
            background-color: #666;
            color: #999;
            cursor: not-allowed;
        }


        .daily-summary {
            background-color: transparent;
            border: none;
            padding: 12px;
            margin-bottom: 15px;
            display: flex;
            justify-content: flex-start;
            flex-wrap: wrap;
            gap: 20px;
        }

        .summary-item {
            display: flex;
            flex-direction: row;
            align-items: center;
            text-align: left;
            min-width: 200px;
            gap: 8px;
        }

        .summary-label {
            font-weight: bold;
            color: #ccc;
            font-size: 12px;
            margin-bottom: 0;
            flex-shrink: 0;
        }

        .summary-item span:last-child {
            color: var(--text);
            font-size: 14px;
        }

        /* Tab Interface Styles */
        .tab-container {
            margin-bottom: 20px;
        }

        .tab-buttons {
            display: flex;
            border-bottom: 2px solid #543;
            margin-bottom: 20px;
        }

        .tab-btn {
            background-color: var(--button);
            color: var(--text);
            border: none;
            padding: 12px 24px;
            cursor: pointer;
            font-size: 16px;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
        }

        .tab-btn.active {
            background-color: #543;
            color: white;
        }

        .tab-btn:hover {
            background-color: #543;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .notes-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            margin-bottom: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .notes-btn {
            background-color: var(--button);
            color: white;
            border: none;
            padding: 5px 5px;
            cursor: pointer;
            font-size: 16px;
            width: 100px;
            flex-shrink: 0;
        }

        /* Mobile responsive styles */
        @media (max-width: 768px) {
            body {
                margin: 2%;
                padding: 2%;
            }
            
            .container {
                padding: 15px;
                margin: 0;
            }
            
            
            .notes-textarea {
                height: 250px;
                font-size: 14px;
            }
            
            .calendar-day {
                height: 40px;
                font-size: 10px;
                padding: 4px;
                overflow: hidden;
            }
            
            .day-number {
                font-size: 12px;
            }
            
            .day-preview {
                font-size: 8px;
            }
            
            .calendar-grid {
                gap: 1px;
            }
            
            .weekday {
                font-size: 10px;
                padding: 3px;
            }
        }

        .notes-btn:hover {
            background-color: #543;
        }

        /* Sleep form layout styles */
        .sleep-form-container {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .sleep-rating-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .sleep-time-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .sleep-rating-container label {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 0;
            cursor: pointer;
            padding: 4px;
            border-radius: 3px;
            font-size: 20px;
        }

        .sleep-rating-container label:hover {
            background-color: #333;
        }

        .sleep-rating-container input[type="radio"] {
            margin: 0;
            flex-shrink: 0;
        }

        .sleep-time-container label {
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-bottom: 0;
        }

        .sleep-time-container input {
            width: 100%;
            box-sizing: border-box;
        }

        .sleep-duration-slider {
            margin-top: 8px;
        }

        .sleep-duration-slider input[type="range"] {
            width: 100%;
            margin: 5px 0;
        }

        .sleep-duration-slider .slider-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #ccc;
            margin-top: 5px;
        }

        /* Mobile responsive for sleep form */
        @media (max-width: 768px) {
            .sleep-form-container {
                flex-direction: column;
                gap: 15px;
            }
        }

        .calendar-container {
            margin-top: 20px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .calendar-nav {
            background-color: var(--button);
            color: white;
            border: none;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 16px;
        }

        .calendar-nav:hover {
            background-color: #543;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            margin-bottom: 15px;
        }

        .calendar-day {
            background-color: var(--input);
            border: 1px solid #543;
            padding: 8px;
            height: 60px;
            font-size: 12px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .calendar-day:hover {
            background-color: #543;
        }

        .calendar-day.today {
            background-color: #543;
            font-weight: bold;
        }

        .calendar-day.has-notes {
            border-color: #fff;
        }

        .day-number {
            font-weight: bold;
            margin-bottom: 2px;
        }

        .day-preview {
            font-size: 10px;
            color: #ccc;
            overflow: hidden;
            white-space: normal;
            word-wrap: break-word;
            line-height: 1.2;
            max-height: 100%;
        }

        .calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            margin-bottom: 5px;
        }

        .weekday {
            text-align: center;
            font-weight: bold;
            padding: 5px;
            background-color: var(--button);
            color: white;
        }

        .back-btn {
            background-color: var(--button);
            color: white;
            border: none;
            padding: 10px 15px;
            cursor: pointer;
            font-size: 16px;
        }

        .back-btn:hover {
            background-color: #543;
        }

        .blur-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(5px);
            z-index: 999;
            display: none;
        }

        .blur-overlay.active {
            display: block;
        }

        .calendar-month-year {
            cursor: pointer;
            user-select: none;
        }

        .calendar-month-year:hover {
            color: #ccc;
        }

        .date-picker-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .date-picker-content {
            background-color: var(--background);
            border: 2px solid #543;
            border-radius: 10px;
            padding: 20px;
            min-width: 300px;
            text-align: center;
        }

        .date-picker-content h3 {
            margin-top: 0;
            margin-bottom: 20px;
            color: var(--text);
        }

        .date-picker-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }

        .date-picker-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .date-picker-section label {
            font-weight: bold;
            color: var(--text);
        }

        .date-picker-section select,
        .date-picker-section input {
            background-color: var(--input);
            color: var(--text);
            border: 1px solid #543;
            border-radius: 5px;
            padding: 8px;
            font-size: 16px;
            min-width: 150px;
        }

        .date-picker-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
	</style>
</head>
<body>
    <header id="dateHeader">
 
    </header>

    <!-- Blur overlay for menu popup -->
    <div class="blur-overlay" id="blurOverlay"></div>

    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: -5px; margin-top: -15px;">
            <div id="currentDateDisplay"></div>
        </div>
        
        <div class="tab-container">
            <div class="tab-buttons">
                <button class="tab-btn active" onclick="switchTab('notes')">üìù Daily Notes</button>
                <button class="tab-btn" onclick="switchTab('sleep')">üò¥ Sleep</button>
                <button class="tab-btn" onclick="switchTab('calendar')">üìÖ Calendar View</button>
            </div>
            
            <!-- Daily Notes Tab -->
            <div id="notesTab" class="tab-content active">
                
                
                <!-- Daily Summary Section -->
                <div id="dailySummary" class="daily-summary">
                    <div class="summary-item">
                        <span class="summary-label">üçΩÔ∏è Food:</span>
                        <span id="foodSummary">No data</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">üò¥ Sleep:</span>
                        <span id="sleepSummary">No data</span>
                    </div>
                </div>
                
                <textarea id="notesTextarea" class="notes-textarea" placeholder="Write your daily notes here..."></textarea>
                
                <div class="notes-actions">
                    <button class="notes-btn" onclick="previousDay()">‚Äπ‚Äπ Previous Day</button>
                    <button class="notes-btn" onclick="nextDay()">Next Day ‚Ä∫‚Ä∫</button>
                    <button class="notes-btn" onclick="returnToToday()">üìÖ Today</button>
                    <button class="notes-btn" onclick="saveNotes()">Save Notes</button>
                    <button class="notes-btn" onclick="clearNotes()">Clear</button>
                </div>
            </div>
            
            <!-- Sleep Tab -->
            <div id="sleepTab" class="tab-content">
                <form id="sleepForm">
                    <div class="sleep-form-container">
                        <div class="sleep-rating-container">
                            <h3>Sleep Quality Rating</h3>
                            <label><input type="radio" name="sleepRating" value="1"> Ugh X(</label>
                            <label><input type="radio" name="sleepRating" value="2"> eh :(</label>
                            <label><input type="radio" name="sleepRating" value="3"> meh</label>
                            <label><input type="radio" name="sleepRating" value="4"> Good-nuf</label>
                            <label><input type="radio" name="sleepRating" value="5"> between goodnuf and excellent</label>
                            <label><input type="radio" name="sleepRating" value="6"> Excellent</label>
                            <label><input type="radio" name="sleepRating" value="7"> Dreambaby</label>
                        </div>
                        
                        <div class="sleep-time-container">
                            <h3>Sleep Schedule</h3>
                            <label for="timeInBed">
                                Time to Bed
                                <input type="time" id="timeInBed" name="timeInBed" onchange="calculateSleepDuration()">
                            </label>
                            <label for="wakeUpTime">
                                Wake Up Time
                                <input type="time" id="wakeUpTime" name="wakeUpTime" onchange="calculateSleepDuration()">
                            </label>
                            <label for="sleepHours">
                                Sleep Duration (hours)
                                <input type="number" id="sleepHours" name="sleepHours" min="0" max="24" step="0.5" placeholder="8.5" onchange="updateSleepDurationFromInput()">
                                <div class="sleep-duration-slider">
                                    <input type="range" id="sleepDurationSlider" min="0" max="24" step="0.5" value="8.5" oninput="updateSleepDurationFromSlider()">
                                    <div class="slider-labels">
                                        <span>0h</span>
                                        <span id="sliderValue">8.5h</span>
                                        <span id="maxDuration">24h</span>
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>
                    <button type="button" class="notes-btn" onclick="saveSleepData()">Save Sleep Data</button>
                </form>
            </div>

            <!-- Calendar View Tab -->
            <div id="calendarTab" class="tab-content">
                <div class="calendar-container">
                    <div class="calendar-header">
                        <button class="calendar-nav" onclick="previousMonth()">‚Äπ</button>
                        <h3 id="calendarMonthYear" class="calendar-month-year" onclick="openDatePicker()"></h3>
                        <button class="calendar-nav" onclick="nextMonth()">‚Ä∫</button>
                    </div>
                    
                    <div class="calendar-weekdays">
                        <div class="weekday">Sun</div>
                        <div class="weekday">Mon</div>
                        <div class="weekday">Tue</div>
                        <div class="weekday">Wed</div>
                        <div class="weekday">Thu</div>
                        <div class="weekday">Fri</div>
                        <div class="weekday">Sat</div>
                    </div>
                    
                    <div id="calendarGrid" class="calendar-grid"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Date Picker Dialog -->
    <div id="datePickerDialog" class="date-picker-dialog" style="display: none;">
        <div class="date-picker-content">
            <h3>Select Date</h3>
            <div class="date-picker-controls">
                <div class="date-picker-section">
                    <label>Month:</label>
                    <select id="datePickerMonth">
                        <option value="0">January</option>
                        <option value="1">February</option>
                        <option value="2">March</option>
                        <option value="3">April</option>
                        <option value="4">May</option>
                        <option value="5">June</option>
                        <option value="6">July</option>
                        <option value="7">August</option>
                        <option value="8">September</option>
                        <option value="9">October</option>
                        <option value="10">November</option>
                        <option value="11">December</option>
                    </select>
                </div>
                <div class="date-picker-section">
                    <label>Year:</label>
                    <select id="datePickerYear">
                    </select>
                </div>
            </div>
            <div class="date-picker-buttons">
                <button class="notes-btn" onclick="applyDatePicker()">Apply</button>
                <button class="notes-btn" onclick="closeDatePicker()">Cancel</button>
            </div>
        </div>
    </div>

    <script src="menu.js"></script>
    <script>
        // Daily Notes functionality
        let currentSelectedDate = new Date();
        let currentCalendarDate = new Date();

        // Migration function to convert old dailyNotes_* keys to new structure
        function migrateDailyNotes() {
            const dailyNotes = {};
            const oldKeys = [];
            
            // Check for old format keys
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('dailyNotes_')) {
                    const dateKey = key.replace('dailyNotes_', '');
                    const notes = localStorage.getItem(key);
                    dailyNotes[dateKey] = notes;
                    oldKeys.push(key);
                }
            }
            
            // If we found old data, ask user for confirmation
            if (oldKeys.length > 0) {
                const confirmMessage = `Found ${oldKeys.length} old format daily notes entries.\n\n` +
                    `Would you like to migrate them to the new format?\n\n` +
                    `This will:\n` +
                    `‚Ä¢ Convert individual date entries to a single dailyNotes object\n` +
                    `‚Ä¢ Remove the old format entries\n` +
                    `‚Ä¢ Preserve all your existing notes data\n\n` +
                    `Click OK to migrate, or Cancel to keep the old format.`;
                
                if (confirm(confirmMessage)) {
                    // User confirmed migration
                    localStorage.setItem('dailyNotes', JSON.stringify(dailyNotes));
                    
                    // Remove old keys
                    oldKeys.forEach(key => {
                        localStorage.removeItem(key);
                    });
                    
                    // Show success message
                    alert(`Migration completed successfully!\n\nMigrated ${oldKeys.length} daily notes entries to the new format.`);
                    console.log(`Daily notes migrated successfully. Migrated ${oldKeys.length} entries.`);
                } else {
                    // User cancelled migration
                    console.log('Migration cancelled by user. Old format notes will remain.');
                }
            }
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            // Run migration first
            migrateDailyNotes();
            
            // Set up header using centralized menu system
            setupHeader('Daily Notes');
            loadNotesForDate(currentSelectedDate);
            updateDateDisplay();
            generateCalendar(); // Generate calendar on page load
        });

        // Tab switching functionality
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // Add active class to clicked tab button
            event.target.classList.add('active');
            
            // If switching to calendar tab, regenerate calendar
            if (tabName === 'calendar') {
                generateCalendar();
            }
        }

        function updateDateDisplay() {
            const dateDisplay = document.getElementById('currentDateDisplay');
            dateDisplay.innerHTML = `<h3>${currentSelectedDate.toDateString()}</h3>`;
            updateEditMode();
        }

        function isToday(date) {
            const today = new Date();
            return date.toDateString() === today.toDateString();
        }

        function updateEditMode() {
            const textarea = document.getElementById('notesTextarea');
            const saveBtn = document.querySelector('button[onclick="saveNotes()"]');
            const clearBtn = document.querySelector('button[onclick="clearNotes()"]');
            const saveSleepBtn = document.querySelector('button[onclick="saveSleepData()"]');
            const sleepForm = document.getElementById('sleepForm');
            
            const isEditable = isToday(currentSelectedDate);
            
            if (isEditable) {
                // Enable editing for notes
                textarea.disabled = false;
                textarea.classList.remove('read-only');
                textarea.placeholder = "Write your daily notes here...";
                saveBtn.disabled = false;
                saveBtn.classList.remove('disabled');
                clearBtn.disabled = false;
                clearBtn.classList.remove('disabled');
                // Enable editing for sleep
                saveSleepBtn.disabled = false;
                saveSleepBtn.classList.remove('disabled');
                sleepForm.querySelectorAll('input').forEach(input => input.disabled = false);

            } else {
                // Disable editing for notes
                textarea.disabled = true;
                textarea.classList.add('read-only');
                textarea.placeholder = "Read-only: You can only edit notes for today's date";
                saveBtn.disabled = true;
                saveBtn.classList.add('disabled');
                clearBtn.disabled = true;
                clearBtn.classList.add('disabled');
                // Disable editing for sleep
                saveSleepBtn.disabled = true;
                saveSleepBtn.classList.add('disabled');
                sleepForm.querySelectorAll('input').forEach(input => input.disabled = true);
            }
        }

        function getDateKey(date) {
            return date.toISOString().split('T')[0];
        }

        function loadNotesForDate(date) {
            const dateKey = getDateKey(date);
            let savedNotes = '';
            
            // First try new format
            const dailyNotesData = localStorage.getItem('dailyNotes');
            if (dailyNotesData) {
                try {
                    const dailyNotes = JSON.parse(dailyNotesData);
                    savedNotes = dailyNotes[dateKey] || '';
                } catch (e) {
                    console.error('Error parsing daily notes data:', e);
                }
            }
            
            
            document.getElementById('notesTextarea').value = savedNotes;
            updateDailySummary(date);
            loadSleepDataForDate(date);
        }

        function loadSleepDataForDate(date) {
            const dateKey = getDateKey(date);
            const sleepData = JSON.parse(localStorage.getItem('sleep')) || {};
            const todayData = sleepData[dateKey] || {};

            document.getElementById('sleepHours').value = todayData.sleepHours || '';
            document.getElementById('timeInBed').value = todayData.timeInBed || '';
            document.getElementById('wakeUpTime').value = todayData.wakeUpTime || '';

            const rating = todayData.sleepRating;
            if (rating) {
                const ratingInput = document.querySelector(`input[name="sleepRating"][value="${rating}"]`);
                if (ratingInput) {
                    ratingInput.checked = true;
                }
            } else {
                // Uncheck all radio buttons if no rating
                document.querySelectorAll('input[name="sleepRating"]').forEach(radio => radio.checked = false);
            }
            
            // Auto-calculate sleep duration when loading data
            calculateSleepDuration();
        }

        function updateDailySummary(date) {
            const dateKey = getDateKey(date);
            
            // Get food data from foodLog (lowercase)
            const foodLog = localStorage.getItem('foodLog');
            const foodSummary = document.getElementById('foodSummary');
            
            if (foodLog) {
                try {
                    const foodData = JSON.parse(foodLog);
                    const dayData = foodData[dateKey];
                    
                    if (dayData && Array.isArray(dayData)) {
                        // Calculate totals from food items array
                        let totalCalories = 0;
                        let totalProtein = 0;
                        let totalCarbs = 0;
                        let totalFat = 0;
                        
                        dayData.forEach(item => {
                            totalCalories += parseFloat(item.calories) || 0;
                            totalProtein += parseFloat(item.protein) || 0;
                            totalCarbs += parseFloat(item.carbs) || 0;
                            totalFat += parseFloat(item.fat) || 0;
                        });
                        
                        foodSummary.textContent = `${Math.round(totalCalories)} cal | ${Math.round(totalProtein)}g protein | ${Math.round(totalCarbs)}g carbs | ${Math.round(totalFat)}g fat`;
                    } else {
                        foodSummary.textContent = 'No data';
                    }
                } catch (e) {
                    foodSummary.textContent = 'Data error';
                }
            } else {
                foodSummary.textContent = 'No data';
            }
            
            // Get sleep data from sleep
            const sleepData = localStorage.getItem('sleep');
            const sleepSummary = document.getElementById('sleepSummary');
            
            if (sleepData) {
                try {
                    const sleep = JSON.parse(sleepData);
                    const dayData = sleep[dateKey];
                    
                    if (dayData) {
                        const rating = dayData.sleepRating;
                        const hours = dayData.sleepHours;
                        
                        if (rating) {
                            const ratingText = getSleepRatingText(rating);
                            sleepSummary.textContent = ratingText;
                            if (hours) {
                                sleepSummary.textContent += ` (${hours} hrs)`;
                            }
                        } else if (hours) {
                            sleepSummary.textContent = `${hours} hrs`;
                        } else {
                            sleepSummary.textContent = 'No data';
                        }
                    } else {
                        sleepSummary.textContent = 'No data';
                    }
                } catch (e) {
                    sleepSummary.textContent = 'Data error';
                }
            } else {
                sleepSummary.textContent = 'No data';
            }
        }

        function getSleepRatingText(rating) {
            const ratingMap = {
                '1': 'Ugh X(',
                '2': 'eh :(',
                '3': 'meh',
                '4': 'Good-nuf',
                '5': 'between goodnuf and excellent',
                '6': 'Excellent',
                '7': 'Dreambaby'
            };
            return `${rating}: ${ratingMap[rating] || 'Unknown'}`;
        }

        function calculateSleepDuration() {
            const timeInBed = document.getElementById('timeInBed').value;
            const wakeUpTime = document.getElementById('wakeUpTime').value;
            const sleepHoursInput = document.getElementById('sleepHours');
            const slider = document.getElementById('sleepDurationSlider');
            const sliderValue = document.getElementById('sliderValue');
            const maxDuration = document.getElementById('maxDuration');
            
            if (timeInBed && wakeUpTime) {
                // Convert time strings to Date objects for the same day
                const bedTime = new Date(`2000-01-01T${timeInBed}`);
                const wakeTime = new Date(`2000-01-01T${wakeUpTime}`);
                
                // If wake time is earlier than bed time, assume it's the next day
                if (wakeTime <= bedTime) {
                    wakeTime.setDate(wakeTime.getDate() + 1);
                }
                
                // Calculate difference in hours
                const diffMs = wakeTime - bedTime;
                const diffHours = diffMs / (1000 * 60 * 60);
                
                // Round to nearest 0.5 hour
                const roundedHours = Math.round(diffHours * 2) / 2;
                
                // Update the input and slider
                sleepHoursInput.value = roundedHours;
                slider.value = roundedHours;
                slider.max = roundedHours;
                sliderValue.textContent = roundedHours + 'h';
                maxDuration.textContent = roundedHours + 'h';
            } else {
                sleepHoursInput.value = '';
                slider.value = 0;
                slider.max = 24;
                sliderValue.textContent = '0h';
                maxDuration.textContent = '24h';
            }
        }

        function updateSleepDurationFromSlider() {
            const slider = document.getElementById('sleepDurationSlider');
            const sleepHoursInput = document.getElementById('sleepHours');
            const sliderValue = document.getElementById('sliderValue');
            
            const value = parseFloat(slider.value);
            sleepHoursInput.value = value;
            sliderValue.textContent = value + 'h';
        }

        function updateSleepDurationFromInput() {
            const sleepHoursInput = document.getElementById('sleepHours');
            const slider = document.getElementById('sleepDurationSlider');
            const sliderValue = document.getElementById('sliderValue');
            
            const value = parseFloat(sleepHoursInput.value);
            if (value <= parseFloat(slider.max)) {
                slider.value = value;
                sliderValue.textContent = value + 'h';
            } else {
                // If input exceeds max, reset to max
                sleepHoursInput.value = slider.max;
                slider.value = slider.max;
                sliderValue.textContent = slider.max + 'h';
            }
        }

        function saveSleepData() {
            if (!isToday(currentSelectedDate)) {
                alert('You can only edit sleep data for today\'s date.');
                return;
            }

            const dateKey = getDateKey(currentSelectedDate);
            const sleepData = JSON.parse(localStorage.getItem('sleep')) || {};

            if (!sleepData[dateKey]) {
                sleepData[dateKey] = {};
            }

            sleepData[dateKey].sleepHours = document.getElementById('sleepHours').value;
            sleepData[dateKey].timeInBed = document.getElementById('timeInBed').value;
            sleepData[dateKey].wakeUpTime = document.getElementById('wakeUpTime').value;
            
            const selectedRating = document.querySelector('input[name="sleepRating"]:checked');
            if (selectedRating) {
                sleepData[dateKey].sleepRating = selectedRating.value;
            }

            localStorage.setItem('sleep', JSON.stringify(sleepData));

            if (event && event.target) {
                const saveBtn = event.target;
                const originalText = saveBtn.textContent;
                saveBtn.textContent = 'Saved!';
                saveBtn.style.backgroundColor = '#543';
                setTimeout(() => {
                    saveBtn.textContent = originalText;
                    saveBtn.style.backgroundColor = '';
                }, 1000);
            }
            updateDailySummary(currentSelectedDate);
        }

        function saveNotes() {
            // Only allow saving for today's date
            if (!isToday(currentSelectedDate)) {
                alert('You can only edit notes for today\'s date.');
                return;
            }
            
            const dateKey = getDateKey(currentSelectedDate);
            const notes = document.getElementById('notesTextarea').value;
            
            // Get existing daily notes data or create new object
            let dailyNotes = {};
            const dailyNotesData = localStorage.getItem('dailyNotes');
            if (dailyNotesData) {
                try {
                    dailyNotes = JSON.parse(dailyNotesData);
                } catch (e) {
                    console.error('Error parsing daily notes data:', e);
                    dailyNotes = {};
                }
            }
            
            // Update the notes for the current date
            dailyNotes[dateKey] = notes;
            
            // Save back to localStorage
            localStorage.setItem('dailyNotes', JSON.stringify(dailyNotes)); 
            
            
            // Show save confirmation (only if called from user interaction)
            if (event && event.target) {
                const saveBtn = event.target;
                const originalText = saveBtn.textContent;
                saveBtn.textContent = 'Saved!';
                saveBtn.style.backgroundColor = '#543';
                setTimeout(() => {
                    saveBtn.textContent = originalText;
                    saveBtn.style.backgroundColor = '';
                }, 1000);
            }
        }

        function clearNotes() {
            // Only allow clearing for today's date
            if (!isToday(currentSelectedDate)) {
                alert('You can only edit notes for today\'s date.');
                return;
            }
            
            if (confirm('Are you sure you want to clear all notes for today?')) {
                document.getElementById('notesTextarea').value = '';
                saveNotes();
            }
        }


        function generateCalendar() {
            const calendarGrid = document.getElementById('calendarGrid');
            const monthYear = document.getElementById('calendarMonthYear');
            
            // Update month/year display
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'];
            monthYear.textContent = `${monthNames[currentCalendarDate.getMonth()]} ${currentCalendarDate.getFullYear()}`;
            
            // Clear previous calendar
            calendarGrid.innerHTML = '';
            
            // Get first day of month and number of days
            const firstDay = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth(), 1);
            const lastDay = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth() + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay();
            
            // Add empty cells for days before the first day of the month
            for (let i = 0; i < startingDayOfWeek; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day';
                calendarGrid.appendChild(emptyDay);
            }
            
            // Add days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                
                const dayDate = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth(), day);
                const dateKey = getDateKey(dayDate);
                
                // Get notes from new structure first, then fall back to old format
                let savedNotes = '';
                const dailyNotesData = localStorage.getItem('dailyNotes');
                if (dailyNotesData) {
                    try {
                        const dailyNotes = JSON.parse(dailyNotesData);
                        savedNotes = dailyNotes[dateKey] || '';
                    } catch (e) {
                        console.error('Error parsing daily notes data:', e);
                    }
                }
                
                
                // Check if it's today
                const today = new Date();
                if (dayDate.toDateString() === today.toDateString()) {
                    dayElement.classList.add('today');
                }
                
                // Check if it has notes
                if (savedNotes && savedNotes.trim()) {
                    dayElement.classList.add('has-notes');
                }
                
                dayElement.innerHTML = `
                    <div class="day-number">${day}</div>
                    <div class="day-preview">${savedNotes ? savedNotes.substring(0, 20) + '...' : ''}</div>
                `;
                
                dayElement.onclick = () => selectDate(dayDate);
                calendarGrid.appendChild(dayElement);
            }
        }

        function selectDate(date) {
            currentSelectedDate = new Date(date);
            loadNotesForDate(currentSelectedDate);
            updateDateDisplay();
            
            // Switch to Daily Notes tab when a date is selected
            switchToNotesTab();
        }

        function switchToNotesTab() {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show Daily Notes tab
            document.getElementById('notesTab').classList.add('active');
            document.querySelector('button[onclick="switchTab(\'notes\')"]').classList.add('active');
        }

        function previousMonth() {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
            generateCalendar();
        }

        function nextMonth() {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
            generateCalendar();
        }

        function getAvailableYears() {
            const years = new Set();
            
            // Check daily notes (new structure)
            const dailyNotesData = localStorage.getItem('dailyNotes');
            if (dailyNotesData) {
                try {
                    const dailyNotes = JSON.parse(dailyNotesData);
                    for (const dateKey in dailyNotes) {
                        const year = parseInt(dateKey.split('-')[0]);
                        if (!isNaN(year)) years.add(year);
                    }
                } catch (e) {
                    console.error('Error parsing daily notes data:', e);
                }
            }
            

            
            // Check foodLog data (lowercase)
            const foodLog = localStorage.getItem('foodLog');
            if (foodLog) {
                try {
                    const foodData = JSON.parse(foodLog);
                    // Scan through food data to find years
                    for (const dateKey in foodData) {
                        const year = parseInt(dateKey.split('-')[0]);
                        if (!isNaN(year)) years.add(year);
                    }
                } catch (e) {
                    console.log('Error parsing foodLog data');
                }
            }
            
            // Check sleep data
            const sleepData = localStorage.getItem('sleep');
            if (sleepData) {
                try {
                    const sleep = JSON.parse(sleepData);
                    // Scan through sleep data to find years
                    for (const dateKey in sleep) {
                        const year = parseInt(dateKey.split('-')[0]);
                        if (!isNaN(year)) years.add(year);
                    }
                } catch (e) {
                    console.log('Error parsing sleep data');
                }
            }
            
            // If no data found, include current year
            if (years.size === 0) {
                years.add(new Date().getFullYear());
            }
            
            return Array.from(years).sort();
        }

        function openDatePicker() {
            const dialog = document.getElementById('datePickerDialog');
            const monthSelect = document.getElementById('datePickerMonth');
            const yearSelect = document.getElementById('datePickerYear');
            
            // Get available years
            const availableYears = getAvailableYears();
            
            // Populate year dropdown
            yearSelect.innerHTML = '';
            availableYears.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            });
            
            // Set current values
            monthSelect.value = currentCalendarDate.getMonth();
            yearSelect.value = currentCalendarDate.getFullYear();
            
            // Show dialog
            dialog.style.display = 'flex';
        }

        function closeDatePicker() {
            const dialog = document.getElementById('datePickerDialog');
            dialog.style.display = 'none';
        }

        function applyDatePicker() {
            const monthSelect = document.getElementById('datePickerMonth');
            const yearSelect = document.getElementById('datePickerYear');
            
            const selectedMonth = parseInt(monthSelect.value);
            const selectedYear = parseInt(yearSelect.value);
            
            // Update calendar date
            currentCalendarDate.setFullYear(selectedYear, selectedMonth);
            generateCalendar();
            closeDatePicker();
        }

        function previousDay() {
            const previousDate = new Date(currentSelectedDate);
            previousDate.setDate(previousDate.getDate() - 1);
            currentSelectedDate = previousDate;
            loadNotesForDate(currentSelectedDate);
            updateDateDisplay();
        }

        function nextDay() {
            const nextDate = new Date(currentSelectedDate);
            nextDate.setDate(nextDate.getDate() + 1);
            currentSelectedDate = nextDate;
            loadNotesForDate(currentSelectedDate);
            updateDateDisplay();
        }

        function returnToToday() {
            currentSelectedDate = new Date();
            loadNotesForDate(currentSelectedDate);
            updateDateDisplay();
        }

        // Auto-save notes every 30 seconds (only for today's date)
        setInterval(() => {
            if (isToday(currentSelectedDate)) {
                const notes = document.getElementById('notesTextarea').value;
                if (notes.trim()) {
                    saveNotes();
                }
            }
        }, 30000);
    </script>
</body>
</html>
