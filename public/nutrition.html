<!-- follow up promtps:
how can we add a progress bar for calories
how can we allow editing the serving sizes of the food items when pressed
how can we allow deleting food items when pressed
how can we add check boxes
how can we save the database to local storage
how can we make newly added fooditems appear on top
how can we add a service worker
how can we add spacing between suggestions
-->

<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="dark-theme.css">


<body>

 <header id="dateHeader">
 
 </header>

 <!-- Blur overlay for menu popup -->
 <div class="blur-overlay" id="blurOverlay"></div>
 

 
 
 
	<div class="container">
        
        <div id="welcomeMessage" class="welcome-message" style="display: none;">
            <h2>üéâ Welcome to Radiant!</h2>
            <p>Your profile setup is complete. You can now start tracking your nutrition and fitness journey.</p>
            <button class="btn" onclick="hideWelcomeMessage()">Get Started</button>
        </div>

        <div class="top container" style="display: flex;">
		
		
<div class="nutrition-progress-container container">
            <div class="progress-bar-container">
                <span class="emoji">üî• Calories: <span class="fraction"></span></span>
                <div class="progress-bar">
                    <div class="progress-container">
                        <div class="progress" data-goal="calories"></div>
                    </div>
                </div>
            </div>
            <div class="progress-bar-container">
                <span class="emoji">ü•© Protein: <span class="fraction"></span></span>
                <div class="progress-bar">
                    <div class="progress-container">
                        <div class="progress" data-goal="protein"></div>
                    </div>
                </div>
            </div>
            <div class="progress-bar-container">
                <span class="emoji">üçû Carbs: <span class="fraction"></span></span>
                <div class="progress-bar">
                    <div class="progress-container">
                        <div class="progress" data-goal="carbs"></div>
                    </div>
                </div>
            </div>
            <div class="progress-bar-container">
                <span class="emoji">ü•• Fat: <span class="fraction"></span></span>
                <div class="progress-bar">
                    <div class="progress-container">
                        <div class="progress" data-goal="fat"></div>
                    </div>
                </div>
            </div>
        </div>




        </div>



        <div>
            <input type="text" class="food" placeholder="Food name...">
            <input class="grams" type="number" inputmode="numeric" placeholder="Grams">
            <button class="btn" id="addBtn">Add</button>
        </div>

        <div id="autocompleteList">
            <!-- This will be our autocomplete list -->
        </div>

        <div id="scrollableWindow">


            <!-- Content goes here -->
        </div>
		


		        <div class="settings-container">
			<button class="btn" id="settingsToggle">‚öôÔ∏è Settings</button>
			<div style="display: flex; gap: 10px; margin-top: 10px;">
				<button class="btn" id="refreshFoodDb" title="Refresh food database" style="flex: 1;">üîÑ Refresh Database</button>
				<select id="mealFilter" class="btn" style="flex: 1;">
					<option value="All">Show All Meals</option>
					<option value="Breakfast">Breakfast</option>
					<option value="Lunch">Lunch</option>
					<option value="Dinner">Dinner</option>
					<option value="Snack">Snack</option>
				</select>
			</div>
			<div id="databaseSize" style="margin-top: 5px; font-size: 0.9em; color: var(--text-color); opacity: 0.7;">
				Database size: <span id="dbSizeValue">Calculating...</span>
			</div>
			<div id="settingsPanel" class="settings-panel" style="display: none;">
				<button class="btn" id="fetchCSVBtn">Fetch and Store CSV Data</button>
				<button class="btn" onclick="window.location.href='set_meal_times.html'">Meal Times</button>
				<button class="btn" id="createRecipe">Create Recipe</button>
				<button class="btn" id="clearLocalStorage">Clear Local Storage</button>
				<button class="btn" onclick="window.location.href='profile.html'">Profile</button>
				<button class="btn" id="nutrientAnalysis">Nutrient Analysis</button>
				<button class="btn" onclick="window.location.href='debug.html'">Debug</button>
				<button class="btn" id="deleteDBButton">Delete 'csvDB' IndexedDB</button>
				<button class="btn" id="clearCacheButton">Clear Cache & Reload</button>
				<button class="btn" id="downloadCSV">Download Food Data</button>
				<div class="file-upload">
					<label>Select Custom Food Database File</label>        
					<input class="btn" type="file" id="csvFile" accept=".csv">
				</div>
			</div>
		</div>

		<!-- Progress Indicator Modal -->
		<div id="progressModal" class="progress-modal" style="display: none;">
			<div class="progress-content">
				<h3 id="progressTitle">Processing...</h3>
				<div class="modal-progress-container">
					<div class="modal-progress-bar">
						<div class="modal-progress-fill" id="progressFill"></div>
					</div>
				</div>
				<p id="progressText">Starting...</p>
			</div>
		</div>

    </div>



    <style>
        .settings-container {
            margin-top: 10px;
        }
        
        .settings-panel {
            background: var(--background-color);
            border: 1px solid var(--border-color, #444);
            border-radius: 5px;
            padding: 10px;
            margin-top: 5px;
        }

        .settings-panel .btn {
            display: block;
            width: 100%;
            margin: 5px 0;
        }

        .file-upload {
            margin-top: 10px;
        }

        .file-upload label {
            display: block;
            margin-bottom: 5px;
        }

        #settingsToggle {
            width: 100%;
        }

        /* Style text selection for grams input */
        .grams::selection {
            background-color: #0015ff;
            color: white;
        }


        .serving-bubble {
            position: absolute;
            background: var(--background-color);
            border: 1px solid var(--border-color, #444);
            border-radius: 5px;
            padding: 8px 12px;
            font-size: 0.9em;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 1000;
            animation: fadeIn 0.2s ease-in;
            /* Make background fully opaque and ensure text contrast */
            background-color: #000000;
            color: #ffffff;
            opacity: 1;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }



        .welcome-message {
            background: linear-gradient(135deg, #007BFF, #28a745);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .welcome-message h2 {
            margin: 0 0 10px 0;
            font-size: 1.5em;
        }

        .welcome-message p {
            margin: 0 0 15px 0;
            opacity: 0.9;
        }

        .welcome-message .btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
        }

        .welcome-message .btn:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Progress Modal Styles */
        .progress-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .progress-content {
            background: var(--background-color);
            border: 1px solid var(--border-color, #444);
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        .progress-content h3 {
            margin: 0 0 20px 0;
            color: var(--text-color);
        }

        .progress-content p {
            margin: 15px 0 0 0;
            color: var(--text-color);
            opacity: 0.8;
        }

        .modal-progress-container {
            width: 100%;
            height: 20px;
            background-color: var(--border-color, #444);
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }

        .modal-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #007BFF, #28a745);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 10px;
        }

        #addBtn {
            min-width: 70px;
        }

        .blur-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(5px);
            z-index: 999;
            display: none;
        }

        .blur-overlay.active {
            display: block;
        }

        .meal-toggle-btn:hover {
            background: var(--button-hover, #555) !important;
        }

        .meal-toggle-btn {
            transition: transform 0.2s ease, background-color 0.2s ease;
        }
    </style>

    <script src="database-utils.js"></script>
    <script src="menu.js"></script>
    <script>
	
	// Define the 'today' variable globally
	var today;

	// Progress indicator functions
	function showProgress(title, text) {
		document.getElementById('progressTitle').textContent = title;
		document.getElementById('progressText').textContent = text;
		document.getElementById('progressModal').style.display = 'flex';
	}

	function updateProgress(percentage, text) {
		document.getElementById('progressFill').style.width = percentage + '%';
		if (text) {
			document.getElementById('progressText').textContent = text;
		}
	}

	function hideProgress() {
		document.getElementById('progressModal').style.display = 'none';
		document.getElementById('progressFill').style.width = '0%';
	}

	// Function to check if user just completed profile creation flow
	function checkProfileCompletion() {
		const profileData = localStorage.getItem('profileStatistics');
		const userTime = localStorage.getItem('userTime');
		const macros = localStorage.getItem('macros');
		
		if (profileData && userTime && macros) {
			// Check if this is the first time visiting nutrition page after completion
			const hasSeenWelcome = localStorage.getItem('hasSeenWelcome');
			if (!hasSeenWelcome) {
				document.getElementById('welcomeMessage').style.display = 'block';
				localStorage.setItem('hasSeenWelcome', 'true');
			}
		}
	}

	// Function to hide welcome message
	function hideWelcomeMessage() {
		document.getElementById('welcomeMessage').style.display = 'none';
	}

	// Function to reset profile and start over
	function resetProfile() {
		if (confirm('Are you sure you want to start over? This will clear all your profile data.')) {
			localStorage.removeItem('profileStatistics');
			localStorage.removeItem('userTime');
			localStorage.removeItem('macros');
			localStorage.removeItem('activityLevels');
			localStorage.removeItem('hasSeenWelcome');
			alert('Profile reset. You will be redirected to the profile setup.');
			window.location.href = 'profile.html';
		}
	}
	
	var scrollableWindow = document.getElementById('scrollableWindow');
	var buttonHeight = document.getElementsByClassName('btn')[0].clientHeight * 4; // Height of two buttons
	var viewportHeight = Math.max(document.documentElement.clientHeight, window.innerHeight || 0);
	
	scrollableWindow.style.height = (viewportHeight - buttonHeight - 48) + 'px';
	
	var foodInput = document.querySelector('.food');
	var autocompleteList = document.getElementById('autocompleteList');
	var foodList = []//['Apple', 'Banana', 'Bagel', 'Boiled egg', 'Cherry']; // Your predefined list of foods



	document.getElementById('fetchCSVBtn').addEventListener('click', function() {
		showProgress('Fetching Food Database', 'Downloading CSV file...');
		updateProgress(10, 'Starting download...');
		
		fetch('assets/FoodData.csv')
			.then(response => {
				updateProgress(30, 'File downloaded, processing data...');
				return response.text();
			})
			.then(csvData => {
				updateProgress(50, 'Storing data in database...');
				// Process and store the CSV data
				parseAndStoreCSV(csvData);
			})
			.catch(error => {
				console.error('Error fetching CSV:', error);
				hideProgress();
				alert('Error downloading food database. Please try again.');
			});
	});






document.addEventListener('DOMContentLoaded', function() {
    // Check if user just completed profile creation flow
    checkProfileCompletion();
    
    // Check and reset daily meal plan progress
    checkAndResetDailyProgress();
    
    // Run migration if needed
    migrateOldMealPlanData();
    
    const deleteDBButton = document.getElementById('deleteDBButton');
    const clearCacheButton = document.getElementById('clearCacheButton');

    deleteDBButton.addEventListener('click', function() {
        const dbName = 'csvDB';
        const request = indexedDB.deleteDatabase(dbName);

        request.onsuccess = function() {
            alert('Database deleted successfully');
        };

        request.onerror = function(event) {
            console.error('Error deleting database:', event.target.error);
        };

        request.onblocked = function() {
            alert('Database is blocked. Please close all connections to the database.');
        };
    });

    clearCacheButton.addEventListener('click', function() {
        if (confirm('This will clear browser cache and reload the page. Your profile and food data will NOT be affected. Continue?')) {
            // Clear all caches
            if ('caches' in window) {
                caches.keys().then(function(cacheNames) {
                    return Promise.all(
                        cacheNames.map(function(cacheName) {
                            console.log('Deleting cache:', cacheName);
                            return caches.delete(cacheName);
                        })
                    );
                }).then(function() {
                    console.log('All caches cleared');
                    // Reload the page
                    window.location.reload(true);
                });
            } else {
                // Fallback if caches API is not available
                window.location.reload(true);
            }
        }
    });
});


	// Add event listener to the input field
	foodInput.addEventListener('input', function() {
	  var userInput = this.value;
	  
	  if (userInput) {
		// Filter foodList based on user's input and update autocomplete list
		var filteredFoods = foodList.filter(function(food) {
		  return food.toLowerCase().startsWith(userInput.toLowerCase());
		});
		
		// Clear any existing items in the autocomplete list
		while (autocompleteList.firstChild) {
		  autocompleteList.removeChild(autocompleteList.firstChild);
		}
		
		// Add new items to the autocomplete list for each matching food
		filteredFoods.forEach(function(food) {
		  var listItem = document.createElement('div');
		  listItem.textContent = food;
		  listItem.addEventListener('click', function() {
			foodInput.value = this.textContent; // Set the input field's value to the clicked item's text
			autocompleteList.innerHTML = ''; // Clear the autocomplete list
		  });
		  
		  autocompleteList.appendChild(listItem);
		});
	  } else {
		// If user has cleared input, clear the autocomplete list
		autocompleteList.innerHTML = '';
	  }
	});
		



    // Function to handle file upload
    function handleFileUpload(evt) {
        const file = evt.target.files[0];
        if (!file) return;
        
        showProgress('Uploading Custom Database', 'Reading file...');
        updateProgress(10, 'File selected, processing...');
        
        const reader = new FileReader();
        reader.onload = function(e) {
            updateProgress(40, 'File read, storing data...');
            const csvData = e.target.result;
            parseAndStoreCSV(csvData);
        };
        reader.onerror = function() {
            hideProgress();
            alert('Error reading file. Please try again.');
        };
        reader.readAsText(file);
    }
	
	
	
// Function to parse and store CSV data in IndexedDB
function parseAndStoreCSV(csvData) {
    console.log('parseAndStoreCSV called'); // Log to confirm function call
    const lines = csvData.split('\n');
    const dbName = 'csvDB';
    const storeName = 'csvStore';
    const totalLines = lines.length;

    updateProgress(60, 'Opening database...');

    // Open the database - let IndexedDB handle versioning automatically
    const dbRequest = indexedDB.open(dbName);
    console.log('Database request made'); // Log to confirm database request

    dbRequest.onupgradeneeded = function(event) {
        console.log('onupgradeneeded triggered'); // Log to confirm upgrade needed
        const db = event.target.result;
        const oldVersion = event.oldVersion;
        const newVersion = event.newVersion;
        console.log('Database object:', db); // Log the database object

        try {
            // Create stores only if they don't exist
            if (!db.objectStoreNames.contains('csvStore')) {
                const objectStore = db.createObjectStore('csvStore', { keyPath: 'id' });
                objectStore.createIndex('nameIndex', 'name', { unique: true });
                console.log('Created csvStore with nameIndex');
            }
            
            if (!db.objectStoreNames.contains('recipeIngredients')) {
                db.createObjectStore('recipeIngredients', { keyPath: 'recipeId' });
                console.log('Created recipeIngredients store');
            }
        } catch (error) {
            console.error('Error in onupgradeneeded:', error);
        }
    };

    dbRequest.onsuccess = function(event) {
        console.log('Database request successful'); // Log to confirm success
        const db = event.target.result;
        console.log('Database object:', db); // Log the database object

        updateProgress(70, 'Starting data storage...');

        const transaction = db.transaction([storeName], 'readwrite');
        console.log('Transaction started'); // Log to confirm transaction start

        const store = transaction.objectStore(storeName);
        console.log('Object store accessed'); // Log to confirm object store access

        let processedLines = 0;
        lines.forEach(function(line, index) {
            const columns = line.split(',');
            console.log('Storing line:', index, columns); // Log each line being stored
            
            // Store data with separate properties for better indexing
            const foodItem = {
                id: index,
                name: columns[0], // Food name
                foodGroup: columns[1],
                calories: parseFloat(columns[2]) || 0,
                fat: parseFloat(columns[3]) || 0,
                protein: parseFloat(columns[4]) || 0,
                carbohydrate: parseFloat(columns[5]) || 0,
                sugars: parseFloat(columns[6]) || 0,
                fiber: parseFloat(columns[7]) || 0,
                netCarbs: parseFloat(columns[8]) || 0,
                servingWeight1: parseFloat(columns[9]) || 0,
                servingDescription1: columns[10] || '',

            };
            
            store.put(foodItem);
            
            processedLines++;
            // Update progress every 100 lines or at the end
            if (processedLines % 100 === 0 || processedLines === totalLines) {
                const progress = 70 + (processedLines / totalLines) * 25; // 70% to 95%
                updateProgress(Math.round(progress), `Storing data... ${processedLines}/${totalLines} lines`);
            }
        });

        transaction.oncomplete = function() {
            console.log('Transaction complete'); // Log to confirm transaction completion
            db.close();
            console.log('Database closed'); // Log to confirm database closure
            updateProgress(100, 'Database setup complete!');
            
            setTimeout(() => {
                hideProgress();
                alert('CSV data stored in IndexedDB');
                initializeFoodList(); // Assuming this function is defined elsewhere
                updateDatabaseSize(); // Update the database size display
            }, 500);
        };

        // Add an onerror event listener to the transaction
        transaction.onerror = function(event) {
            console.error('Transaction failed:', event.target.error); // Log the error
            hideProgress();
            alert('An error occurred while storing the CSV data in IndexedDB.');
        };
    };

    dbRequest.onerror = function(event) {
        console.error('Database request failed:', event.target.error); // Log the error
        console.error('Error details:', {
            name: event.target.error.name,
            message: event.target.error.message,
            code: event.target.error.code
        });
        hideProgress();
        alert(`Database error: ${event.target.error.message}. Please try refreshing the page or clearing your browser data.`);
    };
}
   document.getElementById('csvFile').addEventListener('change', handleFileUpload);








function initializeFoodList() {
    const dbName = 'csvDB';
    const storeName = 'csvStore';
    const foodList = [];
	//db.createObjectStore(storeName, { keyPath: 'id' }); // Adjust the key path as needed

    const dbRequest = indexedDB.open(dbName);

    dbRequest.onupgradeneeded = function(event) {
        const db = event.target.result;
        const oldVersion = event.oldVersion;
        const newVersion = event.newVersion;
        
        try {
            // Create stores only if they don't exist
            if (!db.objectStoreNames.contains('csvStore')) {
                const objectStore = db.createObjectStore('csvStore', { keyPath: 'id' });
                objectStore.createIndex('nameIndex', 'name', { unique: true });
                console.log('Created csvStore with nameIndex');
            }
            
            if (!db.objectStoreNames.contains('recipeIngredients')) {
                db.createObjectStore('recipeIngredients', { keyPath: 'recipeId' });
                console.log('Created recipeIngredients store');
            }
        } catch (error) {
            console.error('Error in onupgradeneeded:', error);
        }
    };

    dbRequest.onsuccess = function(event) {
        const db = event.target.result;
        const transaction = db.transaction([storeName], 'readonly');
        const store = transaction.objectStore(storeName);
        const request = store.openCursor();

        request.onsuccess = function(event) {
            const cursor = event.target.result;
            if (cursor) {
                // Use the new name property
                const name = cursor.value.name || 'Unknown';
                foodList.push(name);
                cursor.continue();
            } else {
                // All records have been processed
                // Now you can use foodList for autocomplete
                setupAutocomplete(foodList);
            }
        };
        
        request.onerror = function(event) {
            console.error('Error reading food list:', event.target.error);
        };
    };
    
    dbRequest.onerror = function(event) {
        console.error('Error opening database for food list:', event.target.error);
        console.error('Error details:', {
            name: event.target.error.name,
            message: event.target.error.message,
            code: event.target.error.code
        });
    };
}

function showServingBubble(description, targetElement) {
    // Create and show the bubble
    const bubble = document.createElement('div');
    bubble.className = 'serving-bubble';
    bubble.textContent = description;
    targetElement.parentNode.appendChild(bubble);
    
    // Position the bubble below the target element
    const rect = targetElement.getBoundingClientRect();
    bubble.style.top = (rect.bottom + 5) + 'px';
    bubble.style.left = rect.left + 'px';
    
    // Remove the bubble after 3 seconds
    setTimeout(() => {
        bubble.remove();
    }, 3000);
}










document.querySelector('.food').addEventListener('focus', function() {
    this.value = ''; // Clear the input field
});

document.querySelector('.grams').addEventListener('focus', function() {
    this.value = ''; // Clear the input field
});

// Add an event listener for the Enter key on the grams input
document.querySelector('.grams').addEventListener('keypress', function(event) {
    if (event.key === 'Enter') {
        document.getElementById('addBtn').click(); // Trigger the click event of the Add button
    }
});

// Select the "Clear Local Storage" button by its ID
var clearLocalStorageButton = document.getElementById('clearLocalStorage');

// Add an event listener to the button
clearLocalStorageButton.addEventListener('click', function() {
    // Ask the user for confirmation
    var confirmation = confirm('Are you sure you want to clear Local Storage?');

    // If the user confirms, clear the local storage
    if (confirmation) {
        localStorage.clear();

        // Optionally, provide feedback to the user
        alert('Local Storage has been cleared.');

        // Optionally, clear the displayed list in the scrollableWindow
        document.getElementById('scrollableWindow').innerHTML = '';
    } else {
        // Optionally, provide feedback to the user that the action was cancelled
        alert('Action cancelled. Local Storage was not cleared.');
    }
});


// Function to handle the "Download Food Data" button click
function downloadFoodData() {
	// Fetch the CSV file
	fetch('assets/FoodData.csv')
		.then(response => response.blob()) // Convert the response to a Blob
		.then(blob => {
			// Create a URL for the Blob
			const url = URL.createObjectURL(blob);
			// Create a download link
			const link = document.createElement('a');
			link.href = url;
			link.download = 'FoodData.csv'; // Set the desired filename
			// Append the link to the body (optional)
			document.body.appendChild(link);
			// Trigger the download
			link.click();
			// Remove the link from the body
			document.body.removeChild(link);
		})
		.catch(error => console.error('Error downloading the file:', error));
}

// Add an event listener to the "Download Food Data" button
document.getElementById('downloadCSV').addEventListener('click', downloadFoodData);

function calculateTotals() {
	var foodLog = JSON.parse(localStorage.getItem('foodLog')) || {};
    //var foodItems = JSON.parse(localStorage.getItem(today)) || [];
	var foodItems = foodLog[today] || [];
    var totalProtein = 0;
    var totalCarbs = 0;
    var totalFat = 0;
    var totalCalories = 0; // Initialize total calories

    foodItems.forEach(function(item) {
        totalProtein += item.protein;
        totalCarbs += item.carbs;
        totalFat += item.fat;
        totalCalories += item.calories; // Add calories to the total
    });

    return {
        protein: Math.round(totalProtein),
        carbs: Math.round(totalCarbs),
        fat: Math.round(totalFat),
        calories: Math.round(totalCalories) // Include total calories in the return object
    };
}

// Function to determine meal type based on time
function getMealType(timeStr) {
    // timeStr is in "HH:MM" format
    const [hour, minute] = timeStr.split(':').map(Number);
    const totalMinutes = hour * 60 + minute;
    
    // Load user-configured meal times or use defaults
    const mealTimes = JSON.parse(localStorage.getItem('mealTimes')) || {
        breakfast: { start: '06:00', end: '10:00' },
        lunch: { start: '11:00', end: '14:00' },
        dinner: { start: '17:00', end: '21:00' }
    };

    // Convert meal times to minutes for comparison
    function timeToMinutes(timeStr) {
        const [h, m] = timeStr.split(':').map(Number);
        return h * 60 + m;
    }

    const breakfastStart = timeToMinutes(mealTimes.breakfast.start);
    const breakfastEnd = timeToMinutes(mealTimes.breakfast.end);
    const lunchStart = timeToMinutes(mealTimes.lunch.start);
    const lunchEnd = timeToMinutes(mealTimes.lunch.end);
    const dinnerStart = timeToMinutes(mealTimes.dinner.start);
    const dinnerEnd = timeToMinutes(mealTimes.dinner.end);

    // Check if time falls within breakfast range
    if (breakfastStart <= breakfastEnd) {
        // Normal case: start < end (e.g., 06:00-10:00)
        if (totalMinutes >= breakfastStart && totalMinutes < breakfastEnd) {
            return 'Breakfast';
        }
    } else {
        // Wraps around midnight (e.g., 22:00-06:00)
        if (totalMinutes >= breakfastStart || totalMinutes < breakfastEnd) {
            return 'Breakfast';
        }
    }

    // Check if time falls within lunch range
    if (lunchStart <= lunchEnd) {
        if (totalMinutes >= lunchStart && totalMinutes < lunchEnd) {
            return 'Lunch';
        }
    } else {
        if (totalMinutes >= lunchStart || totalMinutes < lunchEnd) {
            return 'Lunch';
        }
    }

    // Check if time falls within dinner range
    if (dinnerStart <= dinnerEnd) {
        if (totalMinutes >= dinnerStart && totalMinutes < dinnerEnd) {
            return 'Dinner';
        }
    } else {
        if (totalMinutes >= dinnerStart || totalMinutes < dinnerEnd) {
            return 'Dinner';
        }
    }

    // If time doesn't fall within any configured range, categorize as snack
    return 'Snack';
}

// Function to calculate totals for a specific meal
function calculateMealTotals(foodItems, mealType) {
    if (mealType === 'All') {
        return calculateTotals();
    }
    
    const mealItems = foodItems.filter(item => getMealType(item.timeAdded) === mealType);
    var totalProtein = 0;
    var totalCarbs = 0;
    var totalFat = 0;
    var totalCalories = 0;

    mealItems.forEach(function(item) {
        totalProtein += item.protein;
        totalCarbs += item.carbs;
        totalFat += item.fat;
        totalCalories += item.calories;
    });

    return {
        protein: Math.round(totalProtein),
        carbs: Math.round(totalCarbs),
        fat: Math.round(totalFat),
        calories: Math.round(totalCalories)
    };
}

// Function to get meal time range as a formatted string
function getMealTimeRange(mealType) {
    const mealTimes = JSON.parse(localStorage.getItem('mealTimes')) || {
        breakfast: { start: '06:00', end: '10:00' },
        lunch: { start: '11:00', end: '14:00' },
        dinner: { start: '17:00', end: '21:00' }
    };

    function formatTimeForDisplay(timeStr) {
        const [hour, minute] = timeStr.split(':').map(Number);
        const date = new Date();
        date.setHours(hour, minute, 0);
        return date.toLocaleTimeString('en-US', { 
            hour: 'numeric', 
            minute: '2-digit', 
            hour12: true 
        });
    }

    switch(mealType) {
        case 'Breakfast':
            return `${formatTimeForDisplay(mealTimes.breakfast.start)} - ${formatTimeForDisplay(mealTimes.breakfast.end)}`;
        case 'Lunch':
            return `${formatTimeForDisplay(mealTimes.lunch.start)} - ${formatTimeForDisplay(mealTimes.lunch.end)}`;
        case 'Dinner':
            return `${formatTimeForDisplay(mealTimes.dinner.start)} - ${formatTimeForDisplay(mealTimes.dinner.end)}`;
        case 'Snack':
            return 'Throughout the day';
        default:
            return '';
    }
}

// Function to calculate totals for a specific meal type
function calculateMealTypeTotals(foodItems, mealType) {
    const mealItems = foodItems.filter(item => getMealType(item.timeAdded) === mealType);
    var totalProtein = 0;
    var totalCarbs = 0;
    var totalFat = 0;
    var totalCalories = 0;

    mealItems.forEach(function(item) {
        totalProtein += item.protein;
        totalCarbs += item.carbs;
        totalFat += item.fat;
        totalCalories += item.calories;
    });

    return {
        protein: Math.round(totalProtein),
        carbs: Math.round(totalCarbs),
        fat: Math.round(totalFat),
        calories: Math.round(totalCalories)
    };
}

// Function to get the current meal type based on current time
function getCurrentMealType() {
    const currentTime = formatTime(new Date());
    return getMealType(currentTime);
}

// Function to group food items by meal
function groupByMeal(foodItems) {
    const meals = { Breakfast: [], Lunch: [], Dinner: [], Snack: [] };
    foodItems.forEach(item => {
        const meal = getMealType(item.timeAdded);
        meals[meal].push(item);
    });
    return meals;
}

function updateProgressBars(totals) {
    // Load saved macros from local storage
    const macros = JSON.parse(localStorage.getItem('macros'));
    const profileStatistics = JSON.parse(localStorage.getItem('profileStatistics'));

    // Default values in case local storage items are not found
    const proteinGoal = macros ? macros.protein : 150;
    const carbsGoal = macros ? macros.carbs : 200;
    const fatGoal = macros ? macros.fat : 100;
    let dailyCalorieGoal = 2400; // Default value

    // Update daily calorie goal if profileStatistics is found
    if (profileStatistics) {
        dailyCalorieGoal = profileStatistics["dailyCaloricExpenditure"]+profileStatistics["BMR"];
    }

    // Calculate percentages for nutrients
    const proteinPercentage = (totals.protein / proteinGoal) * 100;
    const carbsPercentage = (totals.carbs / carbsGoal) * 100;
    const fatPercentage = (totals.fat / fatGoal) * 100;
    const caloriePercentage = (totals.calories / dailyCalorieGoal) * 100;

    // Calculate fractions for nutrients
    const proteinFraction = `${totals.protein} / ${proteinGoal}`;
    const carbsFraction = `${totals.carbs} / ${carbsGoal}`;
    const fatFraction = `${totals.fat} / ${fatGoal}`;
    const calorieFraction = `${totals.calories} / ${dailyCalorieGoal}`;

    // Update nutritional progress bars
    document.querySelector('[data-goal="protein"]').style.width = `${proteinPercentage}%`;
    document.querySelector('.progress-bar-container:nth-child(2) .fraction').textContent = proteinFraction; // Update text content

    document.querySelector('[data-goal="carbs"]').style.width = `${carbsPercentage}%`;
    document.querySelector('.progress-bar-container:nth-child(3) .fraction').textContent = carbsFraction; // Update text content

    document.querySelector('[data-goal="fat"]').style.width = `${fatPercentage}%`;
    document.querySelector('.progress-bar-container:nth-child(4) .fraction').textContent = fatFraction; // Update text content

    document.querySelector('[data-goal="calories"]').style.width = `${caloriePercentage}%`;
    document.querySelector('.progress-bar-container:nth-child(1) .fraction').textContent = calorieFraction; // Update text content
}




function formatTime(date) {
    var hours = date.getHours();
    var minutes = date.getMinutes();

    // Ensure minutes are always two digits
    minutes = minutes < 10 ? '0' + minutes : minutes;

    return hours + ':' + minutes;
}

// Helper function to convert "HH:MM" to minutes since midnight
function timeToMinutes(time) {
    var parts = time.split(':');
    return parseInt(parts[0]) * 60 + parseInt(parts[1]);
}


// Add event listener for meal filter dropdown
document.getElementById('mealFilter').addEventListener('change', function() {
    var foodLog = JSON.parse(localStorage.getItem('foodLog')) || {};
    var foodItems = foodLog[today] || [];
    displayFoodItems(foodItems);
});

document.getElementById('addBtn').addEventListener('click', function() {
    var foodName = document.querySelector('.food').value;
    var grams = parseFloat(document.querySelector('.grams').value);
    if (!foodName || !grams) {
        alert('Please enter both food name and grams.');
        return;
    }

    // Use the optimized single-query function
    getNutritionalInfo(foodName, grams)
        .then(function(nutritionalInfo) {
            hh_mm = formatTime(new Date());
            
            var foodItem = {
                name: foodName,
                grams: grams,
                calories: nutritionalInfo.calories,
                fat: nutritionalInfo.fat,
                protein: nutritionalInfo.protein,
                carbs: nutritionalInfo.carbs,
                timeAdded: hh_mm,
            };

            var foodLog = JSON.parse(localStorage.getItem('foodLog')) || {};
            //var today = new Date().toISOString().split('T')[0]; // Get today's date in YYYY-MM-DD format

            if (!foodLog[today]) {
                foodLog[today] = [];
            }

            var existingData = foodLog[today];
            
            
            var mostRecentIndex = existingData.reduce(function(mostRecentIndex, item, index) {
                if (item.name === foodName) {
                    var currentTimeInMinutes = timeToMinutes(hh_mm);
                    var itemTimeInMinutes = timeToMinutes(item.timeAdded);
                    var timeDifference = Math.abs(currentTimeInMinutes - itemTimeInMinutes);
                    var oneHourInMinutes = 60; // Time difference in minutes for 1 hour

                    if (timeDifference <= oneHourInMinutes) {
                        return index;
                    }
                }
                return mostRecentIndex;
            }, -1);

            if (mostRecentIndex !== -1) {
                var updatedItem = existingData[mostRecentIndex];
                updatedItem.grams += grams;
                getNutritionalInfo(foodName, updatedItem.grams).then(function(updatedNutrition) {
                    updatedItem.calories = updatedNutrition.calories;
                    updatedItem.fat = updatedNutrition.fat;
                    updatedItem.protein = updatedNutrition.protein;
                    updatedItem.carbs = updatedNutrition.carbs;
                    localStorage.setItem('foodLog', JSON.stringify(foodLog));
                    console.log('Existing food item updated');
                    displayFoodItems(existingData);
                });
            } else {
                existingData.push(foodItem);
                localStorage.setItem('foodLog', JSON.stringify(foodLog));
                console.log('Food item added to localStorage');
                console.log(foodLog);
                displayFoodItems(existingData);
            }
        })
        .catch(function(error) {
            console.error('Error getting nutritional info:', error);
            alert('Food not found in database. Please check the spelling.');
        });

    document.querySelector('.food').value = '';
    document.querySelector('.grams').value = '';
});


function displayFoodItems(foodItems) {
    var scrollableWindow = document.getElementById('scrollableWindow');
    var foodInput = document.querySelector('.food');
    var gramsInput = document.querySelector('.grams');
    var selectedMeal = document.getElementById('mealFilter').value;

    scrollableWindow.innerHTML = '';

    // Check for meal plan items for today
    const todayDayOfWeek = new Date().getDay();
    const mealPlanning = JSON.parse(localStorage.getItem('meal_planning')) || {
        mealPlans: {},
        completedMeals: {},
        removedMeals: {},
        mealPlanDays: {},
        lastReset: null
    };
    
    // Ensure all required properties exist
    if (!mealPlanning.mealPlans) mealPlanning.mealPlans = {};
    if (!mealPlanning.completedMeals) mealPlanning.completedMeals = {};
    if (!mealPlanning.removedMeals) mealPlanning.removedMeals = {};
    if (!mealPlanning.mealPlanDays) mealPlanning.mealPlanDays = {};
    if (!mealPlanning.lastReset) mealPlanning.lastReset = null;
    
    const dayMealPlan = mealPlanning.mealPlanDays[todayDayOfWeek];
    const mealPlans = mealPlanning.mealPlans;
    const completedMeals = mealPlanning.completedMeals[todayDayOfWeek] || [];
    const removedMeals = mealPlanning.removedMeals[todayDayOfWeek] || [];

    // Filter items based on selected meal
    let itemsToDisplay = foodItems;
    if (selectedMeal !== 'All') {
        itemsToDisplay = foodItems.filter(item => getMealType(item.timeAdded) === selectedMeal);
    }

    // Group items by meal if showing all meals
    if (selectedMeal === 'All') {
        const meals = groupByMeal(itemsToDisplay);
        const defaultMealOrder = ['Breakfast', 'Lunch', 'Dinner', 'Snack'];
        
        // Get current meal type and reorder to put it first
        const currentMealType = getCurrentMealType();
        const mealOrder = [currentMealType, ...defaultMealOrder.filter(meal => meal !== currentMealType)];
        
        mealOrder.forEach(mealType => {
            const hasRegularItems = meals[mealType].length > 0;
            const hasPlannedItems = dayMealPlan && mealPlans[dayMealPlan] && 
                                  mealPlans[dayMealPlan][mealType.toLowerCase()] && 
                                  mealPlans[dayMealPlan][mealType.toLowerCase()].length > 0;
            
            if (hasRegularItems || hasPlannedItems) {
                // Create meal header container
                var mealHeaderContainer = document.createElement('div');
                mealHeaderContainer.className = 'meal-header-container';
                mealHeaderContainer.style.display = 'flex';
                mealHeaderContainer.style.justifyContent = 'space-between';
                mealHeaderContainer.style.alignItems = 'center';
                mealHeaderContainer.style.backgroundColor = 'var(--background-color)';
                mealHeaderContainer.style.padding = '6px 10px';
                mealHeaderContainer.style.marginTop = '8px';
                mealHeaderContainer.style.borderBottom = '1px solid var(--border-color)';
                mealHeaderContainer.style.fontWeight = 'bold';
                mealHeaderContainer.style.fontSize = '14px';
                mealHeaderContainer.style.color = 'var(--text-color)';
                mealHeaderContainer.style.opacity = '0.8';
                
                
                // Add meal header with emoji
                var mealHeader = document.createElement('div');
                mealHeader.className = 'meal-header';
                mealHeader.style.flex = '1';
                
                // Add emoji based on meal type
                let emoji = '';
                switch(mealType) {
                    case 'Breakfast':
                        emoji = 'üåÖ';
                        break;
                    case 'Lunch':
                        emoji = '‚òÄÔ∏è';
                        break;
                    case 'Dinner':
                        emoji = 'üåô';
                        break;
                    case 'Snack':
                        emoji = 'üçé';
                        break;
                }
                
                // Calculate meal totals and get time range
                const mealTotals = calculateMealTypeTotals(foodItems, mealType);
                const timeRange = getMealTimeRange(mealType);
                
                mealHeader.innerHTML = `<span>${emoji} ${mealType} ${timeRange} -- Calories: ${mealTotals.calories}</span>`;
                
                // Add toggle button
                var toggleButton = document.createElement('button');
                toggleButton.className = 'meal-toggle-btn';
                toggleButton.textContent = '‚ñº';
                toggleButton.style.background = 'var(--button)';
                toggleButton.style.color = 'var(--text-color)';
                toggleButton.style.border = '1px solid var(--border-color)';
                toggleButton.style.borderRadius = '3px';
                toggleButton.style.padding = '4px 8px';
                toggleButton.style.cursor = 'pointer';
                toggleButton.style.fontSize = '12px';
                toggleButton.style.minWidth = '30px';
                toggleButton.style.textAlign = 'center';
                toggleButton.style.transition = 'background-color 0.2s';
                
                toggleButton.addEventListener('click', function() {
                    toggleMealCategory(mealType, toggleButton);
                });
                
                mealHeaderContainer.appendChild(mealHeader);
                mealHeaderContainer.appendChild(toggleButton);
                scrollableWindow.appendChild(mealHeaderContainer);

                // Create container for meal items that can be toggled
                var mealItemsContainer = document.createElement('div');
                mealItemsContainer.className = `meal-items-container meal-items-${mealType.toLowerCase()}`;
                mealItemsContainer.style.display = 'block'; // Start expanded
                scrollableWindow.appendChild(mealItemsContainer);

                // Display planned meal items first (greyed out with check buttons)
                if (hasPlannedItems) {
                    const plannedItems = mealPlans[dayMealPlan][mealType.toLowerCase()];
                    const uncompletedPlannedItems = plannedItems.filter(item => 
                        !completedMeals.includes(item.name) && !removedMeals.includes(item.name)
                    );
                    
                    // Only show planned items section if there are uncompleted items
                    if (uncompletedPlannedItems.length > 0) {
                        uncompletedPlannedItems.forEach(function(item) {
                            displayPlannedMealItem(item, mealItemsContainer, foodInput, gramsInput, completedMeals);
                        });
                    }
                }

                // Display regular food items (including completed planned meals)
                meals[mealType].forEach(function(item, index) {
                    displayFoodItem(item, foodItems, mealItemsContainer, foodInput, gramsInput);
                });
            }
        });
    } else {
        // Display filtered items without meal headers
        itemsToDisplay.forEach(function(item, index) {
            displayFoodItem(item, foodItems, scrollableWindow, foodInput, gramsInput);
        });
    }

    // Calculate and update totals based on selected meal
    var totals = calculateMealTotals(foodItems, selectedMeal);
    updateProgressBars(totals);
}

function displayFoodItem(item, allFoodItems, scrollableWindow, foodInput, gramsInput) {
    var listItem = document.createElement('div');
    listItem.className = 'list-item';
    listItem.innerHTML = `${item.name}<br><span class="small-text">${item.grams}g, Calories ${item.calories}, Protein ${item.protein}g, Carbs ${item.carbs}g, Fat ${item.fat}g</span>`;

    var deleteButton = document.createElement('button');
    deleteButton.textContent = '‚ùå';
    deleteButton.className = 'delete-btn';
    deleteButton.style.float = 'right';
    deleteButton.addEventListener('click', function(e) {
        e.stopPropagation(); // Prevent the listItem click from firing
        
        // Store the deleted food name to repopulate the input field
        var deletedFoodName = item.name;
        var deletedGrams = item.grams;
        
        // Remove the item directly from the array
        var itemIndex = allFoodItems.indexOf(item);
        if (itemIndex !== -1) {
            allFoodItems.splice(itemIndex, 1);
            var foodLog = JSON.parse(localStorage.getItem('foodLog')) || {};
            foodLog[today] = allFoodItems;
            localStorage.setItem('foodLog', JSON.stringify(foodLog));
            displayFoodItems(allFoodItems);
        }
        
        // Repopulate the input fields with the deleted food info
        foodInput.value = deletedFoodName;
        gramsInput.value = deletedGrams;
        
        // Focus on the grams input for quick editing
        gramsInput.focus();
        gramsInput.select();
    });

    listItem.appendChild(deleteButton);

    listItem.addEventListener('click', function() {
        foodInput.value = item.name;
        
        // Focus and select grams input immediately
        gramsInput.focus();
        gramsInput.select();
        
        // Fetch serving weight and description
        fetchValueForKey(item.name, 'servingWeight1', function(value) {
            gramsInput.value = value;
            gramsInput.select();
        });
        
        fetchValueForKey(item.name, 'servingDescription1', function(description) {
            showServingBubble(description, gramsInput);
        });
    });

    scrollableWindow.appendChild(listItem);
}

function displayPlannedMealItem(item, scrollableWindow, foodInput, gramsInput, completedMeals) {
    var listItem = document.createElement('div');
    listItem.className = 'list-item planned-meal-item';
    listItem.style.opacity = '0.6';
    listItem.style.backgroundColor = 'rgba(255, 255, 200, 0.15)';
    listItem.style.cursor = 'pointer'; // Make it clear it's clickable
    
    listItem.innerHTML = `${item.name}<br><span class="small-text">${item.grams}g, Calories ${item.calories}, Protein ${item.protein}g, Carbs ${item.carbs}g, Fat ${item.fat}g</span>`;

    // Add red X button for removal
    var removeButton = document.createElement('button');
    removeButton.textContent = '‚ùå';
    removeButton.className = 'delete-btn';
    removeButton.style.float = 'right';
    
    removeButton.addEventListener('click', function(e) {
        e.stopPropagation();
        removePlannedMealItem(item);
    });

    // Add click handler to apply the planned item
    listItem.addEventListener('click', function(e) {
        e.stopPropagation();
        applyPlannedMealItem(item);
    });

    listItem.appendChild(removeButton);
    scrollableWindow.appendChild(listItem);
}

function removePlannedMealItem(item) {
    const todayDayOfWeek = new Date().getDay();
    
    // Add to removed meals for this day
    const mealPlanning = JSON.parse(localStorage.getItem('meal_planning')) || {
        mealPlans: {},
        completedMeals: {},
        removedMeals: {},
        mealPlanDays: {},
        lastReset: null
    };
    
    // Ensure all required properties exist
    if (!mealPlanning.mealPlans) mealPlanning.mealPlans = {};
    if (!mealPlanning.completedMeals) mealPlanning.completedMeals = {};
    if (!mealPlanning.removedMeals) mealPlanning.removedMeals = {};
    if (!mealPlanning.mealPlanDays) mealPlanning.mealPlanDays = {};
    if (!mealPlanning.lastReset) mealPlanning.lastReset = null;
    
    if (!mealPlanning.removedMeals[todayDayOfWeek]) {
        mealPlanning.removedMeals[todayDayOfWeek] = [];
    }
    
    if (!mealPlanning.removedMeals[todayDayOfWeek].includes(item.name)) {
        mealPlanning.removedMeals[todayDayOfWeek].push(item.name);
        localStorage.setItem('meal_planning', JSON.stringify(mealPlanning));
    }
    
    // Refresh the display
    const foodLog = JSON.parse(localStorage.getItem('foodLog')) || {};
    const foodItems = foodLog[today] || [];
    displayFoodItems(foodItems);
}

function applyPlannedMealItem(item) {
    const todayDayOfWeek = new Date().getDay();
    
    // Add the planned item to the food log
    const foodLog = JSON.parse(localStorage.getItem('foodLog')) || {};
    if (!foodLog[today]) {
        foodLog[today] = [];
    }
    
    const foodItem = {
        name: item.name,
        grams: item.grams,
        calories: item.calories,
        fat: item.fat,
        protein: item.protein,
        carbs: item.carbs,
        timeAdded: formatTime(new Date())
    };
    
    foodLog[today].push(foodItem);
    localStorage.setItem('foodLog', JSON.stringify(foodLog));
    
    // Add to completed meals for this day
    const mealPlanning = JSON.parse(localStorage.getItem('meal_planning')) || {
        mealPlans: {},
        completedMeals: {},
        removedMeals: {},
        mealPlanDays: {},
        lastReset: null
    };
    
    // Ensure all required properties exist
    if (!mealPlanning.mealPlans) mealPlanning.mealPlans = {};
    if (!mealPlanning.completedMeals) mealPlanning.completedMeals = {};
    if (!mealPlanning.removedMeals) mealPlanning.removedMeals = {};
    if (!mealPlanning.mealPlanDays) mealPlanning.mealPlanDays = {};
    if (!mealPlanning.lastReset) mealPlanning.lastReset = null;
    
    if (!mealPlanning.completedMeals[todayDayOfWeek]) {
        mealPlanning.completedMeals[todayDayOfWeek] = [];
    }
    
    if (!mealPlanning.completedMeals[todayDayOfWeek].includes(item.name)) {
        mealPlanning.completedMeals[todayDayOfWeek].push(item.name);
        localStorage.setItem('meal_planning', JSON.stringify(mealPlanning));
    }
    
    // Refresh the display
    displayFoodItems(foodLog[today]);
}

function toggleMealCategory(mealType, button) {
    const mealItemsContainer = document.querySelector(`.meal-items-${mealType.toLowerCase()}`);
    
    if (mealItemsContainer.style.display === 'none') {
        mealItemsContainer.style.display = 'block';
        button.textContent = '‚ñº';
        button.style.transform = 'rotate(0deg)';
    } else {
        mealItemsContainer.style.display = 'none';
        button.textContent = '‚ñ∂';
        button.style.transform = 'rotate(-90deg)';
    }
}





//You should place the document.addEventListener('DOMContentLoaded', function() { ... }) 
//block at the end of your <script> tag, right before the closing script tag.
// This ensures that the entire DOM is fully loaded before your JavaScript code attempts
// to access or modify any DOM elements. 

		
		

document.addEventListener('DOMContentLoaded', function() {
    // Check if 'csvDB' exists in the list of databases
	

	// Add debugging information
	console.log('IndexedDB support:', 'indexedDB' in window);
	
	// Try to check if database exists, with fallback for older browsers
	if ('databases' in indexedDB) {
		indexedDB.databases().then(function(databases) {
			console.log('Available databases:', databases);
			// Check if 'csvDB' exists in the list of databases
			const dbExists = databases.some(db => db.name === 'csvDB');
			console.log('csvDB exists:', dbExists);

			if (!dbExists) {
				// 'csvDB' does not exist, ask user if they want to download the database
				console.log('csvDB does not exist.');
				const userWantsToDownload = confirm('No food database found. Would you like to download the food database now? This will enable food search and nutritional information.');
				
				if (userWantsToDownload) {
					// Show progress indicator
					showProgress('Initial Database Setup', 'Downloading food database...');
					updateProgress(10, 'Starting download...');
					
					fetch('assets/FoodData.csv')
						.then(response => {
							updateProgress(30, 'File downloaded, processing data...');
							return response.text();
						})
						.then(csvData => {
							updateProgress(50, 'Storing data in database...');
							// Process and store the CSV data
							parseAndStoreCSV(csvData);
						})
						.catch(error => {
							console.error('Error fetching CSV:', error);
							hideProgress();
							alert('Error downloading food database. Please try again later.');
						});
				} else {
					console.log('User chose not to download the database.');
					// Optionally show a message that they can download it later from settings
					alert('You can download the food database later from the Settings menu (‚öôÔ∏è) by clicking "Fetch and Store CSV Data".');
				}
			} else {
				// 'csvDB' exists, you can proceed with opening it or other actions
				console.log('csvDB exists.');
			}
		}).catch(function(error) {
			console.error('Error fetching databases:', error);
		});
	} else {
		// Fallback for browsers that don't support indexedDB.databases()
		console.log('indexedDB.databases() not supported, skipping database check');
	}




	// Get the current time in the local time zone
	//const currentTime = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });

	//if the user time is 3am we will only update the date if we are past 3am
	//if the date is technically 3/24/2024 but it is not past 3am we will not update the date
	//however this means we will need to save today in local storage OR do a day subtraction if its lower than 3am


	//this should be the only place global today is defined.
	today = new Date().toLocaleDateString('en-CA');
	//console.log(today);
	localStorage.setItem('today', today);
	// Display the time
	//console.log(currentTime);

	//check if we need to revert the day
	var foodLog = JSON.parse(localStorage.getItem('foodLog')) || {};
    //var foodItems = JSON.parse(localStorage.getItem(today)) || [];
	var foodItems = foodLog[today] || [];
	//var foodItems = JSON.parse(localStorage.getItem(today)) || [];
    initializeFoodList();
	displayFoodItems(foodItems, today);
	
    // Set up header using centralized menu system
    setupHeader();

    // Add event listener for refresh button
    document.getElementById('refreshFoodDb').addEventListener('click', refreshFoodDatabase);
    
    // Update database size on page load
    updateDatabaseSize();
});

document.getElementById('settingsToggle').addEventListener('click', function() {
    const panel = document.getElementById('settingsPanel');
    if (panel.style.display === 'none') {
        panel.style.display = 'block';
        this.textContent = 'üîº Settings';
    } else {
        panel.style.display = 'none';
        this.textContent = '‚öôÔ∏è Settings';
    }
});

	// Function to calculate and display database size
	function updateDatabaseSize() {
		const dbName = 'csvDB';
		const storeName = 'csvStore';
		
		const dbRequest = indexedDB.open(dbName);
		
		dbRequest.onsuccess = function(event) {
			const db = event.target.result;
			const transaction = db.transaction([storeName], 'readonly');
			const store = transaction.objectStore(storeName);
			const request = store.count();
			
			request.onsuccess = function() {
				const recordCount = request.result;
				// Estimate size: each record is approximately 200-300 bytes
				// We'll use 250 bytes as an average estimate
				const estimatedSizeBytes = recordCount * 250;
				const sizeInMB = (estimatedSizeBytes / (1024 * 1024)).toFixed(2);
				
				document.getElementById('dbSizeValue').textContent = `${sizeInMB} MB (${recordCount} records)`;
			};
			
			request.onerror = function() {
				document.getElementById('dbSizeValue').textContent = 'Error calculating size';
			};
			
			db.close();
		};
		
		dbRequest.onerror = function() {
			document.getElementById('dbSizeValue').textContent = 'Database not found';
		};
	}

	// Add the refresh function after the initializeFoodList function
	function refreshFoodDatabase() {
		// Clear the current foodList
		foodList = [];
		
		showProgress('Refreshing Database', 'Reloading food data...');
		updateProgress(20, 'Clearing old data...');
		
		// Show loading indicator
		const originalPlaceholder = document.querySelector('.food').placeholder;
		document.querySelector('.food').placeholder = "Refreshing food database...";
		
		setTimeout(() => {
			updateProgress(50, 'Reloading database...');
			// Call initializeFoodList again
			initializeFoodList();
			
			setTimeout(() => {
				updateProgress(100, 'Database refreshed!');
				setTimeout(() => {
					hideProgress();
					document.querySelector('.food').placeholder = originalPlaceholder;
					// Update database size after refresh
					updateDatabaseSize();
					alert("Food database refreshed. New recipes should now appear in search.");
				}, 500);
			}, 500);
		}, 300);
	}

	// Daily meal plan progress reset functions
	function checkAndResetDailyProgress() {
		const userTime = localStorage.getItem('userTime') || '01:00'; // Default to 1:00 AM
		const mealPlanning = JSON.parse(localStorage.getItem('meal_planning')) || {
			mealPlans: {},
			completedMeals: {},
			removedMeals: {},
			mealPlanDays: {},
			lastReset: null
		};
		const currentDate = new Date();
		const currentDateString = currentDate.toDateString();
		
		// Check if we need to reset based on userTime
		if (shouldResetBasedOnUserTime(userTime, mealPlanning.lastReset, currentDate)) {
			resetAllDailyProgress();
			mealPlanning.lastReset = currentDateString;
			localStorage.setItem('meal_planning', JSON.stringify(mealPlanning));
		}
	}

	function shouldResetBasedOnUserTime(userTime, lastResetDate, currentDate) {
		// If no previous reset, reset now
		if (!lastResetDate) {
			return true;
		}
		
		// Parse userTime (format: "HH:MM")
		const [userHour, userMinute] = userTime.split(':').map(Number);
		const userTimeInMinutes = userHour * 60 + userMinute;
		
		// Get current time
		const currentHour = currentDate.getHours();
		const currentMinute = currentDate.getMinutes();
		const currentTimeInMinutes = currentHour * 60 + currentMinute;
		
		// Get today's date string
		const todayString = currentDate.toDateString();
		
		// If it's a new day and we're past the userTime, reset
		if (lastResetDate !== todayString && currentTimeInMinutes >= userTimeInMinutes) {
			return true;
		}
		
		return false;
	}

	function resetAllDailyProgress() {
		// Clear completed and removed meals for all days of the week
		const mealPlanning = JSON.parse(localStorage.getItem('meal_planning')) || {
			mealPlans: {},
			completedMeals: {},
			removedMeals: {},
			mealPlanDays: {},
			lastReset: null
		};
		mealPlanning.completedMeals = {};
		mealPlanning.removedMeals = {};
		localStorage.setItem('meal_planning', JSON.stringify(mealPlanning));
		console.log('Daily meal plan progress has been reset for the new day.');
	}

	function migrateOldMealPlanData() {
		// Check if we need to migrate old meal plan data
		const hasOldData = localStorage.getItem('mealPlans') || 
			localStorage.getItem('lastMealPlanReset') ||
			localStorage.getItem('mealPlan_day_0') ||
			localStorage.getItem('completedMeals_day_0') ||
			localStorage.getItem('removedMeals_day_0');
		
		if (hasOldData) {
			console.log('Migrating old meal plan data to new consolidated structure...');
			
			// Get current meal planning data
			let mealPlanning = JSON.parse(localStorage.getItem('meal_planning')) || {
				mealPlans: {},
				completedMeals: {},
				removedMeals: {},
				mealPlanDays: {},
				lastReset: null
			};
			
			// Migrate meal plans
			const oldMealPlans = JSON.parse(localStorage.getItem('mealPlans')) || {};
			if (Object.keys(oldMealPlans).length > 0) {
				mealPlanning.mealPlans = { ...mealPlanning.mealPlans, ...oldMealPlans };
			}
			
			// Migrate day assignments
			for (let day = 0; day < 7; day++) {
				const dayMealPlan = localStorage.getItem(`mealPlan_day_${day}`);
				if (dayMealPlan) {
					mealPlanning.mealPlanDays[day] = dayMealPlan;
				}
			}
			
			// Migrate completed meals
			for (let day = 0; day < 7; day++) {
				const completedMeals = JSON.parse(localStorage.getItem(`completedMeals_day_${day}`)) || [];
				if (completedMeals.length > 0) {
					mealPlanning.completedMeals[day] = completedMeals;
				}
			}
			
			// Migrate removed meals
			for (let day = 0; day < 7; day++) {
				const removedMeals = JSON.parse(localStorage.getItem(`removedMeals_day_${day}`)) || [];
				if (removedMeals.length > 0) {
					mealPlanning.removedMeals[day] = removedMeals;
				}
			}
			
			// Migrate last reset
			const lastReset = localStorage.getItem('lastMealPlanReset');
			if (lastReset) {
				mealPlanning.lastReset = lastReset;
			}
			
			// Save the consolidated data
			localStorage.setItem('meal_planning', JSON.stringify(mealPlanning));
			
			// Clean up old keys
			localStorage.removeItem('mealPlans');
			localStorage.removeItem('lastMealPlanReset');
			for (let day = 0; day < 7; day++) {
				localStorage.removeItem(`mealPlan_day_${day}`);
				localStorage.removeItem(`completedMeals_day_${day}`);
				localStorage.removeItem(`removedMeals_day_${day}`);
			}
			
			console.log('Migration completed successfully!');
		}
	}
	
</script>
	
</body>



</html>