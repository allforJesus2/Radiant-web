<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>5/3/1 Workout Generator</title>
    <style>
        :root {
            --primary: #3a0ca3;
            --secondary: #4361ee;
            --light: #f1faee;
            --dark: #1d3557;
            --accent: #e63946;
            --success: #2a9d8f;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: var(--dark);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: var(--primary);
            color: white;
            padding: 0.5rem;
            text-align: center;
            border-radius: 8px 8px 0 0;
            margin-bottom: 1rem;
        }
        
        h1 {
            font-size: 1.8rem;
            margin-bottom: 0.25rem;
        }
        
        .subtitle {
            font-size: 1rem;
            font-weight: 300;
        }
        
        .main-content {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .input-section, .result-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .input-section {
            flex: 1;
            min-width: 300px;
        }
        
        .result-section {
            flex: 2;
            min-width: 300px;
        }
        
        h2 {
            color: var(--primary);
            margin-bottom: 1rem;
            border-bottom: 2px solid var(--light);
            padding-bottom: 0.5rem;
        }
        
        .input-group {
            margin-bottom: 1.5rem;
        }
        
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        
        input[type="number"], select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }
        
        button {
            background-color: var(--secondary);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: background-color 0.3s;
            width: 100%;
        }
        
        button:hover {
            background-color: var(--primary);
        }
        
        .week-tabs {
            display: flex;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid #ddd;
        }
        
        .week-tab {
            padding: 10px 20px;
            cursor: pointer;
            border: 1px solid transparent;
            border-bottom: none;
            border-radius: 4px 4px 0 0;
            background-color: #f5f5f5;
            margin-right: 5px;
        }
        
        .week-tab.active {
            background-color: white;
            border-color: #ddd;
            border-bottom-color: white;
            margin-bottom: -1px;
            color: var(--primary);
            font-weight: 600;
        }
        
        .week-content {
            display: none;
        }
        
        .week-content.active {
            display: block;
        }
        
        /* Day tabs styling */
        .day-tabs {
            display: flex;
            margin-bottom: 1rem;
            gap: 0.5rem;
        }
        
        .day-tab {
            padding: 8px 16px;
            cursor: pointer;
            background-color: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 4px;
            flex: 1;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .day-tab:hover {
            background-color: #e9ecef;
        }
        
        .day-tab.active {
            background-color: var(--secondary);
            color: white;
            border-color: var(--secondary);
        }
        
        .day-content {
            display: none;
        }
        
        .day-content.active {
            display: block;
        }
        
        .day-card {
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid var(--secondary);
        }
        
        .day-header {
            font-weight: 600;
            font-size: 1.2rem;
            margin-bottom: 10px;
            color: var(--primary);
        }
        
        .exercise-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
        }
        
        .exercise-table th, .exercise-table td {
            padding: 10px;
            border-bottom: 1px solid #eee;
            text-align: left;
        }
        
        .exercise-table th {
            background-color: #f5f5f5;
            font-weight: 600;
        }
        
        .accessory-section {
            margin-top: 1rem;
        }
        
        .accessory-section h4 {
            color: var(--secondary);
            margin-bottom: 0.5rem;
        }
        
        .accessory-list {
            list-style-type: none;
        }
        
        .accessory-list li {
            padding: 5px 0;
            display: flex;
            justify-content: space-between;
        }
        
        .notes {
            margin-top: 1rem;
            padding: 10px;
            background-color: #f1faee;
            border-left: 3px solid var(--success);
            font-style: italic;
        }
        
        .warm-up-section {
            margin-top: 1rem;
            background-color: #fff3ec;
            padding: 10px;
            border-radius: 4px;
        }
        
        .warm-up-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .warm-up-table td {
            padding: 5px;
        }
        
        .print-button {
            background-color: var(--success);
            margin-top: 1rem;
        }
        
        @media print {
            header, .input-section, button {
                display: none;
            }
            
            .container {
                width: 100%;
                max-width: none;
                padding: 0;
            }
            
            .result-section {
                box-shadow: none;
                padding: 0;
            }
            
            .day-card {
                page-break-inside: avoid;
            }
        }
        
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .input-section, .result-section {
                width: 100%;
            }
            
            /* Make the result section appear first on mobile */
            .input-section {
                order: 2;
                margin-top: 20px;
            }
            
            .result-section {
                order: 1;
            }
        }
        
        .toggle-container {
            display: flex;
            margin-bottom: 1rem;
        }
        
        .toggle-option {
            flex: 1;
            text-align: center;
            padding: 10px;
            background-color: #f5f5f5;
            cursor: pointer;
            border: 1px solid #ddd;
        }
        
        .toggle-option:first-child {
            border-radius: 4px 0 0 4px;
        }
        
        .toggle-option:last-child {
            border-radius: 0 4px 4px 0;
        }
        
        .toggle-option.active {
            background-color: var(--secondary);
            color: white;
            font-weight: 600;
        }
        
        .percentage-info {
            font-size: 0.9rem;
            color: #666;
            margin-top: 0.5rem;
        }
        
        .amrap-set {
            color: var(--accent);
            font-weight: 600;
        }
        
        .explanation-box {
            margin-top: 10px;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 5px;
            font-size: 0.9em;
            line-height: 1.4;
            color: #333;
        }
        
        .level-display {
            float: right;
            background-color: #FFD700;
            color: #000;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 1rem;
            margin-top: 5px;
        }
        
        .level-up-button {
            background-color: #FFD700;
            color: #000;
            margin-top: 1rem;
            border: 2px solid #DAA520;
        }
        
        .level-up-button:hover {
            background-color: #DAA520;
            border-color: #B8860B;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        /* AMRAP Logging Styles */
        .amrap-logging {
            margin-top: 1.5rem;
            padding: 15px;
            background-color: #fff8e1;
            border-left: 4px solid #ffa726;
            border-radius: 4px;
        }
        
        .amrap-logging h4 {
            color: #f57c00;
            margin-bottom: 1rem;
        }
        
        .amrap-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 1rem;
        }
        
        .amrap-input-group label {
            font-weight: 600;
            margin: 0;
        }
        
        .amrap-input-group input[type="number"] {
            width: 80px;
            padding: 8px;
        }
        
        .amrap-recommendations {
            margin-top: 1rem;
        }
        
        .amrap-option {
            display: flex;
            align-items: center;
            padding: 12px;
            margin-bottom: 10px;
            background-color: white;
            border: 2px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .amrap-option:hover {
            border-color: var(--secondary);
            background-color: #f0f4ff;
        }
        
        .amrap-option input[type="radio"] {
            margin-right: 10px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .amrap-option-content {
            flex: 1;
        }
        
        .amrap-option-title {
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .amrap-option-description {
            font-size: 0.9rem;
            color: #666;
        }
        
        .amrap-option.selected {
            border-color: var(--success);
            background-color: #e8f5e9;
        }
        
        .amrap-option.recommended {
            border-color: #4caf50;
        }
        
        .amrap-option.warning {
            border-color: #ff9800;
        }
        
        .amrap-option.danger {
            border-color: #f44336;
        }
        
        .recommendation-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 8px;
        }
        
        .badge-recommended {
            background-color: #4caf50;
            color: white;
        }
        
        .badge-warning {
            background-color: #ff9800;
            color: white;
        }
        
        .badge-danger {
            background-color: #f44336;
            color: white;
        }
        
        .amrap-submit-btn {
            background-color: var(--success);
            margin-top: 1rem;
        }
        
        .amrap-status {
            margin-top: 1rem;
            padding: 10px;
            border-radius: 4px;
            background-color: #e8f5e9;
            border-left: 4px solid #4caf50;
        }
        
        .amrap-status.logged {
            background-color: #e3f2fd;
            border-left-color: #2196f3;
        }
        
        /* Quiz Modal Styles */
        .quiz-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .quiz-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .quiz-header {
            background-color: var(--primary);
            color: white;
            padding: 20px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .quiz-header h3 {
            margin: 0;
            font-size: 1.5rem;
        }
        
        .close-quiz {
            background: none;
            border: none;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .close-quiz:hover {
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
        }
        
        .quiz-body {
            padding: 30px;
        }
        
        .quiz-question h4 {
            color: var(--primary);
            margin-bottom: 10px;
            font-size: 1.2rem;
        }
        
        .quiz-question p {
            font-size: 1.1rem;
            margin-bottom: 25px;
            color: var(--dark);
        }
        
        .quiz-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .quiz-option {
            padding: 15px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            background-color: #f9f9f9;
        }
        
        .quiz-option:hover {
            border-color: var(--secondary);
            background-color: #f0f4ff;
        }
        
        .quiz-option.selected {
            border-color: var(--primary);
            background-color: var(--light);
            color: var(--primary);
            font-weight: 600;
        }
        
        .quiz-progress {
            margin-top: 30px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .progress-bar {
            flex: 1;
            height: 8px;
            background-color: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background-color: var(--success);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .quiz-footer {
            padding: 20px 30px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
        }
        
        .quiz-nav-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        
        .quiz-nav-btn:disabled {
            background-color: #e0e0e0;
            color: #999;
            cursor: not-allowed;
        }
        
        .quiz-nav-btn:not(:disabled) {
            background-color: var(--secondary);
            color: white;
        }
        
        .quiz-nav-btn:not(:disabled):hover {
            background-color: var(--primary);
        }
        
        @media (max-width: 768px) {
            .quiz-content {
                width: 95%;
                margin: 20px;
            }
            
            .quiz-body {
                padding: 20px;
            }
            
            .quiz-footer {
                padding: 15px 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>5/3/1 Workout Generator</h1>
        </header>
        
        <div class="main-content">
            <div class="input-section">
                <h2>Program Setup</h2>
                
                <div class="input-group">
                    <label for="squat-1rm">Squat 1RM (lbs)</label>
                    <input type="number" id="squat-1rm" min="0" step="5" placeholder="e.g. 315">
                </div>
                
                <div class="input-group">
                    <label for="bench-1rm">Bench Press 1RM (lbs)</label>
                    <input type="number" id="bench-1rm" min="0" step="5" placeholder="e.g. 225">
                </div>
                
                <div class="input-group">
                    <label for="deadlift-1rm">Deadlift 1RM (lbs)</label>
                    <input type="number" id="deadlift-1rm" min="0" step="5" placeholder="e.g. 405">
                </div>
                
                <div class="input-group">
                    <label for="ohp-1rm">Overhead Press 1RM (lbs)</label>
                    <input type="number" id="ohp-1rm" min="0" step="5" placeholder="e.g. 135">
                </div>
                
                <div class="input-group">
                    <div class="notes" style="margin-bottom: 1rem;">
                        <p><strong>Progression Guide:</strong></p>
                        <ul>
                            <li>After each 4-week cycle:</li>
                            <li>• Increase upper body lifts (Bench, OHP) by 5 lbs</li>
                            <li>• Increase lower body lifts (Squat, Deadlift) by 10 lbs</li>
                            <li>Use AMRAP sets to gauge progress</li>
                            <li>Adjust slower if AMRAP sets are challenging</li>
                        </ul>
                    </div>
                </div>
                
                <div class="input-group">
                    <label>Training Max Percentage</label>
                    <div class="toggle-container">
                        <div class="toggle-option active" data-value="90">90%</div>
                        <div class="toggle-option" data-value="85">85%</div>
                    </div>
                    <p class="percentage-info">Wendler recommends 85-90% of 1RM as your Training Max</p>
                </div>
                
                <div class="input-group">
                    <label for="accessory-template">Accessory Template</label>
                    <button id="quiz-button" style="background-color: var(--accent); padding: 10px 15px; width: 100%; margin-bottom: 10px;">Help Me Choose</button>
                    <select id="accessory-template">
                        <option value="standard">Standard (25-50 reps Push/Pull/Core)</option>
                        <option value="bbb">Boring But Big (5x10 @ 50-60%)</option>
                        <option value="fsl">First Set Last (5x5 @ First Set Weight)</option>
                        <option value="triumvirate">Triumvirate (2 accessories, 5x10-15)</option>
                        <option value="beginners">5/3/1 for Beginners (FSL + specific accessories)</option>
                    </select>
                </div>
                <div id="accessory-explanation" class="explanation-box"></div>
                
                <!-- Quiz Modal -->
                <div id="quiz-modal" class="quiz-modal" style="display: none;">
                    <div class="quiz-content">
                        <div class="quiz-header">
                            <h3>Find Your Perfect 5/3/1 Accessory Template</h3>
                            <button id="close-quiz" class="close-quiz">&times;</button>
                        </div>
                        <div class="quiz-body">
                            <div id="quiz-question" class="quiz-question">
                                <h4 id="question-text">Question 1 of 5</h4>
                                <p id="question-content">What's your primary training goal?</p>
                                <div id="quiz-options" class="quiz-options">
                                    <!-- Options will be populated by JavaScript -->
                                </div>
                            </div>
                            <div class="quiz-progress">
                                <div class="progress-bar">
                                    <div id="progress-fill" class="progress-fill"></div>
                                </div>
                                <span id="progress-text">0/5</span>
                            </div>
                        </div>
                        <div class="quiz-footer">
                            <button id="prev-question" class="quiz-nav-btn" disabled>Previous</button>
                            <button id="next-question" class="quiz-nav-btn" disabled>Next</button>
                        </div>
                    </div>
                </div>
                
                <button id="generate-button">Generate Workout Plan</button>
                
                <div class="input-group">
                    <button id="delete-profile-button" style="background-color: var(--accent); margin-top: 1rem;">Delete Saved Profile</button>
                </div>

                <div class="input-group">
                    <button id="print-button" class="print-button">Print Workout Plan</button>
                </div>
            </div>
            
            <div class="result-section">
                <h2>Your 5/3/1 Workout Plan <span id="level-display" class="level-display">LVL: 1</span></h2>
                
                <div class="week-tabs">
                    <div class="week-tab active" data-week="1">Week 1 (5/5/5+)</div>
                    <div class="week-tab" data-week="2">Week 2 (3/3/3+)</div>
                    <div class="week-tab" data-week="3">Week 3 (5/3/1+)</div>
                    <div class="week-tab" data-week="4">Week 4 (Deload)</div>
                </div>
                
                <div id="workout-results">
                    <p>Enter your 1-rep max values and click "Generate Workout Plan" to create your personalized 5/3/1 program.</p>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Variables
            let tmPercentage = 90;
            let accessoryTemplate = 'standard';
            let workoutPlan = {};
            let currentWeek = 1;
            let currentDay = 0;
            let userLevel = 1; // Initialize user level
            let amrapResults = {}; // Store AMRAP results for each exercise

            // Load saved profile from localStorage
            function loadProfile() {
                const savedProfile = localStorage.getItem('531-workout-profile');
                if (savedProfile) {
                    const profile = JSON.parse(savedProfile);
                    
                    // Restore input values
                    document.getElementById('squat-1rm').value = profile.inputs.squat || '';
                    document.getElementById('bench-1rm').value = profile.inputs.bench || '';
                    document.getElementById('deadlift-1rm').value = profile.inputs.deadlift || '';
                    document.getElementById('ohp-1rm').value = profile.inputs.ohp || '';
                    
                    // Restore TM percentage
                    tmPercentage = profile.tmPercentage || 90;
                    tmOptions.forEach(option => {
                        option.classList.toggle('active', option.dataset.value === tmPercentage.toString());
                    });
                    
                    // Restore accessory template
                    accessoryTemplate = profile.accessoryTemplate || 'standard';
                    accessorySelect.value = accessoryTemplate;
                    
                    // Restore UI state
                    currentWeek = profile.currentWeek || 1;
                    currentDay = profile.currentDay || 0;
                    
                    // Restore user level
                    userLevel = profile.userLevel || 1;
                    updateLevelDisplay();
                    
                    // Restore AMRAP results BEFORE rendering workout plan
                    amrapResults = profile.amrapResults || {};
                    
                    // Restore workout plan
                    if (profile.workoutPlan) {
                        workoutPlan = profile.workoutPlan;
                        renderWorkoutPlan();
                    }
                    
                    // Update UI to show saved week/day
                    setTimeout(() => {
                        // Update week tabs to show correct active state
                        weekTabs.forEach(tab => {
                            tab.classList.toggle('active', tab.dataset.week === currentWeek.toString());
                        });
                        
                        showWeekContent(currentWeek);
                        const activeWeek = document.querySelector(`.week-content[data-week="${currentWeek}"]`);
                        if (activeWeek) {
                            showDayContent(activeWeek, currentDay);
                        }
                    }, 0);
                }
            }

            // Update level display
            function updateLevelDisplay() {
                levelDisplay.textContent = `LVL: ${userLevel}`;
            }

            // Save profile to localStorage
            function saveProfile() {
                const profile = {
                    inputs: {
                        squat: document.getElementById('squat-1rm').value,
                        bench: document.getElementById('bench-1rm').value,
                        deadlift: document.getElementById('deadlift-1rm').value,
                        ohp: document.getElementById('ohp-1rm').value
                    },
                    tmPercentage,
                    accessoryTemplate,
                    workoutPlan,
                    currentWeek,
                    currentDay,
                    userLevel, // Save user level
                    amrapResults // Save AMRAP results
                };
                
                localStorage.setItem('531-workout-profile', JSON.stringify(profile));
            }

            // Configuration objects
            const daysSetup = [
                { day: 1, main: "ohp", name: "Overhead Press Day" },
                { day: 2, main: "deadlift", name: "Deadlift Day" },
                { day: 3, main: "bench", name: "Bench Press Day" },
                { day: 4, main: "squat", name: "Squat Day" }
            ];

            const weekPercentages = {
                1: [
                    { reps: 5, percentage: 65 },
                    { reps: 5, percentage: 75 },
                    { reps: "5+", percentage: 85, amrap: true }
                ],
                2: [
                    { reps: 3, percentage: 70 },
                    { reps: 3, percentage: 80 },
                    { reps: "3+", percentage: 90, amrap: true }
                ],
                3: [
                    { reps: 5, percentage: 75 },
                    { reps: 3, percentage: 85 },
                    { reps: "1+", percentage: 95, amrap: true }
                ],
                4: [
                    { reps: 5, percentage: 40 },
                    { reps: 5, percentage: 50 },
                    { reps: 5, percentage: 60 }
                ]
            };

            const accessoryExercises = {
                standard: {
                    ohp: {
                        push: ["Dips", "Incline Dumbbell Press", "Pushups", "Dumbbell Press"],
                        pull: ["Chin-ups", "Barbell Rows", "Face Pulls", "Cable Rows"],
                        core: ["Ab Wheel", "Hanging Leg Raises", "Planks", "Russian Twists"]
                    },
                    deadlift: {
                        push: ["Push-ups", "Dumbbell Bench Press", "Dips", "Incline Press"],
                        pull: ["Lat Pulldowns", "Face Pulls", "Dumbbell Rows", "Pull-ups"],
                        legs: ["Bulgarian Split Squats", "Lunges", "Leg Curls", "Step-ups"]
                    },
                    bench: {
                        push: ["Close-grip Bench", "Tricep Extensions", "Dips", "Dumbbell Press"],
                        pull: ["Barbell Rows", "Pull-ups", "Face Pulls", "Cable Rows"],
                        core: ["Russian Twists", "Sit-ups", "Planks", "Ab Wheel"]
                    },
                    squat: {
                        push: ["Shoulder Press", "Push-ups", "Tricep Extensions", "Dips"],
                        pull: ["Cable Rows", "Bicep Curls", "Lat Pulldowns", "Face Pulls"],
                        legs: ["Lunges", "Leg Raises", "Glute Bridges", "Bulgarian Split Squats"]
                    }
                },
                bbb: {
                    ohp: { main: "OHP", secondary: "Bench Press" },
                    deadlift: { main: "Deadlift", secondary: "Squat" },
                    bench: { main: "Bench Press", secondary: "OHP" },
                    squat: { main: "Squat", secondary: "Deadlift" }
                },
                fsl: {
                    ohp: { main: "OHP", accessories: ["Dips", "Rows", "Ab Work"] },
                    deadlift: { main: "Deadlift", accessories: ["Leg Curls", "Pulldowns", "Planks"] },
                    bench: { main: "Bench Press", accessories: ["Triceps", "Pull-ups", "Core"] },
                    squat: { main: "Squat", accessories: ["Lunges", "Rows", "Ab Work"] }
                },
                triumvirate: {
                    ohp: {
                        accessories: [
                            { name: "Dips", sets: 5, reps: "10-15" },
                            { name: "Chin-ups", sets: 5, reps: "10-15" }
                        ]
                    },
                    deadlift: {
                        accessories: [
                            { name: "Hanging Leg Raises", sets: 5, reps: "10-15" },
                            { name: "Good Mornings", sets: 5, reps: "10-15" }
                        ]
                    },
                    bench: {
                        accessories: [
                            { name: "Dumbbell Rows", sets: 5, reps: "10-15" },
                            { name: "Incline Dumbbell Press", sets: 5, reps: "10-15" }
                        ]
                    },
                    squat: {
                        accessories: [
                            { name: "Leg Curls", sets: 5, reps: "10-15" },
                            { name: "Ab Wheel", sets: 5, reps: "10-15" }
                        ]
                    }
                },
                beginners: {
                    ohp: {
                        mainFSL: true,
                        accessories: {
                            push: ["Dips", "Push-ups", "Dumbbell Bench", "Incline Press"],
                            pull: ["Chin-ups", "Barbell Rows", "Face Pulls", "Cable Rows"],
                            legs: ["Ab Wheel", "Hanging Leg Raises", "Planks", "Russian Twists"]
                        }
                    },
                    deadlift: {
                        mainFSL: true,
                        accessories: {
                            push: ["Push-ups", "Dips", "Tricep Extensions", "Dumbbell Press"],
                            pull: ["Pull-ups", "Inverted Rows", "Face Pulls", "Lat Pulldowns"],
                            legs: ["Lunges", "Step-ups", "Ab Work", "Bulgarian Split Squats"]
                        }
                    },
                    bench: {
                        mainFSL: true,
                        accessories: {
                            push: ["Dips", "Incline Press", "Lateral Raises", "Close-grip Bench"],
                            pull: ["Pull-ups", "DB Rows", "Face Pulls", "Barbell Rows"],
                            legs: ["Hanging Leg Raises", "Ab Wheel", "Planks", "Sit-ups"]
                        }
                    },
                    squat: {
                        mainFSL: true,
                        accessories: {
                            push: ["Dips", "Push-ups", "DB Press", "Shoulder Press"],
                            pull: ["Pull-ups", "Barbell Rows", "Face Pulls", "Bicep Curls"],
                            legs: ["Leg Curls", "Back Raises", "Ab Work", "Glute Bridges"]
                        }
                    }
                }
            };

            // DOM elements
            const generateButton = document.getElementById('generate-button');
            const printButton = document.getElementById('print-button');
            const weekTabs = document.querySelectorAll('.week-tab');
            const tmOptions = document.querySelectorAll('.toggle-option');
            const accessorySelect = document.getElementById('accessory-template');
            const levelDisplay = document.getElementById('level-display');
            
            // Quiz elements
            const quizButton = document.getElementById('quiz-button');
            const quizModal = document.getElementById('quiz-modal');
            const closeQuiz = document.getElementById('close-quiz');
            const questionText = document.getElementById('question-text');
            const questionContent = document.getElementById('question-content');
            const quizOptions = document.getElementById('quiz-options');
            const progressFill = document.getElementById('progress-fill');
            const progressText = document.getElementById('progress-text');
            const prevButton = document.getElementById('prev-question');
            const nextButton = document.getElementById('next-question');
            
            // Quiz data and state
            let currentQuestion = 0;
            let quizAnswers = [];
            
            const quizData = [
                {
                    question: "What's your primary training goal?",
                    options: [
                        { text: "Build muscle mass and size", scores: { bbb: 3, standard: 2, fsl: 1, triumvirate: 1, beginners: 1 } },
                        { text: "Increase strength and power", scores: { fsl: 3, standard: 2, bbb: 1, triumvirate: 2, beginners: 2 } },
                        { text: "General fitness and conditioning", scores: { standard: 3, triumvirate: 2, fsl: 1, bbb: 1, beginners: 2 } },
                        { text: "I'm new to 5/3/1 and need structure", scores: { beginners: 3, standard: 2, fsl: 1, bbb: 1, triumvirate: 1 } }
                    ]
                },
                {
                    question: "How much time do you have for accessory work?",
                    options: [
                        { text: "30+ minutes - I want maximum volume", scores: { bbb: 3, beginners: 2, standard: 2, fsl: 1, triumvirate: 1 } },
                        { text: "20-30 minutes - moderate volume", scores: { standard: 3, fsl: 2, triumvirate: 2, bbb: 1, beginners: 1 } },
                        { text: "15-20 minutes - focused work", scores: { triumvirate: 3, fsl: 2, standard: 1, bbb: 1, beginners: 1 } },
                        { text: "10-15 minutes - minimal but effective", scores: { fsl: 3, triumvirate: 2, standard: 1, bbb: 1, beginners: 1 } }
                    ]
                },
                {
                    question: "What's your experience level with 5/3/1?",
                    options: [
                        { text: "Complete beginner to 5/3/1", scores: { beginners: 3, standard: 2, fsl: 1, bbb: 1, triumvirate: 1 } },
                        { text: "Some experience, still learning", scores: { standard: 3, fsl: 2, beginners: 2, bbb: 1, triumvirate: 1 } },
                        { text: "Intermediate - comfortable with the program", scores: { fsl: 3, bbb: 2, standard: 2, triumvirate: 2, beginners: 1 } },
                        { text: "Advanced - ready for challenging variations", scores: { bbb: 3, fsl: 2, triumvirate: 2, standard: 1, beginners: 1 } }
                    ]
                },
                {
                    question: "How do you prefer to structure your accessory work?",
                    options: [
                        { text: "Same movement as main lift (more volume)", scores: { bbb: 3, fsl: 2, standard: 1, triumvirate: 1, beginners: 1 } },
                        { text: "Related movements at same intensity", scores: { fsl: 3, standard: 2, bbb: 1, triumvirate: 1, beginners: 2 } },
                        { text: "Variety of movements for balance", scores: { standard: 3, triumvirate: 2, fsl: 1, bbb: 1, beginners: 2 } },
                        { text: "Minimal, focused movements", scores: { triumvirate: 3, fsl: 2, standard: 1, bbb: 1, beginners: 1 } }
                    ]
                },
                {
                    question: "What's your recovery capacity?",
                    options: [
                        { text: "Excellent - I recover quickly", scores: { bbb: 3, beginners: 2, standard: 2, fsl: 1, triumvirate: 1 } },
                        { text: "Good - moderate volume works well", scores: { standard: 3, fsl: 2, triumvirate: 2, bbb: 1, beginners: 1 } },
                        { text: "Average - need to manage fatigue", scores: { fsl: 3, triumvirate: 2, standard: 2, bbb: 1, beginners: 1 } },
                        { text: "Limited - prefer lower volume", scores: { triumvirate: 3, fsl: 2, standard: 1, bbb: 1, beginners: 1 } }
                    ]
                }
            ];
            
            // Event listeners
            generateButton.addEventListener('click', () => {
                generateWorkoutPlan();
                saveProfile();
            });
            
            // Add delete profile functionality
            const deleteProfileButton = document.getElementById('delete-profile-button');
            deleteProfileButton.addEventListener('click', () => {
                if (confirm('Are you sure you want to delete your saved workout profile? This cannot be undone.')) {
                    localStorage.removeItem('531-workout-profile');
                    // Reset form values
                    document.getElementById('squat-1rm').value = '';
                    document.getElementById('bench-1rm').value = '';
                    document.getElementById('deadlift-1rm').value = '';
                    document.getElementById('ohp-1rm').value = '';
                    // Reset user level
                    userLevel = 1;
                    updateLevelDisplay();
                    // Reset AMRAP results
                    amrapResults = {};
                    // Reset workout plan
                    workoutPlan = {};
                    // Reset UI
                    renderWorkoutPlan();
                    showWeekContent(1);
                    alert('Workout profile has been deleted.');
                }
            });
            
            printButton.addEventListener('click', () => { window.print(); });
            
            weekTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    weekTabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    currentWeek = parseInt(tab.dataset.week);
                    showWeekContent(currentWeek);
                    saveProfile();
                });
            });
            
            tmOptions.forEach(option => {
                option.addEventListener('click', () => {
                    tmOptions.forEach(o => o.classList.remove('active'));
                    option.classList.add('active');
                    tmPercentage = parseInt(option.dataset.value);
                    saveProfile();
                });
            });
            
            accessorySelect.addEventListener('change', () => {
                accessoryTemplate = accessorySelect.value;
                
                // If workout plan already exists, regenerate it with new accessory template
                if (workoutPlan.weeks && Object.keys(workoutPlan.weeks).length > 0) {
                    generateWorkoutPlan();
                }
                
                saveProfile();
            });

            // Add event delegation for day tabs with profile saving
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('day-tab')) {
                    const weekContent = e.target.closest('.week-content');
                    currentDay = parseInt(e.target.dataset.day);
                    showDayContent(weekContent, currentDay);
                    saveProfile();
                }
            });

            // Load saved profile on page load
            loadProfile();
            
            // Helper functions
            function round5(num) {
                return Math.round(num / 5) * 5;
            }
            
            function generateWarmupSets(exerciseTM) {
                return [
                    { reps: 5, weight: round5(exerciseTM * 0.4) },
                    { reps: 5, weight: round5(exerciseTM * 0.5) },
                    { reps: 3, weight: round5(exerciseTM * 0.6) }
                ];
            }
            
            function calculateWorkingWeight(oneRM, tmPercent, weekPercent) {
                const trainingMax = oneRM * (tmPercent / 100);
                return round5(trainingMax * (weekPercent / 100));
            }
            
            // Main function to generate workout plan
            function generateWorkoutPlan() {
                // Store current UI state before regenerating (if workout plan already exists)
                let savedWeek = currentWeek;
                let savedDay = currentDay;
                if (workoutPlan.weeks && Object.keys(workoutPlan.weeks).length > 0) {
                    const currentWeekElement = document.querySelector('.week-tab.active');
                    const currentDayElement = document.querySelector('.day-tab.active');
                    savedWeek = currentWeekElement ? parseInt(currentWeekElement.dataset.week) : currentWeek;
                    savedDay = currentDayElement ? parseInt(currentDayElement.dataset.day) : currentDay;
                }
                
                // Get 1RM values
                const squat1RM = parseFloat(document.getElementById('squat-1rm').value) || 0;
                const bench1RM = parseFloat(document.getElementById('bench-1rm').value) || 0;
                const deadlift1RM = parseFloat(document.getElementById('deadlift-1rm').value) || 0;
                const ohp1RM = parseFloat(document.getElementById('ohp-1rm').value) || 0;
                
                if (squat1RM === 0 && bench1RM === 0 && deadlift1RM === 0 && ohp1RM === 0) {
                    alert('Please enter at least one 1RM value.');
                    return;
                }
                
                // Calculate Training Maxes
                const squatTM = squat1RM * (tmPercentage / 100);
                const benchTM = bench1RM * (tmPercentage / 100);
                const deadliftTM = deadlift1RM * (tmPercentage / 100);
                const ohpTM = ohp1RM * (tmPercentage / 100);
                
                // Week percentages
                // Create workout plan structure
                workoutPlan = {
                    weeks: {},
                    trainingMaxes: {
                        squat: round5(squatTM),
                        bench: round5(benchTM),
                        deadlift: round5(deadliftTM),
                        ohp: round5(ohpTM)
                    }
                };
                
                // Generate workout plan for each week
                for (let week = 1; week <= 4; week++) {
                    workoutPlan.weeks[week] = [];
                    
                    daysSetup.forEach(daySetup => {
                        const { day, main, name } = daySetup;
                        const exerciseTM = workoutPlan.trainingMaxes[main];
                        
                        if (exerciseTM === 0) return; // Skip if no 1RM entered
                        
                        const dayPlan = {
                            day,
                            name,
                            mainLift: { 
                                name: main.charAt(0).toUpperCase() + main.slice(1),
                                tm: exerciseTM,
                                warmup: generateWarmupSets(exerciseTM),
                                sets: []
                            },
                            accessories: []
                        };
                        
                        // Add main lift sets based on week percentages
                        weekPercentages[week].forEach(set => {
                            dayPlan.mainLift.sets.push({
                                reps: set.reps,
                                weight: round5(exerciseTM * (set.percentage / 100)),
                                percentage: set.percentage,
                                amrap: set.amrap || false
                            });
                        });
                        
                        // Add accessories based on template
                        if (accessoryTemplate === 'standard') {
                            const exercises = accessoryExercises.standard[main];
                            const accessoryReps = week === 4 ? '10-25 total reps (deload - may skip entirely)' : '25-50 total reps';
                            
                            // Select exercise based on day (0-3 index, cycling through 4 exercises)
                            const exerciseIndex = (day - 1) % 4;
                            
                            dayPlan.accessories = [
                                { type: 'Push', exercise: exercises.push[exerciseIndex], reps: accessoryReps },
                                { type: 'Pull', exercise: exercises.pull[exerciseIndex], reps: accessoryReps },
                                { type: exercises.core ? 'Core' : 'Legs', exercise: (exercises.core || exercises.legs)[exerciseIndex], reps: accessoryReps }
                            ];
                        } else if (accessoryTemplate === 'bbb') {
                            const bbbExercise = accessoryExercises.bbb[main];
                            const bbbWeight = round5(exerciseTM * 0.5); // 50% TM for BBB
                            
                            // Reduce BBB volume during deload week
                            const bbbSets = week === 4 ? '3 sets of 10 reps (deload - may skip entirely)' : '5 sets of 10 reps';
                            
                            dayPlan.accessories = [
                                { 
                                    type: 'Boring But Big', 
                                    exercise: bbbExercise.main, 
                                    sets: bbbSets, 
                                    weight: bbbWeight
                                },
                                { 
                                    type: 'Supplemental',
                                    exercise: bbbExercise.secondary,
                                    sets: week === 4 ? 'Optional - consider skipping' : '3-5 sets of 10-20 reps'
                                }
                            ];
                        } else if (accessoryTemplate === 'fsl') {
                            // First set last - use first working set weight for 5x5
                            const fslWeight = round5(exerciseTM * (weekPercentages[week][0].percentage / 100));
                            const fslExercises = accessoryExercises.fsl[main];
                            
                            // Reduce FSL volume during deload week
                            const fslSets = week === 4 ? '1-2 sets of 5 reps (deload - may skip entirely)' : '5 sets of 5 reps';
                            const supplementalReps = week === 4 ? 'Optional - consider skipping' : '50-100 total reps';
                            
                            dayPlan.accessories = [
                                {
                                    type: 'First Set Last',
                                    exercise: fslExercises.main,
                                    sets: fslSets,
                                    weight: fslWeight
                                },
                                {
                                    type: 'Supplemental Work',
                                    exercises: fslExercises.accessories,
                                    reps: supplementalReps
                                }
                            ];
                        } else if (accessoryTemplate === 'triumvirate') {
                            const triumvirateExercises = accessoryExercises.triumvirate[main];
                            
                            // Reduce Triumvirate volume during deload week
                            if (week === 4) {
                                // Show only first accessory with reduced sets
                                dayPlan.accessories = [
                                    {
                                        name: triumvirateExercises.accessories[0].name,
                                        sets: '2-3 sets of 10-15 reps (deload - may skip entirely)',
                                        reps: '10-15'
                                    }
                                ];
                            } else {
                                dayPlan.accessories = triumvirateExercises.accessories;
                            }
                        } else if (accessoryTemplate === 'beginners') {
                            // First set last - use first working set weight for 5x5
                            const fslWeight = round5(exerciseTM * (weekPercentages[week][0].percentage / 100));
                            const beginnerExercises = accessoryExercises.beginners[main];
                            
                            dayPlan.fslWeight = fslWeight; // Store for rendering
                            
                            // Reduce Beginners template volume during deload week
                            const accessoryReps = week === 4 ? '25-50 total reps (deload - may skip entirely)' : '50-100 total reps';
                            const fslSets = week === 4 ? 'Skip FSL during deload' : '5 sets of 5 reps';
                            
                            // Select exercise based on day (0-3 index, cycling through 4 exercises)
                            const exerciseIndex = (day - 1) % 4;
                            
                            // Ensure the accessories property has properly structured data
                            try {
                                dayPlan.accessories = [
                                    {
                                        type: 'First Set Last',
                                        exercise: main.charAt(0).toUpperCase() + main.slice(1),
                                        sets: fslSets,
                                        weight: fslWeight
                                    },
                                    {
                                        type: 'Push',
                                        exercise: (beginnerExercises.accessories.push || ['Push exercises'])[exerciseIndex],
                                        reps: accessoryReps
                                    },
                                    {
                                        type: 'Pull',
                                        exercise: (beginnerExercises.accessories.pull || ['Pull exercises'])[exerciseIndex],
                                        reps: accessoryReps
                                    },
                                    {
                                        type: 'Legs/Core',
                                        exercise: (beginnerExercises.accessories.legs || ['Legs/Core exercises'])[exerciseIndex],
                                        reps: accessoryReps
                                    }
                                ];
                            } catch (error) {
                                // Fallback if there's any issue with the data structure
                                console.error('Error setting up accessories for beginners template:', error);
                                dayPlan.accessories = [
                                    { type: 'First Set Last', exercise: main.charAt(0).toUpperCase() + main.slice(1), sets: fslSets, weight: fslWeight },
                                    { type: 'Push', exercise: 'Push exercises', reps: accessoryReps },
                                    { type: 'Pull', exercise: 'Pull exercises', reps: accessoryReps },
                                    { type: 'Legs/Core', exercise: 'Legs/Core exercises', reps: accessoryReps }
                                ];
                            }
                        }
                        
                        workoutPlan.weeks[week].push(dayPlan);
                    });
                }
                
                // Render workout plan
                renderWorkoutPlan();
                
                // Restore the UI state if we had a previous workout plan, otherwise show week 1
                if (workoutPlan.weeks && Object.keys(workoutPlan.weeks).length > 0) {
                    setTimeout(() => {
                        // Update week tabs
                        weekTabs.forEach(tab => {
                            tab.classList.toggle('active', tab.dataset.week === savedWeek.toString());
                        });
                        
                        // Show the correct week content
                        showWeekContent(savedWeek);
                        
                        // Show the correct day content
                        const activeWeek = document.querySelector(`.week-content[data-week="${savedWeek}"]`);
                        if (activeWeek) {
                            showDayContent(activeWeek, savedDay);
                        }
                        
                        // Update current tracking variables
                        currentWeek = savedWeek;
                        currentDay = savedDay;
                    }, 0);
                } else {
                    // Show week 1 by default for new workout plans
                    showWeekContent(1);
                }
            }
            
            // Function to safely join an array or return a default string
            function safeJoin(arr, separator, defaultText) {
                if (Array.isArray(arr) && arr.length > 0) {
                    return arr.join(separator);
                }
                return defaultText || 'Not specified';
            }
            
            // Check if all AMRAP sets have been logged
            function areAllAmrapSetsLogged() {
                // Get the exercises that have 1RM values (are being used)
                const exercises = [];
                if (parseFloat(document.getElementById('squat-1rm').value) > 0) exercises.push('squat');
                if (parseFloat(document.getElementById('bench-1rm').value) > 0) exercises.push('bench');
                if (parseFloat(document.getElementById('deadlift-1rm').value) > 0) exercises.push('deadlift');
                if (parseFloat(document.getElementById('ohp-1rm').value) > 0) exercises.push('ohp');
                
                // Check if all exercises have logged AMRAP results
                return exercises.every(exercise => amrapResults[exercise] && amrapResults[exercise].reps !== undefined);
            }
            
            // Generate level up buttons with validation
            function generateLevelUpButtons() {
                const allLogged = areAllAmrapSetsLogged();
                const missingExercises = [];
                
                // Find which exercises are missing AMRAP logs
                ['squat', 'bench', 'deadlift', 'ohp'].forEach(exercise => {
                    const has1RM = parseFloat(document.getElementById(`${exercise}-1rm`).value) > 0;
                    const hasLogged = amrapResults[exercise] && amrapResults[exercise].reps !== undefined;
                    if (has1RM && !hasLogged) {
                        missingExercises.push(exercise.toUpperCase());
                    }
                });
                
                let html = '';
                
                if (allLogged) {
                    html += '<button id="level-up-button" class="level-up-button" style="width: 100%; margin-top: 1rem;">LEVEL UP! (Complete Cycle & Increase Weights)</button>';
                } else {
                    html += '<button id="level-up-button" class="level-up-button" disabled style="opacity: 0.5; cursor: not-allowed; width: 100%; margin-top: 1rem;">LEVEL UP! (Log Week 3 AMRAP Sets First)</button>';
                    html += `<div class="notes" style="margin-top: 1rem; background-color: #fff3e1; border-left-color: #ff9800;">
                        <p><strong>⚠️ Cannot Level Up Yet</strong></p>
                        <p>Please log your Week 3 AMRAP performance for: <strong>${missingExercises.join(', ')}</strong></p>
                        <p>Go to Week 3, complete your 1+ sets, and log your results to unlock progression.</p>
                    </div>`;
                }
                
                return html;
            }
            
            // Function to render workout plan
            function renderWorkoutPlan() {
                const resultsContainer = document.getElementById('workout-results');
                
                if (!workoutPlan.weeks || Object.keys(workoutPlan.weeks).length === 0) {
                    resultsContainer.innerHTML = '<p>Enter your 1-rep max values and click "Generate Workout Plan" to create your personalized 5/3/1 program.</p>';
                    return;
                }
                
                let html = '';
                
                // Create HTML for each week
                for (let week = 1; week <= 4; week++) {
                    let weekName = '';
                    switch(week) {
                        case 1: weekName = '5/5/5+'; break;
                        case 2: weekName = '3/3/3+'; break;
                        case 3: weekName = '5/3/1+'; break;
                        case 4: weekName = 'Deload'; break;
                    }
                    
                    html += `<div class="week-content ${week === 1 ? 'active' : ''}" data-week="${week}">`;
                    html += `<h3>Week ${week} (${weekName})</h3>`;
                    
                    if (workoutPlan.weeks[week].length === 0) {
                        html += '<p>Please enter at least one 1RM value to generate workout days.</p>';
                    } else {
                        // Add day tabs
                        html += '<div class="day-tabs">';
                        workoutPlan.weeks[week].forEach((day, dayIndex) => {
                            html += `<div class="day-tab ${dayIndex === 0 ? 'active' : ''}" data-day="${dayIndex}">Day ${day.day}</div>`;
                        });
                        html += '</div>';
                        
                        // Add day content container
                        html += '<div class="day-contents">';
                        workoutPlan.weeks[week].forEach((day, dayIndex) => {
                            const isLastDayOfCycle = (week === 4 && dayIndex === workoutPlan.weeks[week].length - 1);
                            
                            html += `
                            <div class="day-content ${dayIndex === 0 ? 'active' : ''}" data-day="${dayIndex}">
                                <div class="day-card">
                                    <div class="day-header">Day ${day.day}: ${day.name}</div>
                                    
                                    <div class="warm-up-section">
                                        <h4>Warm-up Sets</h4>
                                        <table class="warm-up-table">
                                            <tr>
                                                <td>5 reps × ${day.mainLift.warmup[0].weight} lbs (40%)</td>
                                                <td>5 reps × ${day.mainLift.warmup[1].weight} lbs (50%)</td>
                                                <td>3 reps × ${day.mainLift.warmup[2].weight} lbs (60%)</td>
                                            </tr>
                                        </table>
                                    </div>
                                    
                                    <h4>Main Lift: ${day.mainLift.name}</h4>
                                    <table class="exercise-table">
                                        <thead>
                                            <tr>
                                                <th>Set</th>
                                                <th>Weight (lbs)</th>
                                                <th>Reps</th>
                                                <th>% of TM</th>
                                            </tr>
                                        </thead>
                                        <tbody>`;
                            
                            day.mainLift.sets.forEach((set, index) => {
                                html += `
                                    <tr>
                                        <td>Set ${index + 1}</td>
                                        <td>${set.weight}</td>
                                        <td class="${set.amrap ? 'amrap-set' : ''}">${set.reps}${set.amrap ? ' (AMRAP)' : ''}</td>
                                        <td>${set.percentage}%</td>
                                    </tr>`;
                            });
                            
                            html += `
                                        </tbody>
                                    </table>`;
                            
                            // Add AMRAP logging section for Week 3 only
                            if (week === 3) {
                                const exerciseName = day.mainLift.name.toLowerCase();
                                const amrapData = amrapResults[exerciseName] || {};
                                const hasLogged = amrapData.reps !== undefined;
                                
                                html += `
                                    <div class="amrap-logging">
                                        <h4>📊 Log Your AMRAP Performance (Wendler Philosophy)</h4>
                                        <p style="margin-bottom: 1rem; font-size: 0.95rem;">
                                            Your performance on this 1+ set determines your progression for the next cycle.
                                        </p>`;
                                
                                if (hasLogged) {
                                    html += `
                                        <div class="amrap-status logged">
                                            <strong>✓ Logged:</strong> ${amrapData.reps} reps completed | 
                                            <strong>Decision:</strong> ${amrapData.decision}
                                        </div>
                                        <button id="amrap-undo-${exerciseName}" class="amrap-submit-btn" style="background-color: var(--accent);">
                                            Undo Decision
                                        </button>`;
                                } else {
                                    html += `
                                        <div class="amrap-input-group">
                                            <label for="amrap-reps-${exerciseName}">Reps completed on 1+ set:</label>
                                            <input type="number" id="amrap-reps-${exerciseName}" min="0" max="20" placeholder="0">
                                        </div>
                                        
                                        <div id="amrap-recommendations-${exerciseName}" class="amrap-recommendations" style="display: none;">
                                            <!-- Options will be populated by JavaScript -->
                                        </div>
                                        
                                        <button id="amrap-submit-${exerciseName}" class="amrap-submit-btn" style="display: none;">
                                            Apply Progression Decision
                                        </button>`;
                                }
                                
                                html += `
                                    </div>`;
                            }
                            
                            html += `
                                    <div class="accessory-section">
                                        <h4>Accessory Work</h4>`;
                            
                            if (accessoryTemplate === 'standard') {
                                html += `<ul class="accessory-list">`;
                                day.accessories.forEach(accessory => {
                                    html += `
                                        <li>
                                            <span><strong>${accessory.type}:</strong> ${accessory.exercise}</span>
                                            <span>${accessory.reps}</span>
                                        </li>`;
                                });
                                html += `</ul>`;
                            } else if (accessoryTemplate === 'bbb') {
                                html += `<ul class="accessory-list">
                                    <li>
                                        <span><strong>${day.accessories[0].type}:</strong> ${day.accessories[0].exercise}</span>
                                        <span>${day.accessories[0].sets} @ ${day.accessories[0].weight} lbs</span>
                                    </li>
                                    <li>
                                        <span><strong>Supplemental:</strong> ${day.accessories[1].exercise}</span>
                                        <span>${day.accessories[1].sets}</span>
                                    </li>
                                </ul>`;
                            } else if (accessoryTemplate === 'fsl') {
                                html += `<ul class="accessory-list">
                                    <li>
                                        <span><strong>${day.accessories[0].type}:</strong> ${day.accessories[0].exercise}</span>
                                        <span>${day.accessories[0].sets} @ ${day.accessories[0].weight} lbs</span>
                                    </li>
                                    <li>
                                        <span><strong>${day.accessories[1].type}:</strong> ${safeJoin(day.accessories[1].exercises, ', ')}</span>
                                        <span>${day.accessories[1].reps}</span>
                                    </li>
                                </ul>`;
                            } else if (accessoryTemplate === 'triumvirate') {
                                html += `<ul class="accessory-list">`;
                                day.accessories.forEach(accessory => {
                                    html += `
                                        <li>
                                            <span><strong>${accessory.name}</strong></span>
                                            <span>${accessory.sets} sets of ${accessory.reps} reps</span>
                                        </li>`;
                                });
                                html += `</ul>`;
                            } else if (accessoryTemplate === 'beginners') {
                                html += `<ul class="accessory-list">`;
                                
                                // Handle FSL work
                                const fslAccessory = day.accessories.find(acc => acc.type === 'First Set Last');
                                if (fslAccessory) {
                                    html += `
                                        <li>
                                            <span><strong>First Set Last:</strong> ${fslAccessory.exercise}</span>
                                            <span>${fslAccessory.sets}${fslAccessory.weight ? ' @ ' + fslAccessory.weight + ' lbs' : ''}</span>
                                        </li>`;
                                }
                                
                                // Handle other accessories
                                const otherAccessories = day.accessories.filter(acc => acc.type !== 'First Set Last');
                                otherAccessories.forEach(accessory => {
                                    html += `
                                        <li>
                                            <span><strong>${accessory.type}:</strong> ${accessory.exercise}</span>
                                            <span>${accessory.reps}</span>
                                        </li>`;
                                });
                                
                                html += `</ul>`;
                            }
                            
                            html += `
                                    </div>
                                    
                                    <div class="notes">
                                        <p>Notes:</p>
                                        <ul>
                                            <li>AMRAP = As Many Reps As Possible (with good form)</li>
                                            <li>Rest 2-3 minutes between main lift sets</li>
                                            <li>Rest 60-90 seconds between accessory sets</li>
                                            <li>Accessory work should be done at 7-8 RPE (Rate of Perceived Exertion)</li>
                                            <li>Leave 2-3 reps in reserve on accessory sets - focus on quality over max weight</li>
                                            <li>Increase weight only when you can complete all reps with good form</li>
                                        </ul>
                                    </div>
                                    
                                    ${isLastDayOfCycle ? generateLevelUpButtons() : ''}
                                </div>
                            </div>`;
                        });
                        html += '</div>'; // Close day-contents
                    }
                    
                    html += '</div>'; // Close week-content
                }
                
                resultsContainer.innerHTML = html;
                
                // Add event listeners for level up button
                const levelUpButton = document.getElementById('level-up-button');
                if (levelUpButton) {
                    levelUpButton.addEventListener('click', levelUp);
                }
                
                // Add event listeners for AMRAP logging
                setupAmrapListeners();
            }
            
            // Function to show specific week content
            function showWeekContent(weekNum) {
                const weekContents = document.querySelectorAll('.week-content');
                weekContents.forEach(content => {
                    content.classList.toggle('active', content.dataset.week === weekNum.toString());
                });
                
                // Show first day of the selected week
                const activeWeek = document.querySelector(`.week-content[data-week="${weekNum}"]`);
                if (activeWeek) {
                    const firstDayTab = activeWeek.querySelector('.day-tab');
                    if (firstDayTab) {
                        showDayContent(activeWeek, 0);
                    }
                }
            }
            
            // Function to show specific day content
            function showDayContent(weekElement, dayIndex) {
                const dayTabs = weekElement.querySelectorAll('.day-tab');
                const dayContents = weekElement.querySelectorAll('.day-content');
                
                dayTabs.forEach(tab => {
                    tab.classList.toggle('active', tab.dataset.day === dayIndex.toString());
                });
                
                dayContents.forEach(content => {
                    content.classList.toggle('active', content.dataset.day === dayIndex.toString());
                });
            }

            // Add explanation functionality for accessory templates
            const accessoryTemplateSelect = document.getElementById('accessory-template');
            const accessoryExplanation = document.getElementById('accessory-explanation');
            
            // Template explanations
            const explanations = {
                'standard': 'The Standard template focuses on balanced development with 25-50 reps each of pushing, pulling, and core exercises. This provides a well-rounded approach to assistance work that complements the main lifts without excessive fatigue.',
                
                'bbb': 'Boring But Big (BBB) is one of Wendler\'s most popular templates. It adds 5 sets of 10 reps at 50-60% of your training max for the same lift or a complementary lift after your main work. BBB builds muscle mass and work capacity while reinforcing proper movement patterns.',
                
                'fsl': 'First Set Last (FSL) uses the weight from your first work set (the 5 reps set) for 5 additional sets of 5 reps. This provides additional volume at a moderate intensity, helping to build strength and reinforce technique without excessive fatigue.',
                
                'triumvirate': 'The Triumvirate template prescribes two assistance exercises per main lift, each performed for 5 sets of 10-15 reps. This focused approach targets specific muscle groups that support your main lifts, providing balanced development with moderate volume.',
                
                'beginners': '5/3/1 for Beginners combines FSL work (5 sets of 5 reps at your first set weight) with specific push, pull, and single-leg/core accessories (50 reps each). This template is designed to build a foundation of strength and work capacity for those new to the program.'
            };
            
            // Function to update the explanation based on selected template
            function updateExplanation() {
                const selectedTemplate = accessoryTemplateSelect.value;
                accessoryExplanation.textContent = explanations[selectedTemplate] || '';
            }
            
            // Set initial explanation
            updateExplanation();
            
            // Update explanation when template changes
            accessoryTemplateSelect.addEventListener('change', updateExplanation);
            
            // Quiz functionality
            function showQuiz() {
                quizModal.style.display = 'flex';
                currentQuestion = 0;
                quizAnswers = [];
                displayQuestion();
            }
            
            function hideQuiz() {
                quizModal.style.display = 'none';
            }
            
            function displayQuestion() {
                const question = quizData[currentQuestion];
                questionText.textContent = `Question ${currentQuestion + 1} of ${quizData.length}`;
                questionContent.textContent = question.question;
                
                // Clear previous options
                quizOptions.innerHTML = '';
                
                // Add new options
                question.options.forEach((option, index) => {
                    const optionElement = document.createElement('div');
                    optionElement.className = 'quiz-option';
                    optionElement.textContent = option.text;
                    optionElement.dataset.index = index;
                    
                    // Check if this option was previously selected
                    if (quizAnswers[currentQuestion] === index) {
                        optionElement.classList.add('selected');
                    }
                    
                    optionElement.addEventListener('click', () => {
                        // Remove selection from other options
                        quizOptions.querySelectorAll('.quiz-option').forEach(opt => opt.classList.remove('selected'));
                        // Add selection to clicked option
                        optionElement.classList.add('selected');
                        // Store answer
                        quizAnswers[currentQuestion] = index;
                        // Enable next button
                        nextButton.disabled = false;
                    });
                    
                    quizOptions.appendChild(optionElement);
                });
                
                // Update progress
                const progress = ((currentQuestion + 1) / quizData.length) * 100;
                progressFill.style.width = `${progress}%`;
                progressText.textContent = `${currentQuestion + 1}/${quizData.length}`;
                
                // Update navigation buttons
                prevButton.disabled = currentQuestion === 0;
                nextButton.disabled = quizAnswers[currentQuestion] === undefined;
                
                // Update next button text
                if (currentQuestion === quizData.length - 1) {
                    nextButton.textContent = 'Get My Recommendation';
                } else {
                    nextButton.textContent = 'Next';
                }
            }
            
            function calculateRecommendation() {
                const scores = { standard: 0, bbb: 0, fsl: 0, triumvirate: 0, beginners: 0 };
                
                // Calculate total scores
                quizAnswers.forEach((answerIndex, questionIndex) => {
                    const option = quizData[questionIndex].options[answerIndex];
                    Object.keys(scores).forEach(template => {
                        scores[template] += option.scores[template];
                    });
                });
                
                // Find the template with the highest score
                const recommendation = Object.keys(scores).reduce((a, b) => scores[a] > scores[b] ? a : b);
                
                return recommendation;
            }
            
            function showRecommendation() {
                const recommendation = calculateRecommendation();
                const templateNames = {
                    standard: 'Standard Template',
                    bbb: 'Boring But Big (BBB)',
                    fsl: 'First Set Last (FSL)',
                    triumvirate: 'Triumvirate',
                    beginners: '5/3/1 for Beginners'
                };
                
                // Update the select dropdown
                accessorySelect.value = recommendation;
                accessoryTemplate = recommendation;
                
                // Update explanation
                updateExplanation();
                
                // If workout plan exists, regenerate it
                if (workoutPlan.weeks && Object.keys(workoutPlan.weeks).length > 0) {
                    generateWorkoutPlan();
                }
                
                // Save profile
                saveProfile();
                
                // Hide quiz
                hideQuiz();
                
                // Show success message
                alert(`Based on your answers, we recommend the ${templateNames[recommendation]}! Your workout plan has been updated.`);
            }
            
            // Quiz event listeners
            quizButton.addEventListener('click', showQuiz);
            closeQuiz.addEventListener('click', hideQuiz);
            
            // Close quiz when clicking outside
            quizModal.addEventListener('click', (e) => {
                if (e.target === quizModal) {
                    hideQuiz();
                }
            });
            
            prevButton.addEventListener('click', () => {
                if (currentQuestion > 0) {
                    currentQuestion--;
                    displayQuestion();
                }
            });
            
            nextButton.addEventListener('click', () => {
                if (currentQuestion < quizData.length - 1) {
                    currentQuestion++;
                    displayQuestion();
                } else {
                    showRecommendation();
                }
            });

            // Setup AMRAP logging event listeners
            function setupAmrapListeners() {
                const exercises = ['squat', 'bench', 'deadlift', 'ohp'];
                
                exercises.forEach(exercise => {
                    const repsInput = document.getElementById(`amrap-reps-${exercise}`);
                    if (repsInput) {
                        repsInput.addEventListener('input', () => {
                            const reps = parseInt(repsInput.value);
                            if (reps >= 0) {
                                showAmrapOptions(exercise, reps);
                            } else {
                                hideAmrapOptions(exercise);
                            }
                        });
                    }
                    
                    // Setup undo button if it exists
                    const undoBtn = document.getElementById(`amrap-undo-${exercise}`);
                    if (undoBtn) {
                        undoBtn.addEventListener('click', () => {
                            undoAmrapDecision(exercise);
                        });
                    }
                });
            }
            
            // Show AMRAP progression options based on reps
            function showAmrapOptions(exercise, reps) {
                const recommendationsDiv = document.getElementById(`amrap-recommendations-${exercise}`);
                const submitBtn = document.getElementById(`amrap-submit-${exercise}`);
                
                if (!recommendationsDiv || !submitBtn) return;
                
                let optionsHtml = '<p style="margin-bottom: 0.75rem; font-weight: 600;">Choose your progression:</p>';
                
                if (reps >= 5) {
                    // 5+ reps: Earned the increase
                    const isUpperBody = exercise === 'bench' || exercise === 'ohp';
                    const increase = isUpperBody ? 5 : 10;
                    
                    optionsHtml += `
                        <div class="amrap-option recommended" onclick="selectAmrapOption('${exercise}', 'earned', ${increase})">
                            <input type="radio" name="amrap-${exercise}" value="earned">
                            <div class="amrap-option-content">
                                <div class="amrap-option-title">
                                    ✅ Earned Increase (+${increase} lbs)
                                    <span class="recommendation-badge badge-recommended">RECOMMENDED</span>
                                </div>
                                <div class="amrap-option-description">
                                    Perfect! Your TM is set correctly. Add ${increase} lbs for next cycle.
                                </div>
                            </div>
                        </div>`;
                } else if (reps >= 2 && reps <= 4) {
                    // 2-4 reps: Warning zone
                    const isUpperBody = exercise === 'bench' || exercise === 'ohp';
                    const increase = isUpperBody ? 5 : 10;
                    
                    optionsHtml += `
                        <div class="amrap-option warning" onclick="selectAmrapOption('${exercise}', 'smart', 0)">
                            <input type="radio" name="amrap-${exercise}" value="smart">
                            <div class="amrap-option-content">
                                <div class="amrap-option-title">
                                    🟡 Smart: Keep Same Weight (0 lbs)
                                    <span class="recommendation-badge badge-recommended">RECOMMENDED</span>
                                </div>
                                <div class="amrap-option-description">
                                    Your TM is getting heavy. Repeat the cycle with the same weight and beat your reps.
                                </div>
                            </div>
                        </div>
                        <div class="amrap-option warning" onclick="selectAmrapOption('${exercise}', 'aggressive', ${increase})">
                            <input type="radio" name="amrap-${exercise}" value="aggressive">
                            <div class="amrap-option-content">
                                <div class="amrap-option-title">
                                    ⚡ Aggressive: Add Weight (+${increase} lbs)
                                    <span class="recommendation-badge badge-warning">RISKY</span>
                                </div>
                                <div class="amrap-option-description">
                                    Warning: Next cycle will be very difficult. Only choose if you're confident.
                                </div>
                            </div>
                        </div>`;
                } else if (reps >= 0 && reps <= 1) {
                    // 0-1 rep: Failed - must decrease
                    optionsHtml += `
                        <div class="amrap-option danger" onclick="selectAmrapOption('${exercise}', 'decrease', -10)">
                            <input type="radio" name="amrap-${exercise}" value="decrease">
                            <div class="amrap-option-content">
                                <div class="amrap-option-title">
                                    🔴 Decrease TM (-10%)
                                    <span class="recommendation-badge badge-danger">REQUIRED</span>
                                </div>
                                <div class="amrap-option-description">
                                    Your TM is too high. You must lower it by 10% before starting the next cycle.
                                </div>
                            </div>
                        </div>`;
                }
                
                recommendationsDiv.innerHTML = optionsHtml;
                recommendationsDiv.style.display = 'block';
                submitBtn.style.display = 'block';
            }
            
            // Hide AMRAP options
            function hideAmrapOptions(exercise) {
                const recommendationsDiv = document.getElementById(`amrap-recommendations-${exercise}`);
                const submitBtn = document.getElementById(`amrap-submit-${exercise}`);
                
                if (recommendationsDiv) recommendationsDiv.style.display = 'none';
                if (submitBtn) submitBtn.style.display = 'none';
            }
            
            // Global variable to track selected option
            let selectedAmrapOptions = {};
            
            // Select AMRAP option
            function selectAmrapOption(exercise, decision, weightChange) {
                selectedAmrapOptions[exercise] = { decision, weightChange };
                
                // Update UI to show selection
                const recommendationsDiv = document.getElementById(`amrap-recommendations-${exercise}`);
                if (recommendationsDiv) {
                    const allOptions = recommendationsDiv.querySelectorAll('.amrap-option');
                    allOptions.forEach(opt => opt.classList.remove('selected'));
                    
                    const selectedOption = Array.from(allOptions).find(opt => 
                        opt.querySelector(`input[value="${decision}"]`)
                    );
                    if (selectedOption) {
                        selectedOption.classList.add('selected');
                        selectedOption.querySelector('input').checked = true;
                    }
                }
                
                // Add click handler to submit button
                const submitBtn = document.getElementById(`amrap-submit-${exercise}`);
                if (submitBtn) {
                    // Remove old event listeners by cloning
                    const newSubmitBtn = submitBtn.cloneNode(true);
                    submitBtn.parentNode.replaceChild(newSubmitBtn, submitBtn);
                    
                    newSubmitBtn.addEventListener('click', () => {
                        applyAmrapDecision(exercise);
                    });
                }
            }
            
            // Make selectAmrapOption globally available
            window.selectAmrapOption = selectAmrapOption;
            
            // Undo AMRAP decision
            function undoAmrapDecision(exercise) {
                const amrapData = amrapResults[exercise];
                
                if (!amrapData || amrapData.original1RM === undefined) {
                    alert('No AMRAP decision to undo.');
                    return;
                }
                
                // Confirm undo
                if (!confirm(`Undo AMRAP decision for ${exercise.toUpperCase()}?\n\nThis will restore the original 1RM value and clear your logged performance.`)) {
                    return;
                }
                
                // Restore original 1RM
                const inputId = `${exercise}-1rm`;
                document.getElementById(inputId).value = amrapData.original1RM;
                
                // Clear the AMRAP result
                delete amrapResults[exercise];
                
                // Save profile
                saveProfile();
                
                // Update the UI to show the input form again
                updateAmrapUI(exercise);
                
                // Update level up button status if we're on Week 4
                updateLevelUpButtonStatus();
            }
            
            // Apply AMRAP decision
            function applyAmrapDecision(exercise) {
                const repsInput = document.getElementById(`amrap-reps-${exercise}`);
                const selectedOption = selectedAmrapOptions[exercise];
                
                if (!repsInput || !selectedOption) return;
                
                const reps = parseInt(repsInput.value);
                const { decision, weightChange } = selectedOption;
                
                // Get current 1RM
                const inputId = `${exercise}-1rm`;
                let current1RM = parseFloat(document.getElementById(inputId).value) || 0;
                
                // Calculate new 1RM based on decision
                let new1RM;
                if (decision === 'decrease') {
                    // Decrease by 10%
                    new1RM = Math.round(current1RM * 0.9);
                } else {
                    // Add the weight change
                    new1RM = current1RM + weightChange;
                }
                
                // Update the 1RM input
                document.getElementById(inputId).value = new1RM;
                
                // Store the AMRAP result
                const decisionText = decision === 'earned' ? `Earned +${weightChange}lbs` :
                                    decision === 'smart' ? 'Keep same weight (Smart)' :
                                    decision === 'aggressive' ? `Add +${weightChange}lbs (Aggressive)` :
                                    'Decrease TM by 10%';
                
                amrapResults[exercise] = {
                    reps: reps,
                    decision: decisionText,
                    weightChange: new1RM - current1RM,
                    original1RM: current1RM // Store original for undo
                };
                
                // Save profile
                saveProfile();
                
                // Update the UI to show the logged status
                updateAmrapUI(exercise);
                
                // Update level up button status if we're on Week 4
                updateLevelUpButtonStatus();
            }
            
            // Update level up button status
            function updateLevelUpButtonStatus() {
                const levelUpButton = document.getElementById('level-up-button');
                if (!levelUpButton) return; // Button not visible (not on Week 4 last day)
                
                const allLogged = areAllAmrapSetsLogged();
                const missingExercises = [];
                
                // Find which exercises are missing AMRAP logs
                ['squat', 'bench', 'deadlift', 'ohp'].forEach(exercise => {
                    const has1RM = parseFloat(document.getElementById(`${exercise}-1rm`).value) > 0;
                    const hasLogged = amrapResults[exercise] && amrapResults[exercise].reps !== undefined;
                    if (has1RM && !hasLogged) {
                        missingExercises.push(exercise.toUpperCase());
                    }
                });
                
                // Find the warning message div (next sibling)
                let warningDiv = levelUpButton.nextElementSibling;
                if (warningDiv && !warningDiv.classList.contains('notes')) {
                    warningDiv = null;
                }
                
                if (allLogged) {
                    // Enable button
                    levelUpButton.disabled = false;
                    levelUpButton.style.opacity = '1';
                    levelUpButton.style.cursor = 'pointer';
                    levelUpButton.textContent = 'LEVEL UP! (Complete Cycle & Increase Weights)';
                    
                    // Remove warning message if it exists
                    if (warningDiv && warningDiv.querySelector('strong')?.textContent === '⚠️ Cannot Level Up Yet') {
                        warningDiv.remove();
                    }
                } else {
                    // Disable button
                    levelUpButton.disabled = true;
                    levelUpButton.style.opacity = '0.5';
                    levelUpButton.style.cursor = 'not-allowed';
                    levelUpButton.textContent = 'LEVEL UP! (Log Week 3 AMRAP Sets First)';
                    
                    // Add or update warning message
                    if (!warningDiv || !warningDiv.querySelector('strong')?.textContent.includes('Cannot Level Up Yet')) {
                        const newWarning = document.createElement('div');
                        newWarning.className = 'notes';
                        newWarning.style.marginTop = '1rem';
                        newWarning.style.backgroundColor = '#fff3e1';
                        newWarning.style.borderLeftColor = '#ff9800';
                        newWarning.innerHTML = `
                            <p><strong>⚠️ Cannot Level Up Yet</strong></p>
                            <p>Please log your Week 3 AMRAP performance for: <strong>${missingExercises.join(', ')}</strong></p>
                            <p>Go to Week 3, complete your 1+ sets, and log your results to unlock progression.</p>
                        `;
                        levelUpButton.parentElement.appendChild(newWarning);
                    } else if (warningDiv) {
                        // Update existing warning with current missing exercises
                        warningDiv.innerHTML = `
                            <p><strong>⚠️ Cannot Level Up Yet</strong></p>
                            <p>Please log your Week 3 AMRAP performance for: <strong>${missingExercises.join(', ')}</strong></p>
                            <p>Go to Week 3, complete your 1+ sets, and log your results to unlock progression.</p>
                        `;
                    }
                }
            }
            
            // Update AMRAP UI for a specific exercise
            function updateAmrapUI(exercise) {
                const amrapData = amrapResults[exercise] || {};
                const hasLogged = amrapData.reps !== undefined;
                
                // Find the amrap-logging container directly by class and exercise name pattern
                const allAmrapContainers = document.querySelectorAll('.amrap-logging');
                let amrapContainer = null;
                
                // Find the container that has elements with this exercise name in their IDs
                for (let container of allAmrapContainers) {
                    const inputField = container.querySelector(`#amrap-reps-${exercise}`);
                    const undoBtn = container.querySelector(`#amrap-undo-${exercise}`);
                    const submitBtn = container.querySelector(`#amrap-submit-${exercise}`);
                    
                    if (inputField || undoBtn || submitBtn) {
                        amrapContainer = container;
                        break;
                    }
                }
                
                if (!amrapContainer) return;
                
                // Build new HTML content
                let html = `
                    <h4>📊 Log Your AMRAP Performance (Wendler Philosophy)</h4>
                    <p style="margin-bottom: 1rem; font-size: 0.95rem;">
                        Your performance on this 1+ set determines your progression for the next cycle.
                    </p>`;
                
                if (hasLogged) {
                    html += `
                        <div class="amrap-status logged">
                            <strong>✓ Logged:</strong> ${amrapData.reps} reps completed | 
                            <strong>Decision:</strong> ${amrapData.decision}
                        </div>
                        <button id="amrap-undo-${exercise}" class="amrap-submit-btn" style="background-color: var(--accent);">
                            Undo Decision
                        </button>`;
                } else {
                    html += `
                        <div class="amrap-input-group">
                            <label for="amrap-reps-${exercise}">Reps completed on 1+ set:</label>
                            <input type="number" id="amrap-reps-${exercise}" min="0" max="20" placeholder="0">
                        </div>
                        
                        <div id="amrap-recommendations-${exercise}" class="amrap-recommendations" style="display: none;">
                            <!-- Options will be populated by JavaScript -->
                        </div>
                        
                        <button id="amrap-submit-${exercise}" class="amrap-submit-btn" style="display: none;">
                            Apply Progression Decision
                        </button>`;
                }
                
                // Update the container HTML
                amrapContainer.innerHTML = html;
                
                // Re-attach event listeners for this specific exercise
                const repsInput = document.getElementById(`amrap-reps-${exercise}`);
                if (repsInput) {
                    repsInput.addEventListener('input', () => {
                        const reps = parseInt(repsInput.value);
                        if (reps >= 0) {
                            showAmrapOptions(exercise, reps);
                        } else {
                            hideAmrapOptions(exercise);
                        }
                    });
                }
                
                // Setup undo button if it exists
                const undoBtn = document.getElementById(`amrap-undo-${exercise}`);
                if (undoBtn) {
                    undoBtn.addEventListener('click', () => {
                        undoAmrapDecision(exercise);
                    });
                }
            }
            
            // Function to level up (increase weights)
            function levelUp() {
                // Check if all AMRAP sets have been logged
                if (!areAllAmrapSetsLogged()) {
                    alert('Please log your Week 3 AMRAP performance for all exercises before leveling up.\n\nGo to Week 3, complete your 1+ sets, and log your results.');
                    return;
                }
                
                // Get current 1RM values (these may have been modified by AMRAP logging)
                let squat1RM = parseFloat(document.getElementById('squat-1rm').value) || 0;
                let bench1RM = parseFloat(document.getElementById('bench-1rm').value) || 0;
                let deadlift1RM = parseFloat(document.getElementById('deadlift-1rm').value) || 0;
                let ohp1RM = parseFloat(document.getElementById('ohp-1rm').value) || 0;
                
                // Check if any AMRAP results were logged - if not, use standard progression
                const hasAmrapResults = Object.keys(amrapResults).some(key => amrapResults[key].reps !== undefined);
                
                if (!hasAmrapResults) {
                    // Standard progression: Increase upper body lifts by 5lbs, lower body by 10lbs
                    if (bench1RM > 0) bench1RM += 5;
                    if (ohp1RM > 0) ohp1RM += 5;
                    if (squat1RM > 0) squat1RM += 10;
                    if (deadlift1RM > 0) deadlift1RM += 10;
                    
                    // Update input fields
                    document.getElementById('squat-1rm').value = squat1RM;
                    document.getElementById('bench-1rm').value = bench1RM;
                    document.getElementById('deadlift-1rm').value = deadlift1RM;
                    document.getElementById('ohp-1rm').value = ohp1RM;
                }
                // If AMRAP results exist, the 1RM values have already been updated
                
                // Increase user level
                userLevel++;
                updateLevelDisplay();
                
                // Clear AMRAP results for the new cycle
                amrapResults = {};
                
                // Generate new workout plan
                generateWorkoutPlan();
                
                // Reset to week 1
                currentWeek = 1;
                currentDay = 0;
                
                // Update week tabs UI
                weekTabs.forEach(tab => {
                    tab.classList.toggle('active', tab.dataset.week === '1');
                });
                
                // Save profile
                saveProfile();
                
                // Show success message
                alert(`Congratulations! You've leveled up to Level ${userLevel}! Your lift weights have been ${hasAmrapResults ? 'updated based on your AMRAP performance' : 'increased'} and a new cycle has been generated.`);
            }
        });
    </script>
</body>
</html>