<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Today's Workout</title>
    <link rel="stylesheet" href="../dark-theme.css">
    <script src="workout-utils.js"></script>
    <style>
        .nav-bar {
            display: flex;
            justify-content: space-around;
            padding: 10px;
            background-color: #333;
            margin-bottom: 20px;
        }
        .nav-bar a {
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 4px;
        }
        .nav-bar a:hover {
            background-color: #555;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        #scrollableWindow {
            max-height: 70vh;
            overflow-y: auto;
            margin-bottom: 20px;
            padding: 10px;
            background-color: #222;
            border-radius: 4px;
        }
        .list-item {
            padding: 15px;
            margin: 5px 0;
            background-color: #333;
            border-radius: 4px;
        }
        .list-item input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.5);
        }
        .small-text {
            font-size: 0.8em;
            color: #aaa;
            margin-left: 25px;
        }
        #setScheduleBtn {
            padding: 10px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        #setScheduleBtn:hover {
            background-color: #45a049;
        }
        #currentDay {
            color: #4CAF50;
        }
        #routineName {
            color: #4CAF50;
        }
        .edit-button {
            margin-left: 10px;
            background: none;
            border: none;
            font-size: 1.2em;
            cursor: pointer;
            vertical-align: middle;
        }
        .edit-button:hover {
            transform: scale(1.2);
        }
        .header-container {
            display: flex;
            align-items: center;
        }
        .cycle-info {
            background-color: #2c2c2c;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #4CAF50;
        }
        .cycle-info h3 {
            color: #4CAF50;
            margin-top: 0;
            margin-bottom: 10px;
        }
        .cycle-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }
        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            background-color: #333;
            border-radius: 4px;
        }
        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #4CAF50;
        }
        .stat-label {
            font-size: 0.9em;
            color: #aaa;
            margin-top: 5px;
        }
        .complete-workout-btn {
            background-color: #2196F3;
            margin-top: 10px;
            width: 100%;
        }
        .complete-workout-btn:hover {
            background-color: #1976D2;
        }
        .progress-btn {
            background-color: #FFD700;
            color: #000;
            font-weight: bold;
            margin-top: 10px;
            width: 100%;
        }
        .progress-btn:hover {
            background-color: #FFC107;
        }
        .exercise-details-expanded {
            font-size: 0.85em;
            color: #999;
            margin-top: 5px;
            padding: 5px 25px;
            background-color: #222;
            border-radius: 4px;
        }
        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75em;
            margin-left: 5px;
        }
        .badge-progression {
            background-color: #4CAF50;
            color: white;
        }
        .badge-amrap {
            background-color: #ff9800;
            color: white;
        }
    </style>
</head>
<body>
    <div class="nav-bar">
        <a href="../index.html">Home</a>
        <a href="workout.html">Today's Workout</a>
        <a href="workout_routine.html">Workout Routines</a>
        <a href="set_workout_day.html">Schedule</a>
    </div>
    
    <div class="container">
        <div class="header-container">
            <h1>Workout for <span id="currentDay"></span>: <span id="routineName"></span></h1>
            <button id="editRoutineBtn" class="edit-button" title="Edit this workout">‚úèÔ∏è</button>
        </div>
        
        <!-- Cycle Info (only shown for cycle-based schedules) -->
        <div id="cycleInfo" class="cycle-info" style="display: none;">
            <h3>üìä Cycle Progress</h3>
            <div class="cycle-stats">
                <div class="stat-item">
                    <div class="stat-value" id="cycleNumber">1</div>
                    <div class="stat-label">Cycle #</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="currentCycleDay">1</div>
                    <div class="stat-label">Current Day</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalCycleDays">4</div>
                    <div class="stat-label">Days in Cycle</div>
                </div>
            </div>
        </div>
        
        <div id="scrollableWindow"></div>
        
        <button id="completeWorkoutBtn" class="btn complete-workout-btn">‚úì Complete Workout</button>
        <button id="progressCycleBtn" class="btn progress-btn" style="display: none;">üöÄ Complete Cycle & Progress Weights</button>
        <button id="setScheduleBtn">Set Workout Schedule</button>
    </div>

    <script>
document.addEventListener('DOMContentLoaded', function() {
    const scrollableWindow = document.getElementById('scrollableWindow');
    const setScheduleBtn = document.getElementById('setScheduleBtn');
    const editRoutineBtn = document.getElementById('editRoutineBtn');
    const completeWorkoutBtn = document.getElementById('completeWorkoutBtn');
    const progressCycleBtn = document.getElementById('progressCycleBtn');
    const currentDayElement = document.getElementById('currentDay');
    const routineNameElement = document.getElementById('routineName');
    let currentRoutineName = '';
    let currentDay = null;

    function getToday() {
        const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        return days[new Date().getDay()];
    }

    function displayCurrentDay() {
        const settings = WorkoutUtils.getSettings();
        const schedule = WorkoutUtils.getSchedule();
        
        if (schedule.type === 'weekly') {
            const today = getToday();
            currentDayElement.textContent = today;
            currentDay = today;
        } else {
            // Cycle-based
            const cycleDay = WorkoutUtils.getCurrentCycleDay();
            const dayName = WorkoutUtils.getCycleDayName(cycleDay);
            currentDayElement.textContent = dayName;
            currentDay = cycleDay;
            
            // Show cycle info
            document.getElementById('cycleInfo').style.display = 'block';
            document.getElementById('cycleNumber').textContent = settings.currentCycle || 1;
            document.getElementById('currentCycleDay').textContent = cycleDay;
            document.getElementById('totalCycleDays').textContent = settings.cycleLength || 4;
            
            // Show progress button if on last day of cycle
            if (cycleDay === settings.cycleLength) {
                progressCycleBtn.style.display = 'block';
            }
        }
    }

    function displayWorkoutSchedule() {
        displayCurrentDay();
        
        const settings = WorkoutUtils.getSettings();
        const schedule = WorkoutUtils.getSchedule();
        const routines = WorkoutUtils.getRoutines();
        
        // Get today's routine
        let routineName = null;
        if (schedule.type === 'weekly') {
            const today = getToday();
            routineName = schedule.weekly?.[today];
        } else {
            const cycleDay = WorkoutUtils.getCurrentCycleDay();
            routineName = schedule.cycleDays?.[cycleDay];
        }

        // Check for new day and clear checkboxes if necessary
        const storedDay = localStorage.getItem('storedDay');
        const todayKey = schedule.type === 'weekly' ? getToday() : WorkoutUtils.getCurrentCycleDay().toString();
        if (storedDay !== todayKey) {
            localStorage.removeItem('checkboxStates');
            localStorage.setItem('storedDay', todayKey);
        }

        scrollableWindow.innerHTML = '';

        if (routineName && routines[routineName]) {
            currentRoutineName = routineName;
            routineNameElement.textContent = routineName;
            
            const routine = routines[routineName];
            const exercises = routine.exercises || [];

            // Load checkbox states from local storage
            const checkboxStates = JSON.parse(localStorage.getItem('checkboxStates')) || {};

            if (exercises.length === 0) {
                scrollableWindow.innerHTML = '<p>No exercises in this routine. <a href="edit_workout_routine.html?selectedRoutine=' + encodeURIComponent(routineName) + '">Add exercises</a></p>';
                return;
            }

            exercises.forEach(function(exercise, index) {
                var listItem = document.createElement('div');
                listItem.className = 'list-item';

                var checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `exercise-${index}`;
                checkbox.name = `exercise-${index}`;

                // Set checkbox state from local storage
                checkbox.checked = checkboxStates[`exercise-${index}`] || false;

                checkbox.addEventListener('change', function() {
                    checkboxStates[`exercise-${index}`] = checkbox.checked;
                    localStorage.setItem('checkboxStates', JSON.stringify(checkboxStates));
                });

                // Build display text
                let displayName = exercise.name;
                
                // Add badges
                if (exercise.amrap) {
                    displayName += ' <span class="badge badge-amrap">AMRAP</span>';
                }
                if (exercise.progression?.enabled) {
                    displayName += ' <span class="badge badge-progression">+' + exercise.progression.increment + exercise.weightUnit + '</span>';
                }

                // Build details
                const sets = exercise.sets || 3;
                const reps = exercise.reps || '-';
                const weight = exercise.weight ? `${exercise.weight}${exercise.weightUnit || 'lbs'}` : '-';
                const time = exercise.time ? `${exercise.time} ${exercise.timeUnit || 'sec'}` : '';
                
                let detailsText = `${sets} sets √ó ${reps} reps`;
                if (exercise.weight) detailsText += ` @ ${weight}`;
                if (exercise.time) detailsText += ` (${time})`;
                
                // Add extra info if available
                let extraInfo = [];
                if (exercise.oneRepMax) extraInfo.push(`1RM: ${exercise.oneRepMax}${exercise.weightUnit}`);
                if (exercise.restTime) extraInfo.push(`Rest: ${exercise.restTime}s`);
                if (exercise.rpe) extraInfo.push(`RPE: ${exercise.rpe}`);
                
                listItem.innerHTML = `
                    <label for="exercise-${index}">${displayName}</label>
                    <br><span class="small-text">${detailsText}</span>
                    ${extraInfo.length > 0 ? `<div class="exercise-details-expanded">${extraInfo.join(' ‚Ä¢ ')}</div>` : ''}
                    ${exercise.notes ? `<div class="exercise-details-expanded">üìù ${exercise.notes}</div>` : ''}
                `;

                listItem.prepend(checkbox);
                scrollableWindow.appendChild(listItem);
            });
        } else {
            scrollableWindow.innerHTML = '<p>No workout scheduled for today. <a href="set_workout_day.html">Set up your schedule</a></p>';
            routineNameElement.textContent = 'Rest Day';
        }
    }

    setScheduleBtn.addEventListener('click', function() {
        window.location.href = 'set_workout_day.html';
    });

    editRoutineBtn.addEventListener('click', function() {
        const schedule = WorkoutUtils.getSchedule();
        let routineName = null;
        
        if (schedule.type === 'weekly') {
            const today = getToday();
            routineName = schedule.weekly?.[today];
        } else {
            const cycleDay = WorkoutUtils.getCurrentCycleDay();
            routineName = schedule.cycleDays?.[cycleDay];
        }
        
        if (routineName) {
            window.location.href = `edit_workout_routine.html?selectedRoutine=${encodeURIComponent(routineName)}`;
        } else {
            alert('No workout routine scheduled for today.');
        }
    });

    completeWorkoutBtn.addEventListener('click', function() {
        const checkboxes = document.querySelectorAll('#scrollableWindow input[type="checkbox"]');
        const totalExercises = checkboxes.length;
        const completedExercises = Array.from(checkboxes).filter(cb => cb.checked).length;
        
        if (totalExercises === 0) {
            alert('No exercises to complete!');
            return;
        }
        
        if (completedExercises < totalExercises) {
            if (!confirm(`You've completed ${completedExercises} out of ${totalExercises} exercises. Mark workout as complete anyway?`)) {
                return;
            }
        }
        
        const schedule = WorkoutUtils.getSchedule();
        if (schedule.type === 'cycle') {
            const cycleDay = WorkoutUtils.getCurrentCycleDay();
            WorkoutUtils.completeWorkoutDay(cycleDay);
            alert('Workout completed! üí™');
            
            // Check if cycle is complete
            const settings = WorkoutUtils.getSettings();
            if (cycleDay === settings.cycleLength) {
                if (confirm('üéâ Cycle complete! Would you like to progress to the next cycle and increase weights?')) {
                    progressToNextCycle();
                }
            } else {
                // Refresh to show next day
                location.reload();
            }
        } else {
            alert('Workout completed! üí™');
            // Clear checkboxes for next time
            localStorage.removeItem('checkboxStates');
            location.reload();
        }
    });

    progressCycleBtn.addEventListener('click', function() {
        if (confirm('Complete this cycle and progress all exercises with progression enabled?')) {
            progressToNextCycle();
        }
    });

    function progressToNextCycle() {
        WorkoutUtils.progressToNextCycle();
        alert('üöÄ Progressed to next cycle! Weights have been increased for exercises with progression enabled.');
        location.reload();
    }

    displayWorkoutSchedule();
});
    </script>
</body>
</html>
